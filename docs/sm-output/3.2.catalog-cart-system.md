# Story 3.2: Implementar Sistema de Carrinho

## Status
**Draft**

## Story

**As a** usuário do catálogo autenticado,
**I want** adicionar produtos ao carrinho e gerenciar quantidades,
**so that** possa preparar meu pedido antes de enviar ao gestor.

## Acceptance Criteria

1-6. Serviço catalog-cart.ts: addToCart(), removeFromCart(), updateCartQuantity(), getUserCart(), clearCart()
7. Hooks React Query completos
8-10. Página /catalogo/carrinho com lista de itens, stepper de quantidade, footer com total
11. Validação de quantidade máxima (stock_quantity)
12. Aviso "Estoque limitado a X unidades"
13. Animação ao remover item
14. Empty state: "Seu carrinho está vazio"
15. Badge contador no header
16. FAB (Floating Action Button) com contador
17. Swipe gesture para remover
18. Carrinho persiste na sessão
19. RLS isolamento testado

## Tasks / Subtasks

- [ ] **Task 1: Serviço catalog-cart.ts** (AC: 1-6)
  - [ ] CRUD completo com validação de estoque
  - [ ] clearCart() para finalização

- [ ] **Task 2: Hooks React Query** (AC: 7)
  - [ ] useCart(), useAddToCart(), useRemoveFromCart()
  - [ ] useUpdateCartQuantity() com debounce
  - [ ] useClearCart()

- [ ] **Task 3: Página /catalogo/carrinho** (AC: 8-14, 17)
  - [ ] Lista de itens com imagem, nome, preço, quantidade
  - [ ] Input stepper (NumberInput do shadcn/ui)
  - [ ] Validação de estoque
  - [ ] Footer fixo com total
  - [ ] Swipe gesture

- [ ] **Task 4: FAB e badges** (AC: 15-16)
  - [ ] Badge no header
  - [ ] FAB fixo no catálogo (posição: bottom-right, z-50)

- [ ] **Task 5: Testes** (AC: 18-19)
  - [ ] E2E: persistência
  - [ ] Integration: RLS

## Dev Notes

**[Source: docs/architecture/database-schema-migrations.md]**

### Tabela catalog_cart:
```sql
CREATE TABLE catalog_cart (
  id UUID PRIMARY KEY,
  user_whatsapp VARCHAR(20) NOT NULL REFERENCES catalog_users(whatsapp),
  product_id UUID NOT NULL REFERENCES products(id),
  quantity INTEGER NOT NULL DEFAULT 1 CHECK (quantity > 0),
  created_at TIMESTAMP,
  updated_at TIMESTAMP,
  CONSTRAINT unique_user_cart_item UNIQUE(user_whatsapp, product_id)
);
```

### Stock Validation:
```typescript
async function updateCartQuantity(productId: string, quantity: number) {
  // Get product stock
  const { data: product } = await supabase
    .from('products')
    .select('quantity')
    .eq('id', productId)
    .single()
  
  if (quantity > product.quantity) {
    throw new Error(`Estoque limitado a ${product.quantity} unidades`)
  }
  
  // Update cart
  await supabase
    .from('catalog_cart')
    .update({ quantity })
    .eq('product_id', productId)
}
```

**Dependencies**: Epic 1, Story 3.1

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-09 | v1.0 | Created | Bob (SM) |

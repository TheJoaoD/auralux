# Story 3.1: Implementar Sistema de Favoritos

## Status
**Draft**

## Story

**As a** usuário do catálogo autenticado,
**I want** salvar produtos como favoritos e visualizá-los em página dedicada,
**so that** possa acessar rapidamente produtos que me interessam.

## Acceptance Criteria

1-5. Serviço catalog-favorites.ts com CRUD completo
6. Hooks React Query: useFavorites(), useAddFavorite(), useRemoveFavorite(), useIsFavorite()
7. Página /catalogo/favoritos exibindo grid de favoritos
8. Empty state: "Você ainda não tem favoritos"
9. Botão remover em cada ProductCard
10. Animação suave ao remover
11. Toast: "Produto removido dos favoritos"
12. Optimistic update no ícone de favorito
13. Contador de favoritos no header (badge)
14. Swipe gesture para remover (mobile)
15. Favorito persiste após logout/login
16. RLS testa isolamento entre usuários

## Tasks / Subtasks

- [ ] **Task 1: Criar serviço catalog-favorites.ts** (AC: 1-5)
  - [ ] addFavorite(), removeFavorite(), getUserFavorites(), isFavorite()
  - [ ] Queries Supabase com RLS enforcement

- [ ] **Task 2: Criar hooks React Query** (AC: 6, 12)
  - [ ] useFavorites() com cache 60s
  - [ ] useAddFavorite() com optimistic update
  - [ ] useRemoveFavorite() com optimistic update
  - [ ] useIsFavorite(productId) para ícone dinâmico

- [ ] **Task 3: Implementar página /catalogo/favoritos** (AC: 7-11, 14)
  - [ ] Grid responsivo com ProductCard
  - [ ] Empty state
  - [ ] Animação de remoção (framer-motion)
  - [ ] Swipe gesture (react-swipeable)

- [ ] **Task 4: Contador de favoritos no header** (AC: 13)
  - [ ] Badge no ícone de coração
  - [ ] Atualiza em tempo real

- [ ] **Task 5: Testes** (AC: 15-16)
  - [ ] E2E: persistência após logout
  - [ ] Integration: RLS isolamento

## Dev Notes

**[Source: docs/architecture/database-schema-migrations.md]**

### Tabela catalog_favorites:
```sql
CREATE TABLE catalog_favorites (
  id UUID PRIMARY KEY,
  user_whatsapp VARCHAR(20) NOT NULL REFERENCES catalog_users(whatsapp) ON DELETE CASCADE,
  product_id UUID NOT NULL REFERENCES products(id) ON DELETE CASCADE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  CONSTRAINT unique_user_favorite UNIQUE(user_whatsapp, product_id)
);
```

### Optimistic Update Pattern:
```typescript
const { mutate: addFavorite } = useMutation({
  mutationFn: (productId) => addFavoriteService(productId),
  onMutate: async (productId) => {
    // Cancel outgoing queries
    await queryClient.cancelQueries(['favorites'])
    
    // Snapshot previous value
    const previous = queryClient.getQueryData(['favorites'])
    
    // Optimistically update
    queryClient.setQueryData(['favorites'], old => [...old, { product_id: productId }])
    
    return { previous }
  },
  onError: (err, variables, context) => {
    // Rollback on error
    queryClient.setQueryData(['favorites'], context.previous)
  },
  onSettled: () => {
    queryClient.invalidateQueries(['favorites'])
  }
})
```

**Dependencies**: Epic 1 (Auth, Database, RLS)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-09 | v1.0 | Created | Bob (SM) |

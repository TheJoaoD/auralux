# Story 1.1: Criar Schema de Banco de Dados do Catálogo

## Status
**Ready for Review**

## Story

**As a** desenvolvedor,
**I want** criar as tabelas necessárias para o catálogo público no Supabase,
**so that** possamos armazenar usuários do catálogo, produtos habilitados, favoritos, carrinhos e solicitações de forma estruturada e segura.

## Acceptance Criteria

1. Migração SQL cria tabela `catalog_users` com campos: `id` (UUID PK), `whatsapp` (VARCHAR unique), `name` (VARCHAR), `created_at`, `updated_at`
2. Migração SQL cria tabela `catalog_items` com campos: `id` (UUID PK), `product_id` (FK para `products`), `visible` (BOOLEAN default true), `featured` (BOOLEAN default false), `featured_order` (INTEGER), `fragrance_notes_top` (TEXT), `fragrance_notes_heart` (TEXT), `fragrance_notes_base` (TEXT), `occasion` (TEXT), `intensity` (VARCHAR), `longevity` (VARCHAR), `stock_return_date` (DATE nullable), `created_at`, `updated_at`
3. Migração SQL cria tabela `catalog_favorites` com campos: `id` (UUID PK), `user_whatsapp` (VARCHAR FK para `catalog_users.whatsapp`), `product_id` (FK para `products`), `created_at` - com unique constraint (user_whatsapp, product_id)
4. Migração SQL cria tabela `catalog_cart` com campos: `id` (UUID PK), `user_whatsapp` (VARCHAR FK para `catalog_users.whatsapp`), `product_id` (FK para `products`), `quantity` (INTEGER default 1), `created_at`, `updated_at` - com unique constraint (user_whatsapp, product_id)
5. Migração SQL cria tabela `catalog_requests` com campos: `id` (UUID PK), `user_whatsapp` (VARCHAR FK para `catalog_users.whatsapp`), `product_name` (TEXT), `observations` (TEXT), `status` (ENUM: 'pending', 'analyzing', 'fulfilled', 'unavailable'), `admin_notes` (TEXT), `created_at`, `updated_at`
6. Migração SQL cria tabela `catalog_orders` com campos: `id` (UUID PK), `user_whatsapp` (VARCHAR FK para `catalog_users.whatsapp`), `items` (JSONB - array de {product_id, name, price, quantity}), `total` (DECIMAL), `status` (ENUM: 'sent', 'contacted', 'converted', 'cancelled'), `created_at`
7. Migração cria índices: `catalog_items.visible`, `catalog_items.featured`, `catalog_favorites.user_whatsapp`, `catalog_cart.user_whatsapp`, `catalog_requests.status`, `catalog_requests.user_whatsapp`
8. Migração cria trigger `update_catalog_items_updated_at` para atualizar `updated_at` automaticamente
9. Migração cria trigger `update_catalog_requests_updated_at` para atualizar `updated_at` automaticamente
10. Arquivo de migração é executado com sucesso no Supabase local e produção

## Tasks / Subtasks

- [x] **Task 1: Criar arquivo de migração base** (AC: 10)
  - [x] Criar arquivo `supabase/migrations/YYYYMMDDHHMMSS_create_catalog_schema.sql`
  - [x] Adicionar header com descrição da migração
  - [x] Envolver migration em bloco `BEGIN; ... COMMIT;` para atomicidade

- [x] **Task 2: Criar ENUMs necessários** (AC: 5, 6)
  - [x] Criar ENUM `catalog_request_status`:
    ```sql
    CREATE TYPE catalog_request_status AS ENUM (
      'pending',
      'analyzing',
      'fulfilled',
      'unavailable'
    );
    ```
  - [x] Criar ENUM `catalog_order_status`:
    ```sql
    CREATE TYPE catalog_order_status AS ENUM (
      'sent',
      'contacted',
      'converted',
      'cancelled'
    );
    ```

- [x] **Task 3: Criar tabela catalog_users** (AC: 1)
  - [x] Criar tabela conforme schema:
    ```sql
    CREATE TABLE catalog_users (
      id UUID PRIMARY KEY DEFAULT extensions.uuid_generate_v4(),
      whatsapp VARCHAR(20) UNIQUE NOT NULL,
      name VARCHAR(255) NOT NULL,
      created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
    );
    ```
  - [x] Criar índice único: `CREATE UNIQUE INDEX idx_catalog_users_whatsapp ON catalog_users(whatsapp);`
  - [x] Criar índice de data: `CREATE INDEX idx_catalog_users_created_at ON catalog_users(created_at DESC);`
  - [x] Criar trigger para `updated_at`:
    ```sql
    CREATE TRIGGER update_catalog_users_updated_at
      BEFORE UPDATE ON catalog_users
      FOR EACH ROW
      EXECUTE FUNCTION update_updated_at_column();
    ```

- [x] **Task 4: Criar tabela catalog_items** (AC: 2, 7, 8)
  - [x] Criar tabela conforme schema completo da arquitetura:
    ```sql
    CREATE TABLE catalog_items (
      id UUID PRIMARY KEY DEFAULT extensions.uuid_generate_v4(),
      product_id UUID NOT NULL REFERENCES products(id) ON DELETE CASCADE,
      visible BOOLEAN DEFAULT true,
      featured BOOLEAN DEFAULT false,
      featured_order INTEGER,

      fragrance_notes_top TEXT,
      fragrance_notes_heart TEXT,
      fragrance_notes_base TEXT,
      occasion TEXT[],
      intensity VARCHAR(50),
      longevity VARCHAR(50),
      stock_return_date DATE,

      created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

      CONSTRAINT unique_product_catalog UNIQUE(product_id)
    );
    ```
  - [x] Criar índices de performance:
    ```sql
    CREATE INDEX idx_catalog_items_visible ON catalog_items(visible) WHERE visible = true;
    CREATE INDEX idx_catalog_items_featured ON catalog_items(featured, featured_order) WHERE featured = true;
    CREATE INDEX idx_catalog_items_product_id ON catalog_items(product_id);
    ```
  - [x] Criar trigger para `updated_at`

- [x] **Task 5: Criar tabela catalog_favorites** (AC: 3, 7)
  - [x] Criar tabela:
    ```sql
    CREATE TABLE catalog_favorites (
      id UUID PRIMARY KEY DEFAULT extensions.uuid_generate_v4(),
      user_whatsapp VARCHAR(20) NOT NULL REFERENCES catalog_users(whatsapp) ON DELETE CASCADE,
      product_id UUID NOT NULL REFERENCES products(id) ON DELETE CASCADE,
      created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

      CONSTRAINT unique_user_favorite UNIQUE(user_whatsapp, product_id)
    );
    ```
  - [x] Criar índices:
    ```sql
    CREATE INDEX idx_catalog_favorites_user ON catalog_favorites(user_whatsapp);
    CREATE INDEX idx_catalog_favorites_product ON catalog_favorites(product_id);
    CREATE INDEX idx_catalog_favorites_created ON catalog_favorites(created_at DESC);
    ```

- [x] **Task 6: Criar tabela catalog_cart** (AC: 4, 7)
  - [x] Criar tabela:
    ```sql
    CREATE TABLE catalog_cart (
      id UUID PRIMARY KEY DEFAULT extensions.uuid_generate_v4(),
      user_whatsapp VARCHAR(20) NOT NULL REFERENCES catalog_users(whatsapp) ON DELETE CASCADE,
      product_id UUID NOT NULL REFERENCES products(id) ON DELETE CASCADE,
      quantity INTEGER NOT NULL DEFAULT 1 CHECK (quantity > 0),
      created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

      CONSTRAINT unique_user_cart_item UNIQUE(user_whatsapp, product_id)
    );
    ```
  - [x] Criar índices:
    ```sql
    CREATE INDEX idx_catalog_cart_user ON catalog_cart(user_whatsapp);
    CREATE INDEX idx_catalog_cart_product ON catalog_cart(product_id);
    ```
  - [x] Criar trigger para `updated_at`

- [x] **Task 7: Criar tabela catalog_requests** (AC: 5, 7, 9)
  - [x] Criar tabela:
    ```sql
    CREATE TABLE catalog_requests (
      id UUID PRIMARY KEY DEFAULT extensions.uuid_generate_v4(),
      user_whatsapp VARCHAR(20) NOT NULL REFERENCES catalog_users(whatsapp) ON DELETE CASCADE,
      product_name TEXT NOT NULL,
      observations TEXT,
      status catalog_request_status DEFAULT 'pending',
      admin_notes TEXT,
      created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
      updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
    );
    ```
  - [x] Criar índices:
    ```sql
    CREATE INDEX idx_catalog_requests_user ON catalog_requests(user_whatsapp);
    CREATE INDEX idx_catalog_requests_status ON catalog_requests(status);
    CREATE INDEX idx_catalog_requests_created ON catalog_requests(created_at DESC);
    ```
  - [x] Criar trigger para `updated_at`

- [x] **Task 8: Criar tabela catalog_orders** (AC: 6, 7)
  - [x] Criar tabela:
    ```sql
    CREATE TABLE catalog_orders (
      id UUID PRIMARY KEY DEFAULT extensions.uuid_generate_v4(),
      user_whatsapp VARCHAR(20) NOT NULL REFERENCES catalog_users(whatsapp) ON DELETE CASCADE,
      items JSONB NOT NULL,
      total NUMERIC(10,2) NOT NULL CHECK (total >= 0),
      status catalog_order_status DEFAULT 'sent',
      created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
    );
    ```
  - [x] Criar índices:
    ```sql
    CREATE INDEX idx_catalog_orders_user ON catalog_orders(user_whatsapp);
    CREATE INDEX idx_catalog_orders_status ON catalog_orders(status);
    CREATE INDEX idx_catalog_orders_created ON catalog_orders(created_at DESC);
    CREATE INDEX idx_catalog_orders_items_gin ON catalog_orders USING GIN(items);
    ```

- [x] **Task 9: Criar tabela catalog_product_views (Analytics)** (AC: 7)
  - [x] Criar tabela para tracking de visualizações:
    ```sql
    CREATE TABLE catalog_product_views (
      id UUID PRIMARY KEY DEFAULT extensions.uuid_generate_v4(),
      product_id UUID NOT NULL REFERENCES products(id) ON DELETE CASCADE,
      user_whatsapp VARCHAR(20),
      session_id UUID NOT NULL,
      viewed_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
    );
    ```
  - [x] Criar índices:
    ```sql
    CREATE INDEX idx_catalog_views_product ON catalog_product_views(product_id, viewed_at DESC);
    CREATE INDEX idx_catalog_views_session ON catalog_product_views(session_id, product_id);
    ```

- [x] **Task 10: Criar função update_updated_at_column se não existir** (AC: 8, 9)
  - [x] Criar função:
    ```sql
    CREATE OR REPLACE FUNCTION update_updated_at_column()
    RETURNS TRIGGER AS $$
    BEGIN
      NEW.updated_at = NOW();
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;
    ```

- [x] **Task 11: Executar migração e validar** (AC: 10)
  - [x] Executar localmente: `supabase migration up`
  - [x] Verificar que todas as tabelas foram criadas: `\dt catalog_*`
  - [x] Verificar índices: `\di catalog_*`
  - [x] Verificar constraints: `\d+ catalog_users`, `\d+ catalog_items`, etc.
  - [x] Executar em produção (staging primeiro se disponível)
  - [x] Documentar migration ID no commit message

## Dev Notes

### Architecture Context

**[Source: docs/architecture/executive-summary.md]**
- **Database Strategy**: Shared PostgreSQL com RLS isolation
- **Architecture Constraint**: Zero breaking changes ao sistema admin existente
- Tabelas `catalog_*` são isoladas - não afetam tabelas admin

**[Source: docs/architecture/database-schema-migrations.md]**

Este story implementa **TODO** o schema de database documentado na arquitetura. Ver schema completo na arquitetura para referência.

#### Relacionamentos Críticos:

**catalog_users** (independente):
- Primary Key: WhatsApp (usado como FK em outras tabelas)
- Razão: Simplifica autenticação sem ID separado

**catalog_items** (estende products):
- FK: `product_id` → `products.id` (tabela admin existente)
- Constraint: UNIQUE(product_id) - um produto só pode ter um registro em catalog_items
- ON DELETE CASCADE: se produto admin for deletado, registro catalog também é removido

**catalog_favorites, catalog_cart** (user-specific):
- FK: `user_whatsapp` → `catalog_users.whatsapp`
- FK: `product_id` → `products.id`
- Constraint: UNIQUE(user_whatsapp, product_id) - evita duplicatas

**catalog_requests** (solicitações):
- Armazena texto livre (`product_name`) - não FK para products
- Razão: usuário pode solicitar produto que não existe no estoque

**catalog_orders** (pedidos finalizados):
- Campo `items` é JSONB - snapshot do carrinho no momento da finalização
- Razão: preserva histórico mesmo se produto for alterado/deletado

### Migration Strategy

**[Source: docs/architecture/database-schema-migrations.md#migration-strategy]**

```sql
-- Ordem de criação (respeitando dependências):
-- 1. ENUMs (não têm dependências)
-- 2. catalog_users (sem FK)
-- 3. catalog_items (FK: products)
-- 4. catalog_favorites (FK: catalog_users, products)
-- 5. catalog_cart (FK: catalog_users, products)
-- 6. catalog_requests (FK: catalog_users)
-- 7. catalog_orders (FK: catalog_users)
-- 8. catalog_product_views (FK: products)
```

### Existing Infrastructure

**Tabela products (já existe no admin):**
```sql
CREATE TABLE products (
  id UUID PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  sku VARCHAR(100),
  image_url TEXT,
  cost_price DECIMAL(10,2),
  sale_price DECIMAL(10,2),
  quantity INTEGER NOT NULL DEFAULT 0,
  category_id UUID REFERENCES categories(id),
  created_at TIMESTAMP,
  updated_at TIMESTAMP
);
```

**Tabela categories (já existe no admin):**
```sql
CREATE TABLE categories (
  id UUID PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  color VARCHAR(50),
  created_at TIMESTAMP,
  updated_at TIMESTAMP
);
```

Estas tabelas são **compartilhadas** entre admin e catálogo - não devem ser modificadas neste story.

### Technical Constraints

1. **Atomic Migration**: SEMPRE envolver em `BEGIN; ... COMMIT;`
2. **FK Constraints**: Respeitar ordem de criação para evitar erros
3. **Índices de Performance**: Criar índices antes de popular dados
4. **ON DELETE CASCADE**: Usar para manter integridade referencial automaticamente
5. **UNIQUE Constraints**: Prevenir duplicatas críticas (user+product)
6. **CHECK Constraints**: Validar dados no database level (ex: quantity > 0)

### Testing

**Validation Queries após migração:**

```sql
-- Verificar tabelas criadas
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public'
  AND table_name LIKE 'catalog_%'
ORDER BY table_name;

-- Verificar índices
SELECT indexname, tablename
FROM pg_indexes
WHERE tablename LIKE 'catalog_%'
ORDER BY tablename, indexname;

-- Verificar constraints
SELECT con.conname, con.contype, pg_get_constraintdef(con.oid)
FROM pg_constraint con
JOIN pg_class rel ON rel.oid = con.conrelid
WHERE rel.relname LIKE 'catalog_%'
ORDER BY rel.relname, con.conname;

-- Testar insert básico
INSERT INTO catalog_users (whatsapp, name)
VALUES ('+5511999999999', 'Test User')
RETURNING *;

-- Verificar trigger updated_at funciona
UPDATE catalog_users SET name = 'Updated' WHERE whatsapp = '+5511999999999';
SELECT updated_at > created_at as trigger_works FROM catalog_users WHERE whatsapp = '+5511999999999';
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-09 | v1.0 | Story created for Epic 1 - Catalog Foundation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

**Model:** Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)
**Agent:** James (Dev Agent)
**Date:** 2025-11-09

### Debug Log References

No debug logs required - migration executed successfully on first attempt.

### Completion Notes List

**Implementation Summary:**
1. ✅ Created migration file: `supabase/migrations/20251109000000_create_catalog_schema.sql`
2. ✅ All 7 catalog tables created successfully (catalog_users, catalog_items, catalog_favorites, catalog_cart, catalog_requests, catalog_orders, catalog_product_views)
3. ✅ All 2 ENUMs created (catalog_request_status, catalog_order_status)
4. ✅ All 30 indexes created for optimal query performance
5. ✅ All triggers for updated_at columns working correctly
6. ✅ Migration executed via Supabase MCP successfully

**Validation Results:**
- Tables created: 7/7 ✅
- Indexes created: 30/30 ✅
- Triggers tested and working ✅
- Constraints verified ✅
- Test user CRUD operations successful ✅

**Challenges:**
None - migration was straightforward and executed atomically.

**Notes:**
- Used BEGIN/COMMIT block for atomic execution
- Followed dependency order (ENUMs → catalog_users → other tables)
- All foreign keys properly set with ON DELETE CASCADE
- UNIQUE constraints prevent duplicate entries
- CHECK constraints enforce business rules at DB level

### File List

**Files Created:**
- `supabase/migrations/20251109000000_create_catalog_schema.sql` - Complete catalog schema migration

**Files Modified:**
- `docs/sm-output/1.1.catalog-database-schema.md` - Updated story status to "Ready for Review" and marked all tasks complete

## QA Results

*To be filled by QA Agent after implementation review*

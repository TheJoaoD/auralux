# Story 3.3: Implementar Finalização de Pedido via WhatsApp

## Status
**Draft**

## Story

**As a** usuário do catálogo autenticado,
**I want** finalizar pedido gerando mensagem pré-formatada para enviar ao gestor via WhatsApp,
**so that** possa concluir minha compra de forma simples e familiar.

## Acceptance Criteria

1-3. Função generateWhatsAppMessage() cria mensagem formatada com lista de produtos e total
4. Função createOrder() insere em catalog_orders com status 'sent'
5. Link WhatsApp: https://wa.me/{GESTOR}?text={mensagem}
6. Número do gestor em env: NEXT_PUBLIC_WHATSAPP_BUSINESS
7-8. Modal de confirmação com preview da mensagem
9. Abre WhatsApp em nova aba/app
10. Carrinho limpo automaticamente após enviar
11. Notificação real-time ao gestor (Supabase Realtime)
12. Página de sucesso: "Pedido enviado com sucesso!"
13. E2E: fluxo completo testado
14. Integration: catalog_orders recebe registro

## Tasks / Subtasks

- [ ] **Task 1: Função generateWhatsAppMessage()** (AC: 1-3)
  - [ ] Template de mensagem formatada
  - [ ] URL encoding para WhatsApp

- [ ] **Task 2: Função createOrder()** (AC: 4)
  - [ ] INSERT em catalog_orders com items JSONB
  - [ ] Trigger Supabase Realtime automático

- [ ] **Task 3: Modal de confirmação** (AC: 7-8)
  - [ ] Preview da mensagem
  - [ ] Lista de produtos
  - [ ] Total

- [ ] **Task 4: Integração WhatsApp** (AC: 5-6, 9-10)
  - [ ] Env var NEXT_PUBLIC_WHATSAPP_BUSINESS
  - [ ] window.open() para WhatsApp
  - [ ] clearCart() após sucesso

- [ ] **Task 5: Página de sucesso** (AC: 12)
  - [ ] Redirect para /catalogo/pedido-enviado
  - [ ] CTA: "Voltar ao Catálogo"

- [ ] **Task 6: Testes** (AC: 13-14)
  - [ ] E2E: fluxo completo
  - [ ] Verificar catalog_orders

## Dev Notes

**[Source: docs/architecture/executive-summary.md]**
- **WhatsApp Integration**: Deep Links (no API) - Zero cost, native UX

### Message Template:
```typescript
function generateWhatsAppMessage(cart: CartItem[], user: CatalogUser) {
  const items = cart.map((item, i) => 
    `${i+1}. ${item.name} (${item.quantity}x) - R$ ${(item.price * item.quantity).toFixed(2)}`
  ).join('\n')
  
  const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0)
  
  return `Olá! Gostaria de finalizar meu pedido:

${items}

Total: R$ ${total.toFixed(2)}

Nome: ${user.name}
WhatsApp: ${user.whatsapp}`
}

// WhatsApp Link
const whatsappUrl = `https://wa.me/${process.env.NEXT_PUBLIC_WHATSAPP_BUSINESS}?text=${encodeURIComponent(message)}`
```

**Dependencies**: Story 3.2 (Cart)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-09 | v1.0 | Created | Bob (SM) |

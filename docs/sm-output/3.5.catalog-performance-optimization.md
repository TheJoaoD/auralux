# Story 3.5: Otimizar Performance com Caching e Prefetching

## Status
**Draft**

## Story

**As a** desenvolvedor,
**I want** implementar estratégias de caching e prefetching no catálogo,
**so that** usuários tenham experiência fluida e rápida mesmo em conexões lentas.

## Acceptance Criteria

1. React Query: staleTime 60s global
2. Prefetching com Intersection Observer
3. Next.js Image: WebP + blur placeholder
4. Service Worker: cache de imagens
5. ISR com revalidate: 60
6. Edge caching (Vercel CDN)
7. Lazy loading: next/dynamic
8. Debounce 300ms na busca
9. Optimistic updates em favoritos/carrinho
10. Skeleton screens em todos loading states
11. Lighthouse Performance ≥ 90 (mobile)
12. E2E: load < 2s em 3G

## Tasks / Subtasks

- [ ] **Task 1: React Query config global** (AC: 1)
  - [ ] QueryClientProvider com defaultOptions
  - [ ] staleTime: 60000, cacheTime: 300000

- [ ] **Task 2: Prefetching strategy** (AC: 2)
  - [ ] useInView hook em ProductCard
  - [ ] prefetchQuery() quando card entra na viewport

- [ ] **Task 3: Image optimization** (AC: 3)
  - [ ] next.config.js: WebP, blur, sizes
  - [ ] Placeholder blur dataURL

- [ ] **Task 4: Service Worker** (AC: 4)
  - [ ] Workbox ou next-pwa
  - [ ] Cache strategy: stale-while-revalidate

- [ ] **Task 5: ISR e Edge caching** (AC: 5-6)
  - [ ] revalidate: 60 em páginas estáticas
  - [ ] Vercel config para CDN

- [ ] **Task 6: Code splitting** (AC: 7)
  - [ ] next/dynamic para modais pesados
  - [ ] React.lazy() para componentes grandes

- [ ] **Task 7: Debounce e optimistic updates** (AC: 8-9)
  - [ ] useDebouncedValue(query, 300)
  - [ ] Optimistic updates já implementados em 3.1/3.2

- [ ] **Task 8: Skeleton screens** (AC: 10)
  - [ ] ProductCardSkeleton (já existe)
  - [ ] CartSkeleton, FavoritesSkeleton

- [ ] **Task 9: Performance testing** (AC: 11-12)
  - [ ] Lighthouse CI
  - [ ] Playwright network throttling 3G

## Dev Notes

**[Source: docs/architecture/performance-strategy.md]**

### Performance Budget:
- LCP < 2.5s ✅
- FID < 100ms
- CLS < 0.1
- Bundle Size < 200KB (initial JS gzipped)

### Next.js Config:
```javascript
// next.config.js
module.exports = {
  images: {
    formats: ['image/webp'],
    deviceSizes: [640, 750, 828, 1080, 1200],
    imageSizes: [16, 32, 48, 64, 96],
  },
  experimental: {
    optimizeCss: true,
  }
}
```

**Dependencies**: All Epic 1-3 stories

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-09 | v1.0 | Created | Bob (SM) |

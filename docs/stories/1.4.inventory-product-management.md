# Story 1.4: Product/Inventory Management - Registration, Gallery & Metrics

## Status
**Draft**

## Story

**As a** store owner,
**I want** to register products with images, prices, quantities, and categories, view them in an attractive gallery with profit margins, and monitor inventory metrics,
**so that** I can effectively manage my inventory, track profitability, and prevent stock shortages.

## Acceptance Criteria

1. Product registration modal/form with all required fields (image, name, category, sale price, cost price, quantity)
2. Image upload to Supabase Storage with preview before save
3. Category selection dropdown populated from configured categories
4. Automatic profit margin calculation and display ((sale_price - cost_price) / sale_price × 100)
5. Product data persists in Supabase products table with proper RLS
6. "+ Novo Produto" button prominently displayed above product gallery
7. Product gallery displays products in card-based grid layout
8. Each product card shows: image, name, sale price, cost price, quantity, profit margin, category badge
9. Total inventory quantity metric displayed (sum of all product quantities)
10. Total potential value metric displayed (sum of sale_price × quantity for all products)
11. Form validation for prices (sale_price >= cost_price) and quantities (>= 0)
12. Success feedback on product creation (toast notification)
13. Loading states during data fetching, image upload, and submission
14. Empty state when no products exist
15. Mobile-optimized card layout (responsive grid)
16. Image upload limited to 5MB, formats: JPG, PNG, WEBP
17. Low stock indicator on product cards (quantity <= low_stock_threshold)
18. Edit product functionality

## Tasks / Subtasks

- [ ] **Task 1: Product Data Service** (AC: 5, 16, 18)
  - [ ] Create `lib/services/productService.ts` with CRUD operations
  - [ ] Implement `createProduct(data: ProductInput): Promise<Product>`
    - Validate input with Zod schema
    - Insert into products table via Supabase client
    - Return created product object
  - [ ] Implement `updateProduct(id: string, data: Partial<ProductInput>): Promise<Product>`
    - Update product by ID
    - Verify RLS enforcement
    - Return updated product
  - [ ] Implement `getProducts(userId: string): Promise<Product[]>`
    - Query products table with RLS (auto-filtered by user_id)
    - Join with categories table for category names
    - Order by created_at DESC
    - Return array with computed profit_margin
  - [ ] Implement `getProductById(id: string): Promise<Product>`
    - Query single product by ID
    - Include category information
  - [ ] Implement image upload helper:
    ```typescript
    async uploadProductImage(file: File, productId: string): Promise<string> {
      // Validate file size (<= 5MB)
      // Validate file type (image/jpeg, image/png, image/webp)
      // Generate unique filename
      // Upload to 'products' bucket
      // Return public URL
    }
    ```
  - [ ] Add TypeScript types in `types/index.ts`:
    ```typescript
    export interface Product {
      id: string;
      user_id: string;
      category_id?: string;
      category?: Category;
      name: string;
      sku?: string;
      image_url?: string;
      sale_price: number;
      cost_price: number;
      quantity: number;
      low_stock_threshold: number;
      supplier?: string;
      profit_margin: number; // computed
      profit_amount: number; // computed
      is_low_stock: boolean; // computed
      created_at: string;
      updated_at: string;
    }

    export interface ProductInput {
      name: string;
      category_id?: string;
      sku?: string;
      image?: File;
      sale_price: number;
      cost_price: number;
      quantity: number;
      low_stock_threshold?: number;
      supplier?: string;
    }
    ```

- [ ] **Task 2: Product Form Validation** (AC: 11, 16)
  - [ ] Create `lib/validations/productSchemas.ts`
  - [ ] Define Zod schema for product creation:
    ```typescript
    export const productSchema = z.object({
      name: z
        .string()
        .min(3, 'Nome deve ter no mínimo 3 caracteres')
        .max(100, 'Nome muito longo'),
      category_id: z.string().uuid().optional(),
      sku: z.string().max(50).optional(),
      sale_price: z
        .number({ invalid_type_error: 'Preço de venda é obrigatório' })
        .positive('Preço de venda deve ser positivo')
        .multipleOf(0.01, 'Máximo 2 casas decimais'),
      cost_price: z
        .number({ invalid_type_error: 'Preço de custo é obrigatório' })
        .nonnegative('Preço de custo deve ser >= 0')
        .multipleOf(0.01, 'Máximo 2 casas decimais'),
      quantity: z
        .number({ invalid_type_error: 'Quantidade é obrigatória' })
        .int('Quantidade deve ser inteiro')
        .nonnegative('Quantidade deve ser >= 0'),
      low_stock_threshold: z.number().int().positive().optional().default(5),
      supplier: z.string().max(100).optional(),
      image: z
        .instanceof(File)
        .refine((file) => file.size <= 5 * 1024 * 1024, 'Imagem deve ter no máximo 5MB')
        .refine(
          (file) => ['image/jpeg', 'image/png', 'image/webp'].includes(file.type),
          'Formato inválido. Use JPG, PNG ou WEBP'
        )
        .optional()
    }).refine(
      (data) => data.sale_price >= data.cost_price,
      {
        message: 'Preço de venda deve ser >= Preço de custo',
        path: ['sale_price']
      }
    );
    ```
  - [ ] Create price formatter utility for Brazilian Real (R$)

- [ ] **Task 3: Image Upload Component** (AC: 2, 13, 16)
  - [ ] Create `components/products/ImageUpload.tsx`
  - [ ] Implement drag-and-drop zone using shadcn/ui or custom component
  - [ ] Add file input button for manual selection
  - [ ] Show image preview after selection:
    - Display thumbnail (200x200)
    - Show file name and size
    - Add "Remover" button to clear selection
  - [ ] Validate file on selection:
    - Check size (<= 5MB)
    - Check type (JPG, PNG, WEBP)
    - Show error message if invalid
  - [ ] Add loading indicator during upload
  - [ ] Style with Auralux colors:
    - Border: Taupe/Greige dashed
    - Background on hover: Taupe/Greige 10% opacity
    - Icon: Rosa Queimado
    - Preview border: Rosa Queimado

- [ ] **Task 4: Product Registration Modal** (AC: 1, 3, 4, 6, 12, 13)
  - [ ] Create `components/products/AddProductModal.tsx`
  - [ ] Use shadcn/ui Dialog component for modal
  - [ ] Create form with React Hook Form + Zod validation:
    - Image upload (ImageUpload component)
    - Product name input
    - Category select (populated from categories table)
    - Sale price input (currency format)
    - Cost price input (currency format)
    - Quantity input (number)
    - Low stock threshold input (number, default: 5)
    - SKU input (optional)
    - Supplier input (optional)
  - [ ] Add profit margin display (auto-calculated):
    - Formula: ((sale_price - cost_price) / sale_price) × 100
    - Update in real-time as prices change
    - Style: Rosa Queimado if > 30%, Areia otherwise
    - Format: "Margem: XX.X%"
  - [ ] Style form with Auralux color scheme:
    - Modal background: Off-White (#F7F5F2)
    - Sections separated by subtle dividers
    - Input labels: Taupe/Greige (#A1887F)
    - Currency symbol (R$): Areia (#E0DCD1)
  - [ ] Add "Salvar" and "Cancelar" buttons
  - [ ] Implement form submission flow:
    - Validate all fields
    - Upload image first (if provided)
    - Create product with image URL
    - Show loading state on Save button
    - Handle success: toast, close modal, reset form
    - Handle errors: show error toast
  - [ ] Implement optimistic UI update

- [ ] **Task 5: Product Gallery Component** (AC: 7, 8, 14, 15, 17)
  - [ ] Create `components/products/ProductGallery.tsx`
  - [ ] Use React Query for data fetching:
    ```typescript
    const { data: products, isLoading } = useQuery({
      queryKey: ['products'],
      queryFn: () => productService.getProducts(user.id)
    });
    ```
  - [ ] Implement card-based grid layout:
    - Grid: 1 column mobile, 2 columns tablet, 3 columns desktop
    - Card background: Taupe/Greige (#A1887F)
    - Card border-radius: 12px
    - Card aspect ratio: 3:4 (portrait)
  - [ ] Display for each product card:
    - Product image (top, cover fit, 200px height)
    - Placeholder if no image (Package icon, Prata color)
    - Product name (heading, Areia, truncate if long)
    - Category badge (small pill, Rosa Queimado background)
    - Sale price (large, Areia, "R$ XX,XX")
    - Cost price (small, Areia 70% opacity, "Custo: R$ XX,XX")
    - Quantity (badge with Box icon)
    - Profit margin (badge, Rosa Queimado if > 30%)
    - Low stock indicator (red badge if quantity <= threshold)
  - [ ] Add click handler to open edit modal
  - [ ] Implement loading state (skeleton cards)
  - [ ] Implement empty state:
    - Icon: Package (Prata, 64px)
    - Message: "Nenhum produto cadastrado"
    - Subtitle: "Adicione seu primeiro produto para começar"
    - "+ Novo Produto" button
  - [ ] Make cards touch-optimized

- [ ] **Task 6: Inventory Metrics Component** (AC: 9, 10)
  - [ ] Create `components/products/InventoryMetrics.tsx`
  - [ ] Calculate metrics from products array:
    ```typescript
    const totalQuantity = products.reduce((sum, p) => sum + p.quantity, 0);
    const totalValue = products.reduce((sum, p) => sum + (p.sale_price * p.quantity), 0);
    const lowStockCount = products.filter(p => p.is_low_stock).length;
    ```
  - [ ] Display 3 metric cards in row:
    1. **Total Quantidade**
       - Icon: Box (Rosa Queimado)
       - Value: Total quantity (large number)
       - Label: "Itens em Estoque"
    2. **Valor Potencial**
       - Icon: DollarSign (Rosa Queimado)
       - Value: R$ formatted total value
       - Label: "Valor Total do Estoque"
    3. **Estoque Baixo**
       - Icon: AlertTriangle (warning color #C76A6A if > 0)
       - Value: Count of low stock products
       - Label: "Produtos com Estoque Baixo"
  - [ ] Style cards:
    - Background: Taupe/Greige (#A1887F)
    - Border-radius: 12px
    - Padding: 16px
    - Responsive: stack on mobile, row on tablet+

- [ ] **Task 7: Inventory Page Implementation** (AC: 6)
  - [ ] Update `app/inventory/page.tsx` (created in Story 1.2)
  - [ ] Remove placeholder content
  - [ ] Implement page structure:
    - InventoryMetrics component
    - "+ Novo Produto" button
    - ProductGallery component
  - [ ] Add "+ Novo Produto" button:
    - Position: Top right
    - Style: Rosa Queimado background
    - Opens AddProductModal
  - [ ] Use MainLayout wrapper
  - [ ] Handle loading states
  - [ ] Handle error states

- [ ] **Task 8: Edit Product Functionality** (AC: 18)
  - [ ] Create `components/products/EditProductModal.tsx` (similar to Add modal)
  - [ ] Pre-populate form with existing product data
  - [ ] Allow updating all fields including image
  - [ ] Implement image replacement:
    - Show current image thumbnail
    - Allow uploading new image (delete old one from storage)
    - Option to keep existing image
  - [ ] Call updateProduct service method
  - [ ] Handle success/error feedback
  - [ ] Invalidate React Query cache on success

- [ ] **Task 9: Category Management Integration** (AC: 3)
  - [ ] Create `lib/services/categoryService.ts`
  - [ ] Implement `getCategories(userId: string): Promise<Category[]>`
  - [ ] Use React Query to fetch categories:
    ```typescript
    const { data: categories } = useQuery({
      queryKey: ['categories'],
      queryFn: () => categoryService.getCategories(user.id)
    });
    ```
  - [ ] Populate category dropdown in product form
  - [ ] Add "Nenhuma" option for products without category
  - [ ] Handle empty categories state (prompt to create in Settings)

- [ ] **Task 10: Testing & Verification** (AC: All)
  - [ ] Test product creation with all fields
  - [ ] Test product creation with minimal fields (no image, no category)
  - [ ] Test image upload (valid and invalid files)
  - [ ] Test price validation (sale_price < cost_price should fail)
  - [ ] Test quantity validation (negative should fail)
  - [ ] Test profit margin calculation accuracy
  - [ ] Test low stock indicator logic
  - [ ] Test metrics calculations
  - [ ] Test edit product flow
  - [ ] Test category integration
  - [ ] Test responsive layout on different screen sizes
  - [ ] Verify RLS policies prevent cross-user access
  - [ ] Write unit tests:
    - productSchema validation
    - Profit margin calculation utility
    - Price formatter
  - [ ] Write integration tests:
    - createProduct service
    - Image upload to Supabase Storage
    - RLS enforcement
  - [ ] Write component tests:
    - AddProductModal form validation
    - ProductGallery rendering
    - InventoryMetrics calculations
  - [ ] Document any issues or deviations

## Dev Notes

### Product Data Model
[Source: docs/architecture/02-data-models.md - Product section]

**Product Entity:**
- Primary Key: `id` (UUID)
- Foreign Keys: `user_id` → users.id, `category_id` → categories.id (nullable)
- Required: `name`, `sale_price`, `cost_price`, `quantity`
- Optional: `sku`, `image_url`, `category_id`, `supplier`
- Computed: `profit_margin`, `profit_amount`, `is_low_stock`

**Business Rules:**
- sale_price >= cost_price (enforced by database check constraint)
- quantity >= 0 (enforced by database check constraint)
- SKU must be unique per user (if provided)
- Image uploads limited to 5MB, types: JPEG, PNG, WEBP
- Low stock threshold defaults to 5
- profit_margin = ((sale_price - cost_price) / sale_price) × 100
- is_low_stock = quantity <= low_stock_threshold

**Computed Fields:**
```typescript
profit_margin: ((sale_price - cost_price) / sale_price) * 100
profit_amount: sale_price - cost_price
is_low_stock: quantity <= low_stock_threshold
```

### Database Schema
[Source: docs/architecture.md lines 1173-1230]

**Products Table:**
```sql
CREATE TABLE public.products (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
  category_id UUID REFERENCES public.categories(id) ON DELETE SET NULL,
  name TEXT NOT NULL,
  sku TEXT,
  image_url TEXT,
  sale_price DECIMAL(10,2) NOT NULL CHECK (sale_price >= cost_price),
  cost_price DECIMAL(10,2) NOT NULL CHECK (cost_price >= 0),
  quantity INTEGER NOT NULL DEFAULT 0 CHECK (quantity >= 0),
  low_stock_threshold INTEGER DEFAULT 5,
  supplier TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,

  CONSTRAINT unique_sku_per_user UNIQUE (user_id, sku)
);

-- Indexes
CREATE INDEX idx_products_user_id ON public.products(user_id);
CREATE INDEX idx_products_category_id ON public.products(category_id);
CREATE INDEX idx_products_quantity ON public.products(quantity);
```

**Supabase Storage Bucket:**
- Bucket name: `products`
- Public read: true
- File size limit: 5MB
- Allowed types: image/jpeg, image/png, image/webp
- RLS: Authenticated users can upload to own folder (user_id in path)

### UI/UX Design Specifications
[Source: docs/epics/01-ui-ux-guidelines.md - Inventory Management Screen]

**Product Gallery Design:**
- Card grid: 1 column mobile, 2 tablet, 3 desktop
- Card background: Taupe/Greige (#A1887F)
- Card border-radius: 12px
- Card aspect ratio: 3:4 portrait
- Image: Cover fit, 200px height
- Name: Areia (#E0DCD1), 18px, font-semibold
- Sale price: Areia, 20px, font-bold
- Cost price: Areia 70% opacity, 14px
- Profit margin badge: Rosa Queimado background if > 30%, Taupe otherwise
- Low stock badge: #C76A6A (warning red) background
- Category badge: Rosa Queimado background, small

**Metrics Cards:**
- Background: Taupe/Greige (#A1887F)
- Icon: Rosa Queimado (#C49A9A)
- Value: Areia (#E0DCD1), large bold
- Label: Areia 70% opacity, small

**Add/Edit Product Modal:**
- Modal background: Off-White (#F7F5F2)
- Form sections separated by dividers (Taupe/Greige)
- Currency inputs: R$ prefix in Areia
- Profit margin display: Rosa Queimado if > 30%
- Save button: Rosa Queimado background
- Cancel button: Taupe/Greige outline

### Functional Requirements
[Source: docs/epics/00-prd-core.md FR15-FR23]
- FR15: Product registration with image, prices, quantity
- FR16: Total inventory quantity metric
- FR17: Total potential value metric
- FR18: Product gallery with all details and profit margin
- FR19: Profit margin calculation
- FR20: Automatic quantity updates on sales (future story)
- FR21: Category selection from settings
- FR22: Low stock alerts
- FR23: Inventory movement tracking (future story)

### Image Upload Flow
[Source: docs/architecture/01-tech-stack.md]
- Use Supabase Storage for file uploads
- Generate unique filename: `${user_id}/${productId}_${timestamp}.${ext}`
- Upload to 'products' bucket
- Return public URL
- Store URL in products.image_url

**Upload Pattern:**
```typescript
async function uploadProductImage(file: File, productId: string): Promise<string> {
  const ext = file.name.split('.').pop();
  const filename = `${user.id}/${productId}_${Date.now()}.${ext}`;

  const { data, error } = await supabase.storage
    .from('products')
    .upload(filename, file, {
      cacheControl: '3600',
      upsert: false
    });

  if (error) throw error;

  const { data: { publicUrl } } = supabase.storage
    .from('products')
    .getPublicUrl(filename);

  return publicUrl;
}
```

### Price Formatting
**Brazilian Real (R$) Format:**
```typescript
export function formatCurrency(value: number): string {
  return new Intl.NumberFormat('pt-BR', {
    style: 'currency',
    currency: 'BRL'
  }).format(value);
}

// Example: formatCurrency(1234.56) → "R$ 1.234,56"
```

### Profit Margin Calculation
```typescript
export function calculateProfitMargin(salePrice: number, costPrice: number): number {
  if (salePrice === 0) return 0;
  return ((salePrice - costPrice) / salePrice) * 100;
}

// Example: calculateProfitMargin(100, 60) → 40.0 (40%)
```

### File Structure
[Source: docs/architecture/08-source-tree.md]
```
app/
  inventory/
    page.tsx                    # Main inventory page

components/
  products/
    AddProductModal.tsx         # Product registration modal
    EditProductModal.tsx        # Product edit modal
    ProductGallery.tsx          # Product cards grid
    ProductCard.tsx             # Individual product card
    InventoryMetrics.tsx        # Metrics display
    ImageUpload.tsx             # Image upload component

lib/
  services/
    productService.ts           # Product CRUD operations
    categoryService.ts          # Category operations
  validations/
    productSchemas.ts           # Zod validation schemas
  utils/
    formatters.ts               # Currency formatter
    calculations.ts             # Profit margin calculation

types/
  index.ts                      # Product & Category interfaces

__tests__/
  unit/
    services/
      productService.test.ts
    validations/
      productSchemas.test.ts
    utils/
      calculations.test.ts
  integration/
    products/
      product-crud.test.ts
      image-upload.test.ts
  components/
    products/
      AddProductModal.test.tsx
      ProductGallery.test.tsx
```

### Testing

[Source: docs/architecture/09-coding-standards.md]

**Unit Tests:**
- productSchema validation (all fields, edge cases)
- Profit margin calculation (various scenarios)
- Currency formatter
- Image upload validation (file size, type)

**Integration Tests:**
- createProduct with database
- updateProduct with RLS
- Image upload to Supabase Storage
- Category dropdown population

**Component Tests:**
- AddProductModal form validation
- Profit margin auto-calculation display
- ProductGallery rendering states (data, loading, empty)
- InventoryMetrics calculations

**Test Coverage Goal:** 80% for services, 70% for components

**Critical Test Cases:**
1. sale_price < cost_price should fail validation
2. Negative quantity should fail validation
3. File > 5MB should fail upload
4. Invalid file type should fail upload
5. Profit margin should update in real-time as prices change
6. Low stock indicator should show when quantity <= threshold
7. RLS should prevent viewing other users' products

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-07 | v1.0 | Initial story creation for Product/Inventory Management | Bob (Scrum Master) |

---

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

---

## QA Results

*This section will be populated by the QA Agent after implementation.*

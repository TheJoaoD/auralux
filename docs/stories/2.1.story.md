# Story 2.1: Schema de Parcelas e Fluxo de Caixa

## Status: Draft

## Story

**As a** administrador do sistema,
**I want** que o banco de dados suporte parcelas individuais e registros de fluxo de caixa,
**so that** eu possa rastrear cada entrada financeira separadamente.

## Acceptance Criteria

1. Tabela `sale_installments` criada com todos os campos especificados
2. Tabela `cash_flow` criada com todos os campos especificados
3. Coluna `payment_status` adicionada à tabela `sales`
4. Coluna `down_payment` adicionada à tabela `sales`
5. RLS policies configuradas para ambas as novas tabelas
6. Índices criados para queries de vencimento e período
7. Tipos TypeScript gerados e atualizados

## Integration Verification

- IV1: Vendas existentes continuam funcionando sem erros
- IV2: Triggers de estoque não são afetados
- IV3: RLS das tabelas existentes permanece intacto

## Tasks / Subtasks

- [ ] **Task 1: Criar tabela `sale_installments`** (AC: 1)
  - [ ] Executar migration via Supabase MCP
  - [ ] Campos: id, sale_id, user_id, installment_number, amount, due_date, status, paid_amount, paid_at, payment_method, notes, created_at, updated_at
  - [ ] Constraints: valid_status, valid_amount, valid_paid, unique_installment
  - [ ] FK: sale_id → sales(id) ON DELETE CASCADE
  - [ ] FK: user_id → users(id)

- [ ] **Task 2: Criar tabela `cash_flow`** (AC: 2)
  - [ ] Executar migration via Supabase MCP
  - [ ] Campos: id, user_id, type, category, amount, description, reference_type, reference_id, transaction_date, created_at, created_by
  - [ ] Constraints: valid_type (income/expense), valid_category, valid_amount
  - [ ] FK: user_id → users(id)
  - [ ] FK: created_by → users(id)

- [ ] **Task 3: Alterar tabela `sales`** (AC: 3, 4)
  - [ ] ADD COLUMN payment_status TEXT DEFAULT 'paid'
  - [ ] ADD COLUMN down_payment DECIMAL(10,2) DEFAULT 0
  - [ ] ADD CONSTRAINT valid_payment_status CHECK (payment_status IN ('paid', 'partial', 'pending'))

- [ ] **Task 4: Criar RLS Policies** (AC: 5)
  - [ ] Habilitar RLS em sale_installments
  - [ ] Criar policies SELECT/INSERT/UPDATE/DELETE para sale_installments (auth.uid() = user_id)
  - [ ] Habilitar RLS em cash_flow
  - [ ] Criar policies SELECT/INSERT/UPDATE/DELETE para cash_flow (auth.uid() = user_id)

- [ ] **Task 5: Criar Índices** (AC: 6)
  - [ ] idx_installments_sale ON sale_installments(sale_id)
  - [ ] idx_installments_user_due ON sale_installments(user_id, due_date)
  - [ ] idx_installments_status ON sale_installments(status) WHERE status != 'paid'
  - [ ] idx_installments_overdue ON sale_installments(user_id, due_date, status) WHERE status IN ('pending', 'partial')
  - [ ] idx_cashflow_user_date ON cash_flow(user_id, transaction_date DESC)
  - [ ] idx_cashflow_type_date ON cash_flow(user_id, type, transaction_date)
  - [ ] idx_cashflow_reference ON cash_flow(reference_type, reference_id)
  - [ ] idx_cashflow_category ON cash_flow(user_id, category, transaction_date)

- [ ] **Task 6: Regenerar Tipos TypeScript** (AC: 7)
  - [ ] Executar: `pnpm supabase gen types typescript --project-id <project_id> > types/supabase.ts`
  - [ ] Verificar que novos tipos Installment e CashFlow estão no arquivo

- [ ] **Task 7: Verificação de Integração** (IV1, IV2, IV3)
  - [ ] Testar criar uma venda à vista e verificar que funciona
  - [ ] Verificar que triggers de estoque executam normalmente
  - [ ] Verificar RLS: usuário A não vê dados de usuário B

## Dev Notes

### SQL Completo para Migration

[Source: docs/architecture-cash-flow.md#Apêndice A]

```sql
-- ============================================
-- MIGRATION: Create Cash Flow Tables
-- ============================================

-- 1. Tabela de Parcelas
CREATE TABLE sale_installments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  sale_id UUID NOT NULL REFERENCES sales(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES users(id),
  installment_number INTEGER NOT NULL,
  amount DECIMAL(10,2) NOT NULL,
  due_date DATE NOT NULL,
  status TEXT DEFAULT 'pending',
  paid_amount DECIMAL(10,2) DEFAULT 0,
  paid_at TIMESTAMPTZ,
  payment_method TEXT,
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  CONSTRAINT valid_status CHECK (status IN ('pending', 'paid', 'partial', 'overdue', 'cancelled')),
  CONSTRAINT valid_amount CHECK (amount > 0),
  CONSTRAINT valid_paid CHECK (paid_amount >= 0 AND paid_amount <= amount),
  CONSTRAINT unique_installment UNIQUE (sale_id, installment_number)
);

-- 2. Tabela de Fluxo de Caixa
CREATE TABLE cash_flow (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  type TEXT NOT NULL,
  category TEXT NOT NULL,
  amount DECIMAL(10,2) NOT NULL,
  description TEXT,
  reference_type TEXT,
  reference_id UUID,
  transaction_date DATE NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id),
  CONSTRAINT valid_type CHECK (type IN ('income', 'expense')),
  CONSTRAINT valid_category CHECK (category IN (
    'sale_cash', 'sale_down_payment', 'installment_payment',
    'refund', 'adjustment', 'other'
  )),
  CONSTRAINT valid_amount CHECK (amount > 0)
);

-- 3. Alterações em sales
ALTER TABLE sales
  ADD COLUMN IF NOT EXISTS payment_status TEXT DEFAULT 'paid',
  ADD COLUMN IF NOT EXISTS down_payment DECIMAL(10,2) DEFAULT 0;

ALTER TABLE sales DROP CONSTRAINT IF EXISTS valid_payment_status;
ALTER TABLE sales ADD CONSTRAINT valid_payment_status
  CHECK (payment_status IN ('paid', 'partial', 'pending'));

-- 4. Índices
CREATE INDEX IF NOT EXISTS idx_installments_sale ON sale_installments(sale_id);
CREATE INDEX IF NOT EXISTS idx_installments_user_due ON sale_installments(user_id, due_date);
CREATE INDEX IF NOT EXISTS idx_installments_status ON sale_installments(status) WHERE status != 'paid';
CREATE INDEX IF NOT EXISTS idx_installments_overdue ON sale_installments(user_id, due_date, status)
  WHERE status IN ('pending', 'partial');

CREATE INDEX IF NOT EXISTS idx_cashflow_user_date ON cash_flow(user_id, transaction_date DESC);
CREATE INDEX IF NOT EXISTS idx_cashflow_type_date ON cash_flow(user_id, type, transaction_date);
CREATE INDEX IF NOT EXISTS idx_cashflow_reference ON cash_flow(reference_type, reference_id);
CREATE INDEX IF NOT EXISTS idx_cashflow_category ON cash_flow(user_id, category, transaction_date);

-- 5. RLS Policies
ALTER TABLE sale_installments ENABLE ROW LEVEL SECURITY;
ALTER TABLE cash_flow ENABLE ROW LEVEL SECURITY;

-- sale_installments policies
CREATE POLICY "Users can view own installments" ON sale_installments
  FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can insert own installments" ON sale_installments
  FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update own installments" ON sale_installments
  FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Users can delete own installments" ON sale_installments
  FOR DELETE USING (auth.uid() = user_id);

-- cash_flow policies
CREATE POLICY "Users can view own cash flow" ON cash_flow
  FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can insert own cash flow" ON cash_flow
  FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update own cash flow" ON cash_flow
  FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Users can delete own cash flow" ON cash_flow
  FOR DELETE USING (auth.uid() = user_id);
```

### Estrutura de Dados

[Source: docs/architecture-cash-flow.md#4.1]

**sale_installments:**
| Campo | Tipo | Descrição |
|-------|------|-----------|
| id | UUID | PK auto-gerado |
| sale_id | UUID | FK para sales |
| user_id | UUID | FK para users (owner) |
| installment_number | INTEGER | 1, 2, 3... |
| amount | DECIMAL(10,2) | Valor da parcela |
| due_date | DATE | Data de vencimento |
| status | TEXT | pending/paid/partial/overdue/cancelled |
| paid_amount | DECIMAL(10,2) | Quanto já foi pago |
| paid_at | TIMESTAMPTZ | Quando foi pago |
| payment_method | TEXT | pix/cash/etc |
| notes | TEXT | Observações |

**cash_flow:**
| Campo | Tipo | Descrição |
|-------|------|-----------|
| id | UUID | PK auto-gerado |
| user_id | UUID | FK para users (owner) |
| type | TEXT | income/expense |
| category | TEXT | sale_cash/sale_down_payment/installment_payment/refund/adjustment/other |
| amount | DECIMAL(10,2) | Valor (sempre positivo) |
| description | TEXT | Descrição |
| reference_type | TEXT | sale/installment/etc |
| reference_id | UUID | ID do registro origem |
| transaction_date | DATE | Data da transação |

### Project ID Supabase

- Usar MCP `mcp__supabase__list_projects` para obter o project_id
- Usar `mcp__supabase__apply_migration` para executar o SQL

### Testing

- **Localização**: Não há testes específicos para migrations
- **Verificação manual**: Executar queries de teste após migration
- **Comando para tipos**: `pnpm supabase gen types typescript --project-id <id> > types/supabase.ts`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-29 | 1.0 | Story criada a partir do PRD | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
_A ser preenchido pelo dev agent_

### Debug Log References
_A ser preenchido pelo dev agent_

### Completion Notes
_A ser preenchido pelo dev agent_

### File List
_A ser preenchido pelo dev agent_

---

## QA Results
_A ser preenchido pelo QA agent_

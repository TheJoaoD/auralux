# Story 1.1: PWA Configuration, Database Setup & Authentication Foundation

## Status
**Draft**

## Story

**As a** developer,
**I want** to complete the PWA configuration with proper logos/manifest, set up the complete database schema in Supabase, and establish authentication foundation,
**so that** the application has a production-ready infrastructure for iOS installation, secure data storage, and user authentication.

## Acceptance Criteria

1. PWA manifest.json configured with all required iOS-specific settings
2. App logos in multiple sizes (192x192, 512x512) properly configured from logos.md
3. Apple-touch-icon configured for iOS home screen installation
4. Splash screen configuration for iOS PWA
5. All 7 database tables created in Supabase with proper constraints
6. Row Level Security (RLS) policies implemented for all tables
7. Database indexes created for performance optimization
8. Computed views created (daily sales metrics, payment breakdown, low stock, top selling)
9. Supabase Storage bucket 'products' created with RLS policies
10. Triggers implemented for inventory updates and customer purchase tracking
11. Supabase client properly configured in Next.js app
12. Environment variables configured (.env.local)
13. Authentication context/hook created for user state management
14. PWA installability verified on iOS Safari

## Tasks / Subtasks

- [ ] **Task 1: PWA Configuration & Logos** (AC: 1, 2, 3, 4, 14)
  - [ ] Create/update `public/manifest.json` with Auralux branding
    - Set name: "Auralux", short_name: "Auralux"
    - Set start_url, display: "standalone", theme_color: "#C49A9A" (Rosa Queimado)
    - Set background_color: "#202020" (Carvão)
    - Configure orientation: "portrait" for mobile-first
  - [ ] Download and process logos from URLs in logos.md
    - Main logo: `https://pxopccvykwdzjqjodmob.supabase.co/storage/v1/object/public/auralux_images/logo_auralux_new.png`
    - Purple logo: `https://pxopccvykwdzjqjodmob.supabase.co/storage/v1/object/public/auralux_images/lgo_purple.png`
  - [ ] Generate PWA icons in required sizes using main logo:
    - 192x192px → `public/icon-192.png`
    - 512x512px → `public/icon-512.png`
    - 180x180px → `public/apple-touch-icon.png` (iOS specific)
  - [ ] Add icons array to manifest.json with all sizes and purposes
  - [ ] Configure iOS meta tags in `app/layout.tsx`:
    - `<meta name="apple-mobile-web-app-capable" content="yes">`
    - `<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">`
    - `<link rel="apple-touch-icon" href="/apple-touch-icon.png">`
  - [ ] Create splash screens for iOS using Auralux logo on Carvão background
  - [ ] Test PWA installability on iOS Safari (Add to Home Screen)

- [ ] **Task 2: Supabase Database Schema Creation** (AC: 5, 6, 7, 8, 9, 10)
  - [ ] Create migration file: `supabase/migrations/001_initial_schema.sql`
  - [ ] Enable UUID extension: `CREATE EXTENSION IF NOT EXISTS "uuid-ossp"`
  - [ ] Create `users` table extending auth.users with RLS policies
    - Columns: id (PK), store_name, created_at, updated_at
    - RLS: Users can view/update own profile only
  - [ ] Create `categories` table with RLS policies
    - Columns: id, user_id (FK), name, description, timestamps
    - Unique constraint: (user_id, name)
    - Index on user_id
    - RLS: Users CRUD own categories only
  - [ ] Create `customers` table with RLS policies
    - Columns: id, user_id (FK), full_name, whatsapp, email, address, purchase_count, total_purchases, total_due, timestamps
    - Unique constraint: (user_id, whatsapp)
    - Indexes: user_id, whatsapp, full_name (GIN for search)
    - RLS: Users CRUD own customers only
  - [ ] Create `products` table with RLS policies
    - Columns: id, user_id (FK), category_id (FK nullable), name, sku, image_url, sale_price, cost_price, quantity, low_stock_threshold, supplier, timestamps
    - Unique constraint: (user_id, sku) when sku NOT NULL
    - Indexes: user_id, category_id, quantity
    - Check constraints: sale_price >= cost_price, quantity >= 0
    - RLS: Users CRUD own products only
  - [ ] Create `sales` table with RLS policies
    - Columns: id, user_id (FK), customer_id (FK), total_amount, payment_method, installment_count, actual_amount_received, status, notes, timestamps
    - Indexes: user_id, customer_id, created_at, payment_method
    - Check: payment_method IN ('pix', 'cash', 'installment')
    - Check: installment_count BETWEEN 1 AND 12 when payment_method='installment'
    - RLS: Users CRUD own sales only
  - [ ] Create `sale_items` table with RLS policies
    - Columns: id, sale_id (FK CASCADE), product_id (FK), product_name, quantity, unit_price, unit_cost, created_at
    - Indexes: sale_id, product_id
    - Computed column: subtotal = quantity * unit_price
    - RLS: Users view sale_items for own sales only (via join)
  - [ ] Create `inventory_movements` table with RLS policies
    - Columns: id, user_id (FK), product_id (FK), movement_type, quantity_change, quantity_before, quantity_after, reference_id, notes, created_at
    - Indexes: user_id, product_id, created_at, reference_id
    - Check: movement_type IN ('addition', 'sale', 'adjustment')
    - RLS: Users view own movements only
  - [ ] Create database views:
    - `v_daily_sales_metrics`: Daily sales aggregation
    - `v_payment_method_breakdown`: Payment distribution
    - `v_low_stock_products`: Products below threshold
    - `v_top_selling_products`: Best sellers by quantity
  - [ ] Create triggers:
    - `update_customer_on_sale`: Increment purchase_count and total_purchases
    - `update_inventory_on_sale`: Decrement product quantity on sale
    - `create_inventory_movement_on_sale`: Auto-create movement record
    - `update_updated_at`: Auto-update timestamps on all tables
  - [ ] Create Supabase Storage bucket 'products' with RLS policy:
    - Public read access
    - Authenticated users can upload (user_id in path)
    - Max file size: 5MB
    - Allowed types: image/jpeg, image/png, image/webp
  - [ ] Run migration using Supabase MCP or CLI
  - [ ] Verify all tables, indexes, and policies created successfully

- [ ] **Task 3: Supabase Client Configuration** (AC: 11, 12)
  - [ ] Install required dependencies (if not present):
    - `pnpm add @supabase/supabase-js @supabase/auth-helpers-nextjs`
  - [ ] Create `.env.local` file with Supabase credentials:
    ```
    NEXT_PUBLIC_SUPABASE_URL=https://[project-ref].supabase.co
    NEXT_PUBLIC_SUPABASE_ANON_KEY=[anon-key]
    SUPABASE_SERVICE_ROLE_KEY=[service-role-key]
    ```
  - [ ] Create `lib/supabase/client.ts` for browser client
  - [ ] Create `lib/supabase/server.ts` for server-side client (cookies-based)
  - [ ] Create `lib/supabase/middleware.ts` for auth middleware
  - [ ] Add middleware.ts to project root for protected routes
  - [ ] Test connection by querying a simple SELECT from users table

- [ ] **Task 4: Authentication Foundation** (AC: 13)
  - [ ] Create `lib/hooks/useAuth.ts` hook for authentication state
    - Expose: user, session, signIn, signOut, loading states
    - Use Supabase auth.onAuthStateChange for real-time updates
  - [ ] Create `lib/contexts/AuthContext.tsx` for global auth state
    - Provide user, session, and auth methods
    - Handle session refresh automatically
  - [ ] Wrap app with AuthContext in `app/layout.tsx`
  - [ ] Create `app/auth` route group for login/signup pages (future)
  - [ ] Add auth state logging for debugging (dev mode only)

- [ ] **Task 5: Verification & Testing** (AC: All)
  - [ ] Verify PWA manifest loads correctly in browser DevTools
  - [ ] Test iOS installation flow on real device or simulator
  - [ ] Verify all database tables exist in Supabase dashboard
  - [ ] Test RLS policies by querying as different users
  - [ ] Verify database indexes created successfully
  - [ ] Test Supabase client connection from Next.js app
  - [ ] Verify auth hook returns user state correctly
  - [ ] Create basic unit tests for auth hook
  - [ ] Document any deviations or issues in completion notes

## Dev Notes

### PWA Requirements
[Source: docs/epics/00-prd-core.md#Compatibility-Requirements CR3]
- Application must meet PWA standards for installability and offline functionality
- iOS-specific meta tags required for proper home screen installation
- Manifest must include icons in multiple sizes for different devices

[Source: docs/epics/01-ui-ux-guidelines.md#Loading-States]
- Splash screen must use Auralux logo (Prata #BDBDBD) on Carvão background (#202020)
- Loading states should use Rosa Queimado (#C49A9A) as accent color

**Logo URLs from logos.md:**
- Main logo: `https://pxopccvykwdzjqjodmob.supabase.co/storage/v1/object/public/auralux_images/logo_auralux_new.png`
- Purple logo: `https://pxopccvykwdzjqjodmob.supabase.co/storage/v1/object/public/auralux_images/lgo_purple.png`

**Color Palette for PWA Configuration:**
- Theme color (primary): #C49A9A (Rosa Queimado)
- Background color: #202020 (Carvão)

### Database Architecture
[Source: docs/architecture/04-database-schema.md]
The database schema consists of 7 core tables with strict RLS policies:

**Tables Overview:**
1. **users** - Extends Supabase auth.users with store metadata
2. **customers** - Customer contact info and purchase metrics
3. **categories** - Product categorization
4. **products** - Inventory items with pricing and stock
5. **sales** - Sales transactions with payment details
6. **sale_items** - Line items with price snapshots
7. **inventory_movements** - Audit trail for stock changes

**Critical Database Rules:**
- All tables MUST have RLS policies enabled
- User isolation enforced via `auth.uid() = user_id` policies
- Foreign keys configured with appropriate CASCADE/SET NULL actions
- Timestamps auto-updated via trigger function
- Computed fields handled via views or application logic

[Source: docs/architecture/02-data-models.md]
**Key Relationships:**
- User → one-to-many → Customers, Products, Sales, Categories
- Customer → one-to-many → Sales
- Product → one-to-many → SaleItems, InventoryMovements
- Sale → one-to-many → SaleItems, InventoryMovements
- Category → one-to-many → Products (nullable)

**Business Logic via Triggers:**
- Sale creation → auto-decrement product.quantity
- Sale creation → auto-increment customer.purchase_count and total_purchases
- Sale creation → auto-create inventory_movement record
- Any update → auto-update updated_at timestamp

### Database Schema SQL Reference
[Source: docs/architecture.md lines 1019-1404]

Complete schema available in architecture.md. Key highlights:

**RLS Policy Pattern:**
```sql
CREATE POLICY "Users can view own [table]"
  ON public.[table] FOR SELECT
  USING (auth.uid() = user_id);
```

**Unique Constraints:**
- (user_id, whatsapp) on customers
- (user_id, name) on categories
- (user_id, sku) on products when sku NOT NULL

**Indexes for Performance:**
- All foreign keys indexed
- Search fields: customers.full_name (GIN), customers.whatsapp
- Time-series: sales.created_at for dashboard queries
- Low stock: products.quantity for alerts

**Storage Bucket Configuration:**
```sql
-- Bucket name: products
-- Public: true (read-only)
-- File size limit: 5MB
-- Allowed MIME types: image/jpeg, image/png, image/webp
-- RLS: Authenticated users can upload to own folder
```

### Authentication Architecture
[Source: docs/architecture/01-tech-stack.md]
- **Auth Provider:** Supabase Auth (JWT-based)
- **Session Management:** Cookie-based for SSR, localStorage for client
- **Auth Helpers:** @supabase/auth-helpers-nextjs for Next.js integration

[Source: docs/architecture/00-overview.md]
**Authentication Flow:**
```
User → Login Screen (Supabase Auth)
     → JWT Token stored in cookies
     → Next.js Middleware validates token
     → Protected routes accessible
     → RLS policies enforce data isolation
```

### Tech Stack for This Story
[Source: docs/architecture/01-tech-stack.md]
- **Database:** PostgreSQL 15+ (Supabase managed)
- **BaaS:** Supabase (Auth, Storage, Realtime)
- **Frontend:** Next.js 16.0.0, React 19.2.0, TypeScript 5.x
- **Package Manager:** pnpm 8.x
- **Build Tool:** Next.js (Turbopack)

### Project Structure
[Source: docs/architecture/08-source-tree.md]

**File Locations for This Story:**
```
public/
  manifest.json          # PWA manifest
  icon-192.png          # PWA icon 192x192
  icon-512.png          # PWA icon 512x512
  apple-touch-icon.png  # iOS home screen icon

supabase/
  migrations/
    001_initial_schema.sql  # Database schema migration

lib/
  supabase/
    client.ts           # Browser Supabase client
    server.ts           # Server Supabase client
    middleware.ts       # Auth middleware helper
  hooks/
    useAuth.ts          # Authentication hook
  contexts/
    AuthContext.tsx     # Global auth state

app/
  layout.tsx            # Root layout (add PWA meta tags)
  middleware.ts         # Route protection middleware

.env.local              # Environment variables (gitignored)
```

### Testing

[Source: docs/architecture/09-coding-standards.md lines 2073-2290]

**Test Organization:**
- Unit tests: `__tests__/unit/[module].test.ts`
- Integration tests: `__tests__/integration/[feature].test.ts`
- E2E tests: `__tests__/e2e/[flow].spec.ts`

**Testing Standards for This Story:**
- **Framework:** Vitest 1.x for unit tests
- **Coverage Goal:** 80% for hooks and utilities
- **Mocking:** Vitest built-in mocking for Supabase client

**Required Tests:**
1. **useAuth hook tests:**
   - Should return null user when not authenticated
   - Should return user object when authenticated
   - Should handle sign in successfully
   - Should handle sign out successfully
   - Should handle auth state changes in real-time

2. **Supabase client tests:**
   - Should initialize with correct credentials
   - Should throw error when credentials missing
   - Should create authenticated client when user logged in

3. **Database schema tests (integration):**
   - Should enforce RLS policies correctly
   - Should prevent cross-user data access
   - Should auto-update timestamps on record changes
   - Should enforce unique constraints

**Test File Locations:**
```
__tests__/
  unit/
    hooks/
      useAuth.test.ts
    supabase/
      client.test.ts
  integration/
    database/
      rls-policies.test.ts
      triggers.test.ts
```

**Test Pattern (AAA):**
```typescript
describe('useAuth', () => {
  it('should return null user when not authenticated', () => {
    // Arrange
    const mockSupabase = createMockSupabaseClient({ user: null });

    // Act
    const { result } = renderHook(() => useAuth(), {
      wrapper: createAuthWrapper(mockSupabase)
    });

    // Assert
    expect(result.current.user).toBeNull();
    expect(result.current.session).toBeNull();
  });
});
```

### Additional Notes

**Critical PWA Requirement:**
⚠️ **ATTENTION MAXIMALE** - O projeto PRECISA ter PWA completamente configurado pois será instalado no iOS como app nativo. Sem manifest correto e ícones, o app não pode ser adicionado à tela inicial.

**Database Migration Strategy:**
- Use Supabase MCP to execute migrations: `mcp__airtable__EXECUTE_TOOL` with SQL
- Alternative: Use Supabase CLI: `supabase db push`
- All schema changes MUST be versioned in migration files

**Environment Variables Security:**
- `.env.local` MUST be in `.gitignore`
- Never commit SUPABASE_SERVICE_ROLE_KEY to git
- Use NEXT_PUBLIC_ prefix only for client-accessible vars

**iOS-Specific Considerations:**
- iOS Safari has specific requirements for PWA installation
- Apple-touch-icon must be exactly 180x180px
- Status bar style should be "black-translucent" for immersive experience
- Test installation on real iOS device (iOS Simulator has limitations)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-07 | v1.0 | Initial story creation for PWA, Database, and Auth setup | Bob (Scrum Master) |

---

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used
*To be filled by Dev Agent*

### Debug Log References
*To be filled by Dev Agent*

### Completion Notes List
*To be filled by Dev Agent*

### File List
*To be filled by Dev Agent*

---

## QA Results

*This section will be populated by the QA Agent after implementation.*

# Story 1.12: Comprehensive Testing & Quality Assurance

## Status
**Draft**

## Story

**As a** development team,
**I want** comprehensive test coverage across unit, integration, and E2E tests,
**so that** the application is reliable, bug-free, and ready for production.

## Acceptance Criteria

1. Unit tests for all services, utilities, and validation schemas
2. Integration tests for database operations and API routes
3. Component tests for all major UI components
4. E2E tests for critical user flows
5. Test coverage minimum: 75% overall, 90% for business logic
6. All tests passing in CI/CD pipeline
7. RLS policy security tests
8. Performance tests for dashboard queries
9. Cross-browser testing (Safari iOS, Chrome iOS)
10. Accessibility testing (WCAG AA compliance)
11. Error scenario testing (network failures, validation errors)
12. Load testing for concurrent users

## Tasks / Subtasks

- [ ] **Task 1: Unit Tests** (AC: 1, 5)
  - [ ] Test all Zod schemas (customer, product, category, sale)
  - [ ] Test utility functions (formatters, calculations)
  - [ ] Test service methods with mocked Supabase client
  - [ ] Test hooks (useAuth, useSaleWizard)
  - [ ] Coverage goal: 90%+ for services/utils

- [ ] **Task 2: Integration Tests** (AC: 2, 5, 7)
  - [ ] Test customer CRUD with real database
  - [ ] Test product CRUD with image upload
  - [ ] Test category CRUD with ON DELETE SET NULL
  - [ ] Test sale creation with triggers
  - [ ] Test RLS policies (cross-user data isolation)
  - [ ] Test database views (v_daily_sales_metrics, etc.)
  - [ ] Coverage goal: 85%+ for database operations

- [ ] **Task 3: Component Tests** (AC: 3)
  - [ ] Test all forms (validation, submission, error handling)
  - [ ] Test modals (open, close, state management)
  - [ ] Test dashboard components (metrics, charts)
  - [ ] Test navigation (bottom nav, routing)
  - [ ] Coverage goal: 70%+ for components

- [ ] **Task 4: E2E Tests** (AC: 4)
  - [ ] Critical Flow 1: Login → Dashboard → Logout
  - [ ] Critical Flow 2: Create Customer
  - [ ] Critical Flow 3: Create Product with Image
  - [ ] Critical Flow 4: Complete Sale (Customer → Products → Payment)
  - [ ] Critical Flow 5: View Updated Dashboard Metrics
  - [ ] Test on iOS Safari and Chrome iOS
  - [ ] Use Playwright for E2E testing

- [ ] **Task 5: Performance Tests** (AC: 8)
  - [ ] Dashboard metrics query performance (<2s)
  - [ ] Product gallery load with 100+ products
  - [ ] Sales list pagination performance
  - [ ] Image upload performance
  - [ ] Real-time subscription latency

- [ ] **Task 6: Security Tests** (AC: 7)
  - [ ] RLS policy enforcement (cannot access other users' data)
  - [ ] Authentication required for protected routes
  - [ ] XSS prevention (input sanitization)
  - [ ] SQL injection prevention (parameterized queries)
  - [ ] CSRF protection (Next.js built-in)

- [ ] **Task 7: Error Scenario Tests** (AC: 11)
  - [ ] Network failure during sale creation
  - [ ] Validation errors on forms
  - [ ] Duplicate entries (customer WhatsApp, category name)
  - [ ] Insufficient stock on sale
  - [ ] Invalid file uploads (size, type)

- [ ] **Task 8: Accessibility Tests** (AC: 10)
  - [ ] Screen reader compatibility
  - [ ] Keyboard navigation
  - [ ] Focus indicators
  - [ ] Color contrast ratios (WCAG AA)
  - [ ] Alt text on images

- [ ] **Task 9: Cross-Browser Tests** (AC: 9)
  - [ ] Safari iOS (latest 2 versions)
  - [ ] Chrome iOS
  - [ ] Test on iPhone SE, iPhone 13, iPhone Pro Max
  - [ ] PWA installation on iOS

- [ ] **Task 10: Load Tests** (AC: 12)
  - [ ] Simulate 10 concurrent users
  - [ ] Simulate 50 concurrent users
  - [ ] Test database query performance under load
  - [ ] Test Supabase connection limits

- [ ] **Task 11: CI/CD Integration** (AC: 6)
  - [ ] Configure GitHub Actions or similar
  - [ ] Run all tests on PR creation
  - [ ] Block merge if tests fail
  - [ ] Generate coverage reports
  - [ ] Automated deployment on main branch

## Dev Notes

[Source: docs/architecture/09-coding-standards.md lines 2073-2180]
- **Test Framework:** Vitest (unit), React Testing Library (component), Playwright (E2E)
- **Coverage Goals:** 75% overall, 90% business logic
- **Test Organization:** `__tests__/unit/`, `__tests__/integration/`, `__tests__/e2e/`

**Test Pyramid:**
- 70% unit tests (fast, isolated)
- 20% integration tests (database, API)
- 10% E2E tests (critical flows)

**Critical E2E Flows:**
1. Login → Dashboard → Create Customer → Create Product → Create Sale → Dashboard Updated
2. Create Sale with Installment → Verify Discount Calculated
3. Create Sale → Verify Inventory Decremented → Verify Customer Updated

**Test Data Management:**
- Use test database (Supabase staging)
- Seed data before tests
- Clean up after tests
- Mock external APIs

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-07 | v1.0 | Comprehensive Testing & QA story | Bob (Scrum Master) |

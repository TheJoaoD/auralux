# Story 1.3: Customer Management - Registration, Gallery & Search

## Status
**Draft**

## Story

**As a** store owner,
**I want** to register customers with their name and WhatsApp, view them in an attractive gallery, and search/filter my customer base,
**so that** I can manage my customer relationships and quickly select customers for sales transactions.

## Acceptance Criteria

1. Customer registration modal/form with full name and WhatsApp fields
2. WhatsApp number validation (Brazilian format: +55 XX XXXXX-XXXX or XX XXXXX-XXXX)
3. Customer data persists in Supabase customers table with proper RLS
4. "

+ Novo Cliente" button prominently displayed above customer gallery
5. Customer gallery displays all customers in card-based layout
6. Each customer card shows: full name, WhatsApp, and purchase count
7. Total customer count metric displayed at top of screen
8. Search functionality filters customers by name or WhatsApp
9. Real-time updates when new customer added (optimistic UI)
10. Form validation with error messages for invalid inputs
11. Success feedback on customer creation (toast notification)
12. Loading states during data fetching and submission
13. Empty state when no customers exist
14. Mobile-optimized card layout (responsive grid)
15. Proper error handling for duplicate WhatsApp numbers

## Tasks / Subtasks

- [ ] **Task 1: Customer Data Service** (AC: 3, 15)
  - [ ] Create `lib/services/customerService.ts` with CRUD operations
  - [ ] Implement `createCustomer(data: CustomerInput): Promise<Customer>`
    - Validate input with Zod schema
    - Insert into customers table via Supabase client
    - Return created customer object
    - Handle duplicate WhatsApp error (unique constraint)
  - [ ] Implement `getCustomers(userId: string): Promise<Customer[]>`
    - Query customers table with RLS (auto-filtered by user_id)
    - Order by created_at DESC
    - Return array of customers
  - [ ] Implement `searchCustomers(userId: string, query: string): Promise<Customer[]>`
    - Use Supabase .ilike() for case-insensitive search
    - Search in full_name and whatsapp fields
    - Return filtered results
  - [ ] Implement `getCustomerById(id: string): Promise<Customer>`
    - Query single customer by ID
    - Verify RLS enforcement
  - [ ] Add TypeScript types in `types/index.ts`:
    ```typescript
    export interface Customer {
      id: string;
      user_id: string;
      full_name: string;
      whatsapp: string;
      email?: string;
      address?: string;
      purchase_count: number;
      total_purchases: number;
      total_due: number;
      created_at: string;
      updated_at: string;
    }

    export interface CustomerInput {
      full_name: string;
      whatsapp: string;
      email?: string;
      address?: string;
    }
    ```

- [ ] **Task 2: Customer Form Validation** (AC: 2, 10)
  - [ ] Create `lib/validations/customerSchemas.ts`
  - [ ] Define Zod schema for customer creation:
    ```typescript
    export const customerSchema = z.object({
      full_name: z
        .string()
        .min(3, 'Nome deve ter no mínimo 3 caracteres')
        .max(100, 'Nome muito longo'),
      whatsapp: z
        .string()
        .regex(
          /^(?:\+55\s?)?(?:\(?\d{2}\)?\s?)?\d{4,5}-?\d{4}$/,
          'WhatsApp inválido. Use formato: (XX) XXXXX-XXXX'
        ),
      email: z.string().email('Email inválido').optional().or(z.literal('')),
      address: z.string().max(200).optional()
    });
    ```
  - [ ] Create WhatsApp formatter utility:
    - Remove all non-digits from input
    - Format as (XX) XXXXX-XXXX for display
    - Store formatted value in database

- [ ] **Task 3: Customer Registration Modal** (AC: 1, 4, 9, 10, 11)
  - [ ] Create `components/customers/AddCustomerModal.tsx`
  - [ ] Use shadcn/ui Dialog component for modal
  - [ ] Create form with React Hook Form + Zod validation:
    - Full Name input (text)
    - WhatsApp input (tel type with format mask)
    - Email input (optional)
    - Address textarea (optional)
  - [ ] Style form with Auralux color scheme:
    - Modal background: Off-White (#F7F5F2)
    - Input labels: Taupe/Greige (#A1887F)
    - Input borders: Taupe/Greige with Rosa Queimado focus
    - Primary button: Rosa Queimado (#C49A9A)
    - Cancel button: Taupe/Greige outline
  - [ ] Add "Salvar" (Save) and "Cancelar" (Cancel) buttons
  - [ ] Implement form submission:
    - Show loading state on Save button
    - Call customerService.createCustomer()
    - Handle success: show toast, close modal, reset form
    - Handle errors: show error toast with user-friendly message
    - Duplicate WhatsApp → "Cliente com este WhatsApp já existe"
  - [ ] Implement optimistic UI update:
    - Add customer to list immediately
    - Rollback on error
  - [ ] Add WhatsApp input formatting on change
  - [ ] Validate on blur and on submit

- [ ] **Task 4: Customer Gallery Component** (AC: 5, 6, 13, 14)
  - [ ] Create `components/customers/CustomerGallery.tsx`
  - [ ] Use React Query (TanStack Query) for data fetching:
    ```typescript
    const { data: customers, isLoading, error } = useQuery({
      queryKey: ['customers'],
      queryFn: () => customerService.getCustomers(user.id)
    });
    ```
  - [ ] Implement card-based grid layout:
    - Grid: 1 column on mobile, 2 columns on tablets
    - Card background: Taupe/Greige (#A1887F)
    - Card border radius: 12px
    - Card padding: 16px
    - Subtle shadow for depth
  - [ ] Display for each customer card:
    - Full name (heading, Areia color)
    - WhatsApp (body text, Areia with opacity)
    - Purchase count badge (Rosa Queimado background)
    - Icon: User icon from Lucide
  - [ ] Add click handler for future customer detail view
  - [ ] Implement loading state:
    - Show skeleton cards (3-4 placeholders)
    - Use Taupe/Greige shimmer effect
  - [ ] Implement empty state:
    - Icon: Users icon (large, Prata color)
    - Message: "Nenhum cliente cadastrado"
    - Subtitle: "Adicione seu primeiro cliente para começar"
    - Show "+ Novo Cliente" button
  - [ ] Handle error state:
    - Show error message with retry button
  - [ ] Make cards touch-optimized (minimum 44px height)

- [ ] **Task 5: Customers Page Implementation** (AC: 4, 7, 8, 12)
  - [ ] Update `app/customers/page.tsx` (created in Story 1.2)
  - [ ] Remove placeholder content
  - [ ] Implement page structure:
    - Header section with metrics and actions
    - Search bar
    - Customer gallery
  - [ ] Add total customer count metric:
    - Display in prominent card at top
    - Style: Taupe/Greige background, Areia text
    - Icon: Users icon in Rosa Queimado
    - Format: "X Clientes" (X being the count)
  - [ ] Add "+ Novo Cliente" button:
    - Position: Top right of header
    - Style: Rosa Queimado background, Carvão text
    - Icon: Plus icon
    - Opens AddCustomerModal on click
  - [ ] Implement search bar:
    - Input with search icon (Lucide Search)
    - Placeholder: "Buscar por nome ou WhatsApp..."
    - Debounced search (300ms delay)
    - Call searchCustomers() on input change
    - Clear button when search has value
    - Style: Off-White background, Taupe border
  - [ ] Handle search loading state:
    - Show spinner in search input
  - [ ] Integrate CustomerGallery component
  - [ ] Add page-level loading state (skeleton)
  - [ ] Use MainLayout wrapper from Story 1.2

- [ ] **Task 6: Real-time Updates with Supabase** (AC: 9)
  - [ ] Set up Supabase Realtime subscription in customers page:
    ```typescript
    useEffect(() => {
      const subscription = supabase
        .channel('customers-channel')
        .on(
          'postgres_changes',
          {
            event: 'INSERT',
            schema: 'public',
            table: 'customers',
            filter: `user_id=eq.${user.id}`
          },
          (payload) => {
            queryClient.invalidateQueries(['customers']);
          }
        )
        .subscribe();

      return () => {
        subscription.unsubscribe();
      };
    }, [user.id]);
    ```
  - [ ] Invalidate React Query cache on new customer insert
  - [ ] Test real-time updates by adding customer in another tab

- [ ] **Task 7: Testing & Verification** (AC: All)
  - [ ] Test customer creation with valid data
  - [ ] Test customer creation with invalid WhatsApp format
  - [ ] Test duplicate WhatsApp error handling
  - [ ] Test search functionality (by name and WhatsApp)
  - [ ] Test empty state display
  - [ ] Test loading states (gallery load, form submission, search)
  - [ ] Test responsive layout on different screen sizes
  - [ ] Test real-time updates
  - [ ] Verify RLS policies prevent cross-user data access
  - [ ] Write unit tests:
    - customerSchema validation
    - WhatsApp formatter utility
  - [ ] Write integration tests:
    - createCustomer service method
    - getCustomers with RLS
    - searchCustomers query
  - [ ] Write component tests:
    - AddCustomerModal form validation
    - CustomerGallery rendering
  - [ ] Document any issues or deviations

## Dev Notes

### Customer Data Model
[Source: docs/architecture/02-data-models.md - Customer section]

**Customer Entity:**
- Primary Key: `id` (UUID)
- Foreign Key: `user_id` → users.id (CASCADE on delete)
- Required: `full_name`, `whatsapp`
- Optional: `email`, `address`
- Auto-computed: `purchase_count`, `total_purchases` (updated via triggers)
- Unique Constraint: (user_id, whatsapp) - prevents duplicate WhatsApp per user

**Business Rules:**
- WhatsApp format: Brazilian format (+55 XX XXXXX-XXXX or XX XXXXX-XXXX)
- purchase_count initializes to 0 for new customers
- total_purchases initializes to 0.00
- Purchase metrics auto-increment on sale creation (handled by database trigger)
- RLS ensures user sees only their own customers

### Database Schema
[Source: docs/architecture/04-database-schema.md, docs/architecture.md lines 1085-1128]

**Customers Table:**
```sql
CREATE TABLE public.customers (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
  full_name TEXT NOT NULL,
  whatsapp TEXT NOT NULL,
  email TEXT,
  address TEXT,
  purchase_count INTEGER DEFAULT 0 NOT NULL CHECK (purchase_count >= 0),
  total_purchases DECIMAL(10,2) DEFAULT 0.00 NOT NULL,
  total_due DECIMAL(10,2) DEFAULT 0.00 NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,

  CONSTRAINT unique_whatsapp_per_user UNIQUE (user_id, whatsapp)
);

-- Indexes
CREATE INDEX idx_customers_user_id ON public.customers(user_id);
CREATE INDEX idx_customers_whatsapp ON public.customers(whatsapp);
CREATE INDEX idx_customers_full_name ON public.customers USING gin(to_tsvector('portuguese', full_name));
```

**RLS Policies:**
- Users can view own customers: `auth.uid() = user_id`
- Users can insert own customers: `auth.uid() = user_id`
- Users can update own customers: `auth.uid() = user_id`
- Users can delete own customers: `auth.uid() = user_id`

### UI/UX Design Specifications
[Source: docs/epics/01-ui-ux-guidelines.md - Customer Management Screen]

**Customer Gallery Design:**
- Card-based grid layout (1 column mobile, 2 columns tablet+)
- Card background: Taupe/Greige (#A1887F)
- Card border-radius: 12px
- Card padding: 16px
- Shadow: subtle elevation
- Customer name: Areia (#E0DCD1), font-semibold, 18px
- WhatsApp: Areia (#E0DCD1) 70% opacity, 14px
- Purchase count badge: Rosa Queimado (#C49A9A) background, Carvão text

**Header Section:**
- Background: Carvão (#202020)
- Total customers metric card:
  - Background: Taupe/Greige (#A1887F)
  - Icon: Users (Rosa Queimado)
  - Number: Large, Areia color
  - Label: "Clientes", Areia 70% opacity
- "+ Novo Cliente" button: Rosa Queimado background, Carvão text

**Search Bar:**
- Background: Off-White (#F7F5F2)
- Border: Taupe/Greige (#A1887F)
- Focus border: Rosa Queimado (#C49A9A)
- Icon: Search (Taupe/Greige)
- Placeholder: Taupe/Greige 60% opacity

**Empty State:**
- Icon: Users (Prata #BDBDBD, 64px)
- Message: Areia (#E0DCD1), 20px
- Subtitle: Areia 70% opacity, 14px

### Functional Requirements
[Source: docs/epics/00-prd-core.md FR1-FR5]
- FR1: Customer registration form with full name and WhatsApp
- FR2: Customer gallery showing name and purchase count
- FR3: Total registered customer count metric
- FR4: Search and filter customers
- FR5: WhatsApp number validation

### Service Architecture
[Source: docs/architecture/03-services.md]
- Services handle all business logic and database operations
- Use Supabase JS client for database queries
- Return typed responses (TypeScript interfaces)
- Handle errors and return meaningful messages

**Service Pattern:**
```typescript
export class CustomerService {
  constructor(private supabase: SupabaseClient) {}

  async createCustomer(input: CustomerInput): Promise<Customer> {
    try {
      const { data, error } = await this.supabase
        .from('customers')
        .insert({
          ...input,
          user_id: (await this.supabase.auth.getUser()).data.user?.id
        })
        .select()
        .single();

      if (error) throw error;
      return data;
    } catch (error) {
      if (error.code === '23505') { // Unique constraint violation
        throw new Error('Cliente com este WhatsApp já existe');
      }
      throw error;
    }
  }
}
```

### React Query Integration
[Source: docs/architecture/01-tech-stack.md]
- Use TanStack Query (React Query) 5.x for server state management
- Never store server data in React useState
- Automatic caching, refetching, and background updates
- Optimistic updates for better UX

**Query Pattern:**
```typescript
const { data, isLoading, error } = useQuery({
  queryKey: ['customers'],
  queryFn: () => customerService.getCustomers(user.id),
  staleTime: 60000, // 1 minute
});

const mutation = useMutation({
  mutationFn: customerService.createCustomer,
  onSuccess: () => {
    queryClient.invalidateQueries(['customers']);
  },
});
```

### Form Validation
[Source: docs/architecture/01-tech-stack.md]
- Use React Hook Form 7.x for form management
- Use Zod for schema validation
- Validate on blur and on submit
- Display errors inline below fields

### WhatsApp Validation & Formatting
**Brazilian WhatsApp Format:**
- Optional country code: +55
- Area code: 2 digits (e.g., 11, 21, 85)
- Number: 9 digits (starting with 9) or 8 digits (landline)
- Common formats:
  - (11) 98765-4321
  - 11 98765-4321
  - +55 11 98765-4321
  - 11987654321

**Formatter Utility:**
```typescript
export function formatWhatsApp(value: string): string {
  const digits = value.replace(/\D/g, '');

  if (digits.length === 11) {
    return digits.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
  }

  return value;
}

export function normalizeWhatsApp(value: string): string {
  return value.replace(/\D/g, '');
}
```

### Real-time Updates
[Source: docs/architecture/00-overview.md, docs/architecture/01-tech-stack.md]
- Use Supabase Realtime for live updates
- Subscribe to postgres_changes events
- Invalidate React Query cache on data changes
- Filter subscriptions by user_id to receive only own data

### File Structure
[Source: docs/architecture/08-source-tree.md]
```
app/
  customers/
    page.tsx                  # Main customers page

components/
  customers/
    AddCustomerModal.tsx      # Customer registration modal
    CustomerGallery.tsx       # Customer cards grid
    CustomerCard.tsx          # Individual customer card

lib/
  services/
    customerService.ts        # Customer CRUD operations
  validations/
    customerSchemas.ts        # Zod validation schemas
  utils/
    formatters.ts             # WhatsApp formatter

types/
  index.ts                    # Customer TypeScript interfaces

__tests__/
  unit/
    services/
      customerService.test.ts
    validations/
      customerSchemas.test.ts
    utils/
      formatters.test.ts
  integration/
    customers/
      customer-crud.test.ts
  components/
    customers/
      AddCustomerModal.test.tsx
      CustomerGallery.test.tsx
```

### Error Handling
[Source: docs/architecture/09-coding-standards.md]
- Always handle async errors with try-catch
- Display user-friendly error messages
- Use toast notifications for feedback
- Log errors in development mode only

**Error Message Mapping:**
```typescript
const CUSTOMER_ERROR_MESSAGES = {
  '23505': 'Cliente com este WhatsApp já existe',
  'PGRST116': 'Cliente não encontrado',
  default: 'Erro ao processar solicitação. Tente novamente'
};
```

### Testing

[Source: docs/architecture/09-coding-standards.md lines 2089-2180]

**Unit Tests:**
- customerSchema validation (valid/invalid inputs)
- WhatsApp formatter utility (various formats)
- Service methods with mocked Supabase client

**Integration Tests:**
- createCustomer with database
- Duplicate WhatsApp constraint
- RLS policy enforcement (cross-user data isolation)
- Search functionality

**Component Tests:**
- AddCustomerModal form validation
- Form submission success/error flows
- CustomerGallery rendering with data/loading/empty states

**Test Coverage Goal:** 80% for services, 70% for components

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-07 | v1.0 | Initial story creation for Customer Management | Bob (Scrum Master) |

---

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

---

## QA Results

*This section will be populated by the QA Agent after implementation.*

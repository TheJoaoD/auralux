# Story 1.7: New Sale Flow - Customer and Product Selection (Steps 1-2)

## Status
**Draft**

## Story

**As a** store owner,
**I want** to create a new sale by selecting a customer and adding multiple products with quantities to a cart,
**so that** I can efficiently build sale transactions before choosing payment method.

## Acceptance Criteria

1. "+ Nova Venda" button opens new sale modal/wizard
2. Multi-step wizard UI with progress indicator (Step 1, Step 2, Step 3)
3. **Step 1 - Customer Selection:**
   - Searchable customer dropdown/selector
   - Display customer name and WhatsApp
   - Search filters customers in real-time
   - Option to create new customer inline (opens AddCustomerModal)
   - "Próximo" (Next) button disabled until customer selected
4. **Step 2 - Product Selection:**
   - Product search/filter input
   - Product grid showing image, name, price, available quantity
   - Add to cart button on each product
   - Quantity selector for each product (1 to available stock)
   - Running cart display showing:
     - Selected products list
     - Quantity per product
     - Subtotal per product
     - Running total
   - Remove product from cart button
   - Update quantity in cart
   - Validation: cannot exceed available stock
   - "Voltar" (Back) button to return to Step 1
   - "Próximo" (Next) button to proceed to Step 3 (payment)
   - "Próximo" disabled if cart is empty
5. Form state persists when navigating between steps
6. Loading states during customer/product data fetching
7. Empty state for products (prompt to add products first)
8. Visual feedback for all interactions (hover, click, add to cart animation)
9. Touch-optimized for mobile (all buttons 44x44pt minimum)
10. Responsive layout (modal full-screen on mobile, centered on desktop)

## Tasks / Subtasks

- [ ] **Task 1: Sale Creation State Management** (AC: 5)
  - [ ] Create `lib/hooks/useSaleWizard.ts` custom hook for wizard state
  - [ ] Manage wizard state:
    ```typescript
    interface SaleWizardState {
      currentStep: 1 | 2 | 3; // Steps: Customer, Products, Payment
      selectedCustomer: Customer | null;
      cartItems: CartItem[];
      paymentMethod: PaymentMethod | null;
      installmentCount?: number;
      actualAmountReceived?: number;
    }

    interface CartItem {
      product: Product;
      quantity: number;
      subtotal: number;
    }
    ```
  - [ ] Implement state actions:
    - `setCustomer(customer: Customer)`
    - `addToCart(product: Product, quantity: number)`
    - `updateCartQuantity(productId: string, quantity: number)`
    - `removeFromCart(productId: string)`
    - `goToStep(step: number)`
    - `resetWizard()`
  - [ ] Calculate cart total:
    ```typescript
    const cartTotal = cartItems.reduce((sum, item) => sum + item.subtotal, 0);
    ```
  - [ ] Validate step navigation (can't go to step 2 without customer, etc.)
  - [ ] Persist state in React Context or Zustand store

- [ ] **Task 2: Sale Wizard Modal Structure** (AC: 1, 2, 10)
  - [ ] Create `components/sales/NewSaleWizard.tsx` main modal
  - [ ] Use shadcn/ui Dialog component (full-screen on mobile)
  - [ ] Implement step progress indicator:
    - Step 1: "Cliente" (active/completed/pending states)
    - Step 2: "Produtos" (active/completed/pending states)
    - Step 3: "Pagamento" (active/completed/pending states)
  - [ ] Style progress indicator:
    - Active step: Rosa Queimado (#C49A9A) background
    - Completed step: Rosa Queimado with checkmark icon
    - Pending step: Taupe/Greige (#A1887F) background
    - Connector lines between steps
  - [ ] Render current step content based on `currentStep` state
  - [ ] Modal styling:
    - Mobile: Full screen, Carvão background
    - Desktop: Max-width 800px, centered, Off-White background
    - Close button (X icon) top right
  - [ ] Handle modal close:
    - Show confirmation dialog if cart has items
    - Reset wizard state on close

- [ ] **Task 3: Step 1 - Customer Selection Component** (AC: 3, 6)
  - [ ] Create `components/sales/CustomerSelectionStep.tsx`
  - [ ] Implement searchable customer selector:
    - Use Combobox component (shadcn/ui Command + Popover)
    - Fetch customers via React Query
    - Filter customers by name or WhatsApp as user types
    - Display: Customer name (bold) + WhatsApp (secondary)
  - [ ] Add "+ Novo Cliente" option in dropdown
    - Opens AddCustomerModal (from Story 1.3) inline
    - On customer creation, auto-select new customer
    - Close AddCustomerModal, return to wizard
  - [ ] Display selected customer:
    - Card with customer name, WhatsApp, purchase history
    - "Alterar Cliente" button to reopen selector
  - [ ] Add "Próximo" button:
    - Disabled if no customer selected
    - On click: setCurrentStep(2)
    - Style: Rosa Queimado background, full width mobile
  - [ ] Loading state: Skeleton for customer selector
  - [ ] Style with Auralux colors:
    - Container: Off-White (#F7F5F2) on desktop
    - Selected customer card: Taupe/Greige (#A1887F)

- [ ] **Task 4: Step 2 - Product Selection Component** (AC: 4, 7, 8)
  - [ ] Create `components/sales/ProductSelectionStep.tsx`
  - [ ] Implement product search:
    - Search input at top
    - Filter products by name in real-time
    - Use existing products from React Query (cached from Story 1.4)
  - [ ] Display product grid:
    - Grid layout: 2 columns mobile, 3 columns tablet, 4 desktop
    - Each product card shows:
      - Image (or placeholder)
      - Name (truncate if long)
      - Price (R$ formatted, Rosa Queimado)
      - Available quantity badge (e.g., "12 disponíveis")
      - "+" button to add to cart
  - [ ] Style product cards:
    - Background: Taupe/Greige (#A1887F)
    - Border-radius: 12px
    - Add button: Rosa Queimado, circular, bottom right
    - Out of stock: Disabled, greyed out, "Sem estoque" badge
  - [ ] Handle add to cart:
    - Click "+" → Open quantity selector modal or inline
    - Default quantity: 1
    - Max quantity: product.quantity (available stock)
    - "Adicionar" button adds to cart
    - Show success feedback (toast or cart highlight animation)
  - [ ] Loading state: Skeleton product cards
  - [ ] Empty state:
    - Icon: Package (Prata, 64px)
    - Message: "Nenhum produto disponível"
    - Subtitle: "Adicione produtos no estoque para criar vendas"
    - Link to inventory page

- [ ] **Task 5: Shopping Cart Component** (AC: 4)
  - [ ] Create `components/sales/ShoppingCart.tsx` (sidebar or bottom sheet)
  - [ ] Display cart items:
    - List of selected products
    - Each item shows:
      - Product name
      - Quantity selector (- and + buttons, current quantity)
      - Unit price
      - Subtotal (quantity × price)
      - Remove button (trash icon)
  - [ ] Implement quantity update:
    - "+" button: increment quantity (max: available stock)
    - "-" button: decrement quantity (min: 1)
    - Direct input: allow typing quantity (validate on blur)
    - Update subtotal in real-time
  - [ ] Implement remove from cart:
    - Trash icon button
    - Remove item from cartItems array
    - Show undo toast (optional enhancement)
  - [ ] Display cart summary:
    - Separator line
    - "Total:" label (Areia, font-semibold)
    - Total amount (R$ formatted, Rosa Queimado, large, bold)
    - Item count: "X itens" (Areia 60% opacity)
  - [ ] Style cart:
    - Container: Off-White (#F7F5F2) on desktop, full-width drawer on mobile
    - Items: Taupe/Greige cards, 8px radius
    - Quantity buttons: Circular, Rosa Queimado outline
    - Total section: Taupe/Greige background, prominent
  - [ ] Empty cart state:
    - Icon: ShoppingCart (Prata)
    - Message: "Carrinho vazio"
    - Subtitle: "Adicione produtos para continuar"
  - [ ] Sticky position (visible while scrolling products)

- [ ] **Task 6: Navigation Buttons** (AC: 4)
  - [ ] Add navigation buttons to ProductSelectionStep footer:
    - "Voltar" button (left):
      - Outline style, Taupe/Greige
      - On click: setCurrentStep(1)
    - "Próximo" button (right):
      - Rosa Queimado background
      - Disabled if cartItems.length === 0
      - On click: setCurrentStep(3) → Goes to Story 1.8
  - [ ] Button layout:
    - Mobile: Full-width buttons, stacked or side-by-side
    - Desktop: Right-aligned, side-by-side
  - [ ] Touch-optimized: Minimum 44x44pt

- [ ] **Task 7: Quantity Selector Modal/Component** (AC: 4, 8)
  - [ ] Create `components/sales/QuantitySelector.tsx`
  - [ ] Use as modal or inline input
  - [ ] Show product details:
    - Product name
    - Price
    - Available stock: "X disponíveis"
  - [ ] Quantity input:
    - Number input with +/- buttons
    - Validate: 1 <= quantity <= available stock
    - Show error if exceeds stock: "Apenas X disponíveis"
  - [ ] "Adicionar ao Carrinho" button:
    - Calls addToCart(product, quantity)
    - Closes modal/selector
    - Shows success feedback
  - [ ] "Cancelar" button
  - [ ] Style: Off-White background, Rosa Queimado accents

- [ ] **Task 8: Integration with Existing Components** (AC: 3)
  - [ ] Ensure AddCustomerModal (Story 1.3) can be opened from wizard
  - [ ] Pass callback to AddCustomerModal for inline customer creation:
    ```typescript
    <AddCustomerModal
      isOpen={isAddCustomerOpen}
      onClose={() => setIsAddCustomerOpen(false)}
      onCustomerCreated={(newCustomer) => {
        setCustomer(newCustomer);
        setIsAddCustomerOpen(false);
      }}
    />
    ```
  - [ ] Invalidate customers query cache on new customer creation
  - [ ] Auto-select newly created customer in wizard

- [ ] **Task 9: Validation and Error Handling** (AC: 4)
  - [ ] Validate step transitions:
    - Step 1 → 2: Require customer selected
    - Step 2 → 3: Require at least one cart item
  - [ ] Validate product quantities:
    - Cannot add more than available stock
    - Show error toast: "Apenas X unidades disponíveis"
  - [ ] Handle sold-out products:
    - Disable "+" button
    - Grey out card
    - Badge: "Sem estoque"
  - [ ] Handle empty products list:
    - Show empty state
    - Link to inventory management page

- [ ] **Task 10: Testing & Verification** (AC: All)
  - [ ] Test full wizard flow: Select customer → Add products → Navigate
  - [ ] Test customer search/filter functionality
  - [ ] Test inline customer creation
  - [ ] Test add to cart with various quantities
  - [ ] Test cart quantity update (increment, decrement, direct input)
  - [ ] Test remove from cart
  - [ ] Test cart total calculation accuracy
  - [ ] Test stock quantity validation (cannot exceed available)
  - [ ] Test navigation between steps (back/forward)
  - [ ] Test wizard close confirmation when cart has items
  - [ ] Test responsive layout (mobile, tablet, desktop)
  - [ ] Test empty states (no customers, no products, empty cart)
  - [ ] Verify touch targets >= 44x44pt
  - [ ] Write unit tests:
    - useSaleWizard hook state management
    - Cart total calculation
    - Quantity validation logic
  - [ ] Write integration tests:
    - Customer search/filter
    - Add to cart flow
  - [ ] Write component tests:
    - CustomerSelectionStep rendering
    - ProductSelectionStep grid
    - ShoppingCart calculations
  - [ ] Document any issues or deviations

## Dev Notes

### Sale Creation Workflow
[Source: docs/epics/01-ui-ux-guidelines.md - New Sale Modal/Screen]

**Multi-Step Flow:**
1. **Step 1:** Customer selection (searchable dropdown) → Story 1.7
2. **Step 2:** Product selection (multiple, with quantity) → Story 1.7
3. **Step 3:** Payment method selection → Story 1.8
4. **Step 4:** If "Parcelado" → Popup for actual amount → Story 1.8
5. **Step 5:** Confirmation and sale completion → Story 1.8

This story (1.7) covers Steps 1-2. Story 1.8 covers Steps 3-5.

### Functional Requirements
[Source: docs/epics/00-prd-core.md FR7-FR9]
- FR7: "+ Nova Venda" button prominently above dashboard
- FR8: Allow selection of registered customer for each sale
- FR9: Allow adding multiple products to sale transaction

[Source: docs/epics/epic-01-mvp.md Story 1.9]
Story 1.9 in original epic: New Sale Flow - Customer and Product Selection

### Sale Data Model (Preview)
[Source: docs/architecture/02-data-models.md - Sale, SaleItem]

While sale won't be created until Story 1.8, understanding the model helps with cart structure:

**Sale Structure:**
- One Sale → Many SaleItems
- Each SaleItem snapshots: product_name, unit_price, unit_cost, quantity
- Sale has: customer_id, total_amount, payment_method, etc.

**Cart Item Structure (Wizard State):**
```typescript
interface CartItem {
  product: Product; // Full product object for display
  quantity: number; // Quantity being purchased
  subtotal: number; // quantity × product.sale_price
}
```

This will map to SaleItem in Story 1.8 when sale is created.

### UI/UX Design - New Sale Wizard
[Source: docs/epics/01-ui-ux-guidelines.md]

**Wizard Modal:**
- Mobile: Full-screen overlay, Carvão (#202020) background
- Desktop: Max-width 800px, centered, Off-White (#F7F5F2) background
- Border-radius: 16px (desktop only)
- Close button: X icon, top right, Areia color

**Progress Indicator:**
- Horizontal step bar at top
- Active step: Rosa Queimado (#C49A9A) circle with white number
- Completed step: Rosa Queimado with white checkmark icon
- Pending step: Taupe/Greige (#A1887F) circle with grey number
- Connector lines: Taupe/Greige between steps

**Customer Selector (Step 1):**
- Combobox/dropdown: Off-White background, Taupe border
- Focused: Rosa Queimado border
- Options: Hover Taupe/Greige background
- Selected customer card: Taupe/Greige background, Areia text
- "+ Novo Cliente" option: Rosa Queimado text, icon

**Product Grid (Step 2):**
- Grid spacing: 12px gap
- Product cards: Taupe/Greige (#A1887F), border-radius 12px
- Image: 120px square, cover fit
- Name: Areia, 14px, truncate 2 lines
- Price: Rosa Queimado, 16px, font-semibold
- Stock badge: Areia 60% opacity, 12px
- "+" button: Rosa Queimado background, white icon, 40px circle

**Shopping Cart (Sidebar):**
- Background: Off-White (#F7F5F2)
- Width: 320px (desktop), full-width drawer (mobile)
- Cart items: Taupe/Greige (#A1887F) cards
- Quantity buttons: Circular, Rosa Queimado outline, 32px
- Remove button: #C76A6A (warning red), trash icon
- Total section: Prominent, Taupe/Greige background, padding 16px
- Total amount: Rosa Queimado, 24px, font-bold

**Navigation Buttons:**
- "Voltar": Taupe/Greige outline, Areia text
- "Próximo": Rosa Queimado background, Carvão text
- Height: 48px (touch-optimized)
- Full-width mobile, auto-width desktop

### State Management
[Source: docs/architecture/01-tech-stack.md]
- Use Zustand or React Context for wizard state
- State persists during wizard navigation
- Reset state on wizard close or sale completion

**Zustand Store Example:**
```typescript
// lib/stores/saleWizardStore.ts
import create from 'zustand';

interface SaleWizardStore {
  currentStep: 1 | 2 | 3;
  selectedCustomer: Customer | null;
  cartItems: CartItem[];
  setCustomer: (customer: Customer) => void;
  addToCart: (product: Product, quantity: number) => void;
  updateCartQuantity: (productId: string, quantity: number) => void;
  removeFromCart: (productId: string) => void;
  goToStep: (step: number) => void;
  resetWizard: () => void;
}

export const useSaleWizardStore = create<SaleWizardStore>((set) => ({
  currentStep: 1,
  selectedCustomer: null,
  cartItems: [],
  setCustomer: (customer) => set({ selectedCustomer: customer, currentStep: 2 }),
  addToCart: (product, quantity) => set((state) => ({
    cartItems: [...state.cartItems, {
      product,
      quantity,
      subtotal: product.sale_price * quantity
    }]
  })),
  // ... other actions
  resetWizard: () => set({
    currentStep: 1,
    selectedCustomer: null,
    cartItems: []
  }),
}));
```

### Product Search/Filter
Use existing product data from React Query cache (Story 1.4):
```typescript
const { data: products } = useQuery({
  queryKey: ['products'],
  queryFn: () => productService.getProducts(user.id)
});

// Filter in component
const filteredProducts = products?.filter(p =>
  p.name.toLowerCase().includes(searchQuery.toLowerCase())
);
```

### Stock Validation
**Critical Business Rule:**
- Cannot sell more than available quantity
- Validate on add to cart and quantity update
- Show user-friendly error: "Apenas X unidades disponíveis"

```typescript
function validateQuantity(product: Product, requestedQuantity: number): boolean {
  if (requestedQuantity > product.quantity) {
    toast.error(`Apenas ${product.quantity} unidades disponíveis`);
    return false;
  }
  return true;
}
```

### File Structure
```
app/
  dashboard/
    page.tsx                         # Has "+ Nova Venda" button that opens wizard

components/
  sales/
    NewSaleWizard.tsx                # Main wizard modal
    CustomerSelectionStep.tsx        # Step 1 component
    ProductSelectionStep.tsx         # Step 2 component
    ShoppingCart.tsx                 # Cart sidebar/drawer
    QuantitySelector.tsx             # Quantity input component

lib/
  stores/
    saleWizardStore.ts               # Zustand store for wizard state (or use Context)
  hooks/
    useSaleWizard.ts                 # Custom hook wrapping store

__tests__/
  unit/
    stores/
      saleWizardStore.test.ts
  components/
    sales/
      CustomerSelectionStep.test.tsx
      ProductSelectionStep.test.tsx
      ShoppingCart.test.tsx
```

### Accessibility & UX
- All interactive elements minimum 44x44pt (iOS HIG)
- Keyboard navigation support (tab through fields)
- Focus visible indicators (Rosa Queimado outline)
- Screen reader labels on all buttons/inputs
- Loading states for all async operations
- Error messages clear and actionable

### Testing

**Unit Tests:**
- useSaleWizardStore state mutations
- Cart total calculation: SUM(quantity × price)
- Quantity validation logic

**Integration Tests:**
- Customer search/filter across wizard
- Add to cart → Update cart → Remove from cart flow
- Step navigation with validation

**Component Tests:**
- CustomerSelectionStep renders customers
- ProductSelectionStep filters products correctly
- ShoppingCart calculates totals accurately
- QuantitySelector enforces max quantity

**E2E Test (Story 1.12):**
- Full sale creation: Select customer → Add products → Complete payment

**Test Coverage Goal:** 80% for wizard logic and components

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-07 | v1.0 | Initial story creation for New Sale Flow (Steps 1-2) | Bob (Scrum Master) |

---

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

---

## QA Results

*This section will be populated by the QA Agent after implementation.*

# Story 2.8: Integração com Detalhes do Cliente

## Status: Draft

## Story

**As a** administrador,
**I want** ver parcelas pendentes na ficha do cliente,
**so that** eu saiba a situação financeira de cada cliente.

## Acceptance Criteria

1. Página de detalhes do cliente exibe aba/seção "Parcelas"
2. Lista parcelas pendentes e histórico de pagas
3. Totalizador: "Deve: R$ X"
4. Indicador visual se cliente tem parcelas vencidas
5. Ação rápida para dar baixa direto da ficha do cliente
6. Campo `total_due` em customers atualizado automaticamente

## Integration Verification

- IV1: Página de cliente existente não quebra
- IV2: Performance mantida ao adicionar nova seção
- IV3: Dados consistentes com tela de parcelas

## Tasks / Subtasks

- [ ] **Task 1: Adicionar coluna `total_due` em customers** (AC: 6)
  - [ ] Verificar se coluna já existe
  - [ ] Se não, criar migration: `ALTER TABLE customers ADD COLUMN total_due DECIMAL(10,2) DEFAULT 0`
  - [ ] Regenerar tipos TypeScript

- [ ] **Task 2: Criar/Verificar trigger para total_due** (AC: 6)
  - [ ] Verificar se trigger `update_customer_total_due` existe (Story 2.1)
  - [ ] Se não, criar função e trigger
  - [ ] Testar que atualiza ao inserir/pagar parcela

- [ ] **Task 3: Criar componente `CustomerInstallments`** (AC: 1, 2, 4)
  - [ ] Criar `components/clientes/CustomerInstallments.tsx`
  - [ ] Tabs ou accordion: Pendentes | Pagas
  - [ ] Lista de parcelas do cliente
  - [ ] Indicador de status por cores
  - [ ] Badge vermelho se há vencidas

- [ ] **Task 4: Criar componente `CustomerDebtSummary`** (AC: 3, 4)
  - [ ] Criar `components/clientes/CustomerDebtSummary.tsx`
  - [ ] Exibir "Deve: R$ X" em destaque
  - [ ] Cor vermelha se > 0 e tem vencidas
  - [ ] Cor laranja se > 0 sem vencidas
  - [ ] Cor verde se = 0

- [ ] **Task 5: Integrar na página de detalhes do cliente** (AC: 1, 2, 3, 4, 5)
  - [ ] Localizar página existente: `app/admin/clientes/[id]/page.tsx`
  - [ ] Adicionar CustomerDebtSummary no header/cards
  - [ ] Adicionar CustomerInstallments como seção/tab
  - [ ] Reutilizar PayInstallmentDialog da Story 2.5

- [ ] **Task 6: Adicionar indicador na lista de clientes** (AC: 4)
  - [ ] Localizar página de lista: `app/admin/clientes/page.tsx`
  - [ ] Adicionar badge/ícone se cliente tem parcelas vencidas
  - [ ] Adicionar coluna "Deve" na tabela (opcional)

- [ ] **Task 7: Criar hook `useCustomerInstallments`** (AC: 1, 2)
  - [ ] Hook para buscar parcelas do cliente
  - [ ] Cache com TanStack Query
  - [ ] Invalidar ao dar baixa

- [ ] **Task 8: Verificação de Integração** (IV1, IV2, IV3)
  - [ ] Testar página de cliente sem parcelas
  - [ ] Testar página de cliente com parcelas
  - [ ] Verificar que total_due = soma das pendentes
  - [ ] Medir performance

## Dev Notes

### Dependências

- **Requer**: Stories 2.1-2.7 completas
- **Modifica**: Página existente de clientes
- **Reutiliza**: PayInstallmentDialog da Story 2.5

### Coluna total_due

A coluna `total_due` e o trigger já devem existir da Story 2.1. Verificar com:

```sql
-- Verificar se coluna existe
SELECT column_name
FROM information_schema.columns
WHERE table_name = 'customers' AND column_name = 'total_due';

-- Verificar se trigger existe
SELECT trigger_name
FROM information_schema.triggers
WHERE trigger_name = 'trigger_customer_due_on_installment_change';
```

Se não existir, criar:

```sql
-- Adicionar coluna
ALTER TABLE customers
ADD COLUMN IF NOT EXISTS total_due DECIMAL(10,2) DEFAULT 0;

-- Função para atualizar total_due
CREATE OR REPLACE FUNCTION update_customer_total_due()
RETURNS TRIGGER AS $$
DECLARE
  customer_uuid UUID;
  new_total_due DECIMAL(10,2);
BEGIN
  SELECT customer_id INTO customer_uuid
  FROM sales
  WHERE id = COALESCE(NEW.sale_id, OLD.sale_id);

  IF customer_uuid IS NOT NULL THEN
    SELECT COALESCE(SUM(amount - paid_amount), 0)
    INTO new_total_due
    FROM sale_installments si
    JOIN sales s ON s.id = si.sale_id
    WHERE s.customer_id = customer_uuid
      AND si.status IN ('pending', 'partial', 'overdue');

    UPDATE customers
    SET
      total_due = new_total_due,
      updated_at = NOW()
    WHERE id = customer_uuid;
  END IF;

  RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Trigger
CREATE TRIGGER trigger_customer_due_on_installment_change
  AFTER INSERT OR UPDATE OR DELETE ON sale_installments
  FOR EACH ROW
  EXECUTE FUNCTION update_customer_total_due();
```

### Componente CustomerDebtSummary

```tsx
// components/clientes/CustomerDebtSummary.tsx
'use client'

import { Card, CardContent } from '@/components/ui/card'
import { AlertTriangle, CheckCircle, Clock } from 'lucide-react'
import { cn } from '@/lib/utils'

interface CustomerDebtSummaryProps {
  totalDue: number
  hasOverdue: boolean
}

export function CustomerDebtSummary({ totalDue, hasOverdue }: CustomerDebtSummaryProps) {
  const formatCurrency = (value: number) =>
    new Intl.NumberFormat('pt-BR', {
      style: 'currency',
      currency: 'BRL'
    }).format(value)

  const getStatus = () => {
    if (totalDue === 0) {
      return {
        label: 'Em dia',
        color: 'text-green-600',
        bgColor: 'bg-green-50',
        icon: CheckCircle
      }
    }
    if (hasOverdue) {
      return {
        label: 'Parcelas vencidas',
        color: 'text-red-600',
        bgColor: 'bg-red-50',
        icon: AlertTriangle
      }
    }
    return {
      label: 'Parcelas pendentes',
      color: 'text-orange-600',
      bgColor: 'bg-orange-50',
      icon: Clock
    }
  }

  const status = getStatus()
  const Icon = status.icon

  return (
    <Card className={cn('border-l-4', {
      'border-l-green-500': totalDue === 0,
      'border-l-red-500': hasOverdue,
      'border-l-orange-500': totalDue > 0 && !hasOverdue
    })}>
      <CardContent className={cn('p-4', status.bgColor)}>
        <div className="flex items-center justify-between">
          <div>
            <p className="text-sm text-muted-foreground">Situação Financeira</p>
            <p className={cn('text-2xl font-bold', status.color)}>
              {totalDue > 0 ? `Deve: ${formatCurrency(totalDue)}` : 'Sem pendências'}
            </p>
          </div>
          <div className="flex items-center gap-2">
            <Icon className={cn('h-6 w-6', status.color)} />
            <span className={cn('text-sm font-medium', status.color)}>
              {status.label}
            </span>
          </div>
        </div>
      </CardContent>
    </Card>
  )
}
```

### Componente CustomerInstallments

```tsx
// components/clientes/CustomerInstallments.tsx
'use client'

import { useState } from 'react'
import { useQuery, useQueryClient } from '@tanstack/react-query'
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import { format, isPast } from 'date-fns'
import { ptBR } from 'date-fns/locale'
import {
  getInstallmentsByCustomer,
  Installment
} from '@/lib/services/installmentService'
import { PayInstallmentDialog } from '@/components/financeiro/PayInstallmentDialog'
import { toast } from 'sonner'

interface CustomerInstallmentsProps {
  customerId: string
}

export function CustomerInstallments({ customerId }: CustomerInstallmentsProps) {
  const queryClient = useQueryClient()
  const [selectedInstallment, setSelectedInstallment] = useState<Installment | null>(null)
  const [dialogOpen, setDialogOpen] = useState(false)

  const { data: installments, isLoading } = useQuery({
    queryKey: ['customer-installments', customerId],
    queryFn: () => getInstallmentsByCustomer(customerId)
  })

  const pendingInstallments = installments?.filter(
    i => ['pending', 'partial', 'overdue'].includes(i.status)
  ) || []

  const paidInstallments = installments?.filter(
    i => i.status === 'paid'
  ) || []

  const formatCurrency = (value: number) =>
    new Intl.NumberFormat('pt-BR', {
      style: 'currency',
      currency: 'BRL'
    }).format(value)

  const getStatusBadge = (installment: Installment) => {
    const dueDate = new Date(installment.due_date)

    if (installment.status === 'paid') {
      return <Badge variant="success">Paga</Badge>
    }
    if (installment.status === 'overdue' || isPast(dueDate)) {
      return <Badge variant="destructive">Vencida</Badge>
    }
    if (installment.status === 'partial') {
      return <Badge variant="secondary">Parcial</Badge>
    }
    return <Badge variant="outline">Pendente</Badge>
  }

  const handlePayClick = (installment: Installment) => {
    setSelectedInstallment(installment)
    setDialogOpen(true)
  }

  const handlePaySuccess = () => {
    toast.success('Parcela paga com sucesso!')
    queryClient.invalidateQueries({ queryKey: ['customer-installments', customerId] })
    queryClient.invalidateQueries({ queryKey: ['customer', customerId] })
  }

  if (isLoading) {
    return <div className="animate-pulse h-40 bg-gray-200 rounded" />
  }

  const renderInstallmentList = (list: Installment[], showPayButton: boolean) => (
    <div className="space-y-2">
      {list.length === 0 ? (
        <p className="text-muted-foreground text-center py-4">
          Nenhuma parcela encontrada
        </p>
      ) : (
        list.map(installment => (
          <div
            key={installment.id}
            className="flex items-center justify-between p-3 border rounded-lg"
          >
            <div>
              <p className="font-medium">
                Parcela {installment.installment_number}
              </p>
              <p className="text-sm text-muted-foreground">
                {formatCurrency(installment.amount - installment.paid_amount)} •
                Vence: {format(new Date(installment.due_date), 'dd/MM/yyyy', { locale: ptBR })}
              </p>
            </div>

            <div className="flex items-center gap-2">
              {getStatusBadge(installment)}
              {showPayButton && installment.status !== 'paid' && (
                <Button
                  size="sm"
                  variant="outline"
                  onClick={() => handlePayClick(installment)}
                >
                  Dar baixa
                </Button>
              )}
            </div>
          </div>
        ))
      )}
    </div>
  )

  return (
    <>
      <Card>
        <CardHeader>
          <CardTitle>Parcelas do Cliente</CardTitle>
        </CardHeader>
        <CardContent>
          <Tabs defaultValue="pending">
            <TabsList className="grid w-full grid-cols-2">
              <TabsTrigger value="pending">
                Pendentes ({pendingInstallments.length})
              </TabsTrigger>
              <TabsTrigger value="paid">
                Pagas ({paidInstallments.length})
              </TabsTrigger>
            </TabsList>

            <TabsContent value="pending" className="mt-4">
              {renderInstallmentList(pendingInstallments, true)}
            </TabsContent>

            <TabsContent value="paid" className="mt-4">
              {renderInstallmentList(paidInstallments, false)}
            </TabsContent>
          </Tabs>
        </CardContent>
      </Card>

      <PayInstallmentDialog
        installment={selectedInstallment}
        open={dialogOpen}
        onOpenChange={setDialogOpen}
        onSuccess={handlePaySuccess}
      />
    </>
  )
}
```

### Integração na Página do Cliente

```tsx
// Exemplo de modificação em app/admin/clientes/[id]/page.tsx

// Adicionar imports
import { CustomerDebtSummary } from '@/components/clientes/CustomerDebtSummary'
import { CustomerInstallments } from '@/components/clientes/CustomerInstallments'

// Dentro do componente, buscar dados de parcelas
const { data: installments } = useQuery({
  queryKey: ['customer-installments', customer.id],
  queryFn: () => getInstallmentsByCustomer(customer.id)
})

const hasOverdue = installments?.some(
  i => i.status === 'overdue' || (i.status !== 'paid' && new Date(i.due_date) < new Date())
) || false

// Adicionar no JSX
<CustomerDebtSummary
  totalDue={customer.total_due || 0}
  hasOverdue={hasOverdue}
/>

// Mais abaixo na página
<CustomerInstallments customerId={customer.id} />
```

### Badge na Lista de Clientes

```tsx
// Em components/clientes/CustomerTable.tsx ou similar

// Adicionar coluna ou badge
{customer.total_due > 0 && (
  <Badge variant={hasOverdue ? 'destructive' : 'warning'}>
    {formatCurrency(customer.total_due)}
  </Badge>
)}
```

### Localização de Arquivos Existentes

Verificar estrutura atual:

```
app/admin/clientes/
├── page.tsx              # Lista de clientes
└── [id]/
    └── page.tsx          # Detalhes do cliente

components/
└── clientes/             # Criar se não existir
    ├── CustomerDebtSummary.tsx
    └── CustomerInstallments.tsx
```

### Testing

- Testar cliente sem parcelas (não deve quebrar)
- Testar cliente com parcelas pendentes
- Testar cliente com parcelas vencidas
- Testar dar baixa e verificar atualização de total_due
- Verificar consistência com página de parcelas
- Testar performance em cliente com muitas parcelas

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-29 | 1.0 | Story criada a partir do PRD | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
_A ser preenchido pelo dev agent_

### Debug Log References
_A ser preenchido pelo dev agent_

### Completion Notes
_A ser preenchido pelo dev agent_

### File List
_A ser preenchido pelo dev agent_

---

## QA Results
_A ser preenchido pelo QA agent_

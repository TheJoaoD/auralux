# Story 2.6: Dashboard de Fluxo de Caixa

## Status: Draft

## Story

**As a** administrador,
**I want** visualizar o fluxo de caixa em um dashboard,
**so that** eu tenha visão geral da saúde financeira do negócio.

## Acceptance Criteria

1. Página `/admin/financeiro` com visão consolidada
2. Card "Caixa Hoje" mostrando entradas do dia
3. Card "Caixa do Mês" mostrando entradas do mês atual
4. Card "A Receber" mostrando total de parcelas pendentes
5. Card "Vencidas" mostrando total de parcelas em atraso
6. Gráfico de linha com evolução do caixa (últimos 30 dias)
7. Lista de próximos vencimentos (7 dias)
8. Acesso rápido para dar baixa em parcelas

## Integration Verification

- IV1: Dashboard principal de vendas continua funcionando
- IV2: Dados são consistentes entre dashboard de vendas e financeiro
- IV3: Performance adequada (< 2s para carregar)

## Tasks / Subtasks

- [ ] **Task 1: Criar página do Dashboard Financeiro** (AC: 1)
  - [ ] Criar `app/admin/financeiro/page.tsx`
  - [ ] Layout com grid responsivo
  - [ ] Título "Dashboard Financeiro"

- [ ] **Task 2: Criar componente `CashFlowMetricsCards`** (AC: 2, 3, 4, 5)
  - [ ] Criar `components/financeiro/CashFlowMetricsCards.tsx`
  - [ ] Card "Caixa Hoje": valor com ícone de dinheiro
  - [ ] Card "Caixa do Mês": valor com ícone de calendário
  - [ ] Card "A Receber": valor com ícone de clock, link para parcelas
  - [ ] Card "Vencidas": valor em vermelho com ícone de alerta, link para parcelas vencidas
  - [ ] Usar dados de `getCashFlowMetrics()`

- [ ] **Task 3: Criar componente `CashFlowChart`** (AC: 6)
  - [ ] Criar `components/financeiro/CashFlowChart.tsx`
  - [ ] Usar Recharts (LineChart)
  - [ ] Eixo X: datas dos últimos 30 dias
  - [ ] Eixo Y: valores em R$
  - [ ] Linha de entrada (verde)
  - [ ] Tooltip com valor e data
  - [ ] Usar dados de `getCashFlowGrouped()`

- [ ] **Task 4: Criar componente `UpcomingInstallments`** (AC: 7, 8)
  - [ ] Criar `components/financeiro/UpcomingInstallments.tsx`
  - [ ] Lista compacta de parcelas a vencer nos próximos 7 dias
  - [ ] Mostrar: cliente, valor, data de vencimento
  - [ ] Indicador visual por proximidade (amarelo/laranja)
  - [ ] Botão "Dar baixa" em cada item
  - [ ] Link "Ver todas" para página de parcelas

- [ ] **Task 5: Implementar página principal** (AC: 1-8)
  - [ ] Integrar todos os componentes
  - [ ] Layout: Cards no topo, Gráfico no meio, Lista abaixo
  - [ ] TanStack Query para fetch paralelo
  - [ ] Skeleton loading durante carregamento
  - [ ] Atualização ao dar baixa

- [ ] **Task 6: Criar navegação entre módulos** (AC: 1)
  - [ ] Link para `/admin/financeiro/parcelas`
  - [ ] Link para `/admin/financeiro/fluxo-caixa` (extrato)
  - [ ] Tabs ou botões de navegação rápida

- [ ] **Task 7: Adicionar ao menu admin** (IV1)
  - [ ] Localizar componente de sidebar/menu
  - [ ] Adicionar item "Financeiro" com subitens
  - [ ] Ícone: DollarSign ou Wallet

- [ ] **Task 8: Verificação de Integração** (IV1, IV2, IV3)
  - [ ] Verificar que dashboard de vendas continua funcionando
  - [ ] Comparar totais com page de parcelas
  - [ ] Medir tempo de carregamento

## Dev Notes

### Dependências

- **Requer**: Stories 2.1-2.5 completas
- **Bibliotecas**: Recharts para gráficos
- **Components**: shadcn/ui (Card, Button, etc.)

### Estrutura de Arquivos

```
app/admin/financeiro/
├── page.tsx                    # Dashboard principal
├── parcelas/
│   └── page.tsx               # Lista de parcelas (Story 2.5)
└── fluxo-caixa/
    └── page.tsx               # Extrato (opcional)

components/financeiro/
├── CashFlowMetricsCards.tsx   # Cards de métricas
├── CashFlowChart.tsx          # Gráfico de evolução
├── UpcomingInstallments.tsx   # Lista de próximos vencimentos
└── ... (componentes da Story 2.5)
```

### Componente CashFlowMetricsCards

```tsx
// components/financeiro/CashFlowMetricsCards.tsx
'use client'

import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { DollarSign, Calendar, Clock, AlertTriangle } from 'lucide-react'
import Link from 'next/link'
import { CashFlowMetrics } from '@/lib/services/cashFlowService'

interface CashFlowMetricsCardsProps {
  metrics: CashFlowMetrics | undefined
  isLoading?: boolean
}

export function CashFlowMetricsCards({ metrics, isLoading }: CashFlowMetricsCardsProps) {
  const formatCurrency = (value: number) =>
    new Intl.NumberFormat('pt-BR', {
      style: 'currency',
      currency: 'BRL'
    }).format(value)

  if (isLoading) {
    return (
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        {[...Array(4)].map((_, i) => (
          <Card key={i} className="animate-pulse">
            <CardHeader className="h-20 bg-gray-200 rounded" />
          </Card>
        ))}
      </div>
    )
  }

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      <Card>
        <CardHeader className="flex flex-row items-center justify-between pb-2">
          <CardTitle className="text-sm font-medium">Caixa Hoje</CardTitle>
          <DollarSign className="h-4 w-4 text-green-500" />
        </CardHeader>
        <CardContent>
          <div className="text-2xl font-bold text-green-600">
            {formatCurrency(metrics?.today || 0)}
          </div>
          <p className="text-xs text-muted-foreground mt-1">
            Mês: {formatCurrency(metrics?.thisMonth || 0)}
          </p>
        </CardContent>
      </Card>

      <Card>
        <CardHeader className="flex flex-row items-center justify-between pb-2">
          <CardTitle className="text-sm font-medium">Caixa do Mês</CardTitle>
          <Calendar className="h-4 w-4 text-blue-500" />
        </CardHeader>
        <CardContent>
          <div className="text-2xl font-bold text-blue-600">
            {formatCurrency(metrics?.thisMonth || 0)}
          </div>
          <p className="text-xs text-muted-foreground mt-1">
            Semana: {formatCurrency(metrics?.thisWeek || 0)}
          </p>
        </CardContent>
      </Card>

      <Link href="/admin/financeiro/parcelas">
        <Card className="hover:bg-accent transition-colors cursor-pointer">
          <CardHeader className="flex flex-row items-center justify-between pb-2">
            <CardTitle className="text-sm font-medium">A Receber</CardTitle>
            <Clock className="h-4 w-4 text-orange-500" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-orange-600">
              {formatCurrency(metrics?.pendingReceivables || 0)}
            </div>
            <p className="text-xs text-muted-foreground mt-1">
              Parcelas pendentes
            </p>
          </CardContent>
        </Card>
      </Link>

      <Link href="/admin/financeiro/parcelas?status=overdue">
        <Card className="hover:bg-accent transition-colors cursor-pointer">
          <CardHeader className="flex flex-row items-center justify-between pb-2">
            <CardTitle className="text-sm font-medium">Vencidas</CardTitle>
            <AlertTriangle className="h-4 w-4 text-red-500" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold text-red-600">
              {formatCurrency(metrics?.overdueReceivables || 0)}
            </div>
            <p className="text-xs text-muted-foreground mt-1">
              Requer atenção
            </p>
          </CardContent>
        </Card>
      </Link>
    </div>
  )
}
```

### Componente CashFlowChart

```tsx
// components/financeiro/CashFlowChart.tsx
'use client'

import {
  LineChart,
  Line,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
  Legend
} from 'recharts'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { GroupedCashFlow } from '@/lib/services/cashFlowService'
import { format } from 'date-fns'
import { ptBR } from 'date-fns/locale'

interface CashFlowChartProps {
  data: GroupedCashFlow[] | undefined
  isLoading?: boolean
}

export function CashFlowChart({ data, isLoading }: CashFlowChartProps) {
  if (isLoading) {
    return (
      <Card>
        <CardHeader>
          <CardTitle>Evolução do Caixa</CardTitle>
        </CardHeader>
        <CardContent className="h-80 animate-pulse bg-gray-200 rounded" />
      </Card>
    )
  }

  const chartData = data?.map(item => ({
    ...item,
    date: format(new Date(item.period), 'dd/MM', { locale: ptBR })
  })) || []

  const formatCurrency = (value: number) =>
    new Intl.NumberFormat('pt-BR', {
      style: 'currency',
      currency: 'BRL',
      minimumFractionDigits: 0
    }).format(value)

  return (
    <Card>
      <CardHeader>
        <CardTitle>Evolução do Caixa (Últimos 30 dias)</CardTitle>
      </CardHeader>
      <CardContent>
        <ResponsiveContainer width="100%" height={300}>
          <LineChart data={chartData}>
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis
              dataKey="date"
              tick={{ fontSize: 12 }}
            />
            <YAxis
              tickFormatter={formatCurrency}
              tick={{ fontSize: 12 }}
            />
            <Tooltip
              formatter={(value: number) => formatCurrency(value)}
              labelFormatter={(label) => `Data: ${label}`}
            />
            <Legend />
            <Line
              type="monotone"
              dataKey="income"
              name="Entradas"
              stroke="#22c55e"
              strokeWidth={2}
              dot={{ r: 3 }}
            />
            <Line
              type="monotone"
              dataKey="expense"
              name="Saídas"
              stroke="#ef4444"
              strokeWidth={2}
              dot={{ r: 3 }}
            />
          </LineChart>
        </ResponsiveContainer>
      </CardContent>
    </Card>
  )
}
```

### Componente UpcomingInstallments

```tsx
// components/financeiro/UpcomingInstallments.tsx
'use client'

import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import Link from 'next/link'
import { format, differenceInDays } from 'date-fns'
import { ptBR } from 'date-fns/locale'
import { Installment } from '@/lib/services/installmentService'

interface UpcomingInstallmentsProps {
  installments: Installment[] | undefined
  onPayClick: (installment: Installment) => void
  isLoading?: boolean
}

export function UpcomingInstallments({
  installments,
  onPayClick,
  isLoading
}: UpcomingInstallmentsProps) {
  const formatCurrency = (value: number) =>
    new Intl.NumberFormat('pt-BR', {
      style: 'currency',
      currency: 'BRL'
    }).format(value)

  const getDaysLabel = (dueDate: string) => {
    const days = differenceInDays(new Date(dueDate), new Date())
    if (days === 0) return 'Hoje'
    if (days === 1) return 'Amanhã'
    return `${days} dias`
  }

  const getDaysBadgeVariant = (dueDate: string) => {
    const days = differenceInDays(new Date(dueDate), new Date())
    if (days <= 1) return 'destructive'
    if (days <= 3) return 'warning'
    return 'secondary'
  }

  if (isLoading) {
    return (
      <Card>
        <CardHeader>
          <CardTitle>Próximos Vencimentos</CardTitle>
        </CardHeader>
        <CardContent className="animate-pulse space-y-2">
          {[...Array(5)].map((_, i) => (
            <div key={i} className="h-12 bg-gray-200 rounded" />
          ))}
        </CardContent>
      </Card>
    )
  }

  return (
    <Card>
      <CardHeader className="flex flex-row items-center justify-between">
        <CardTitle>Próximos Vencimentos (7 dias)</CardTitle>
        <Link href="/admin/financeiro/parcelas">
          <Button variant="outline" size="sm">Ver todas</Button>
        </Link>
      </CardHeader>
      <CardContent>
        {!installments?.length ? (
          <p className="text-muted-foreground text-center py-4">
            Nenhum vencimento nos próximos 7 dias
          </p>
        ) : (
          <div className="space-y-2">
            {installments.slice(0, 5).map(installment => (
              <div
                key={installment.id}
                className="flex items-center justify-between p-3 border rounded-lg"
              >
                <div className="flex-1">
                  <p className="font-medium">
                    {installment.customer?.full_name || 'Cliente'}
                  </p>
                  <p className="text-sm text-muted-foreground">
                    Parcela {installment.installment_number} -
                    {formatCurrency(installment.amount - installment.paid_amount)}
                  </p>
                </div>

                <div className="flex items-center gap-2">
                  <Badge variant={getDaysBadgeVariant(installment.due_date)}>
                    {getDaysLabel(installment.due_date)}
                  </Badge>
                  <Button
                    size="sm"
                    variant="outline"
                    onClick={() => onPayClick(installment)}
                  >
                    Baixa
                  </Button>
                </div>
              </div>
            ))}
          </div>
        )}
      </CardContent>
    </Card>
  )
}
```

### Página Principal do Dashboard

```tsx
// app/admin/financeiro/page.tsx
'use client'

import { useState } from 'react'
import { useQuery, useQueryClient } from '@tanstack/react-query'
import { getCashFlowMetrics, getCashFlowGrouped } from '@/lib/services/cashFlowService'
import { getPendingInstallments, Installment } from '@/lib/services/installmentService'
import { CashFlowMetricsCards } from '@/components/financeiro/CashFlowMetricsCards'
import { CashFlowChart } from '@/components/financeiro/CashFlowChart'
import { UpcomingInstallments } from '@/components/financeiro/UpcomingInstallments'
import { PayInstallmentDialog } from '@/components/financeiro/PayInstallmentDialog'
import { toast } from 'sonner'

export default function FinanceiroPage() {
  const queryClient = useQueryClient()
  const [selectedInstallment, setSelectedInstallment] = useState<Installment | null>(null)
  const [dialogOpen, setDialogOpen] = useState(false)

  // Métricas do caixa
  const { data: metrics, isLoading: metricsLoading } = useQuery({
    queryKey: ['cash-flow-metrics'],
    queryFn: getCashFlowMetrics
  })

  // Dados do gráfico (últimos 30 dias)
  const thirtyDaysAgo = new Date()
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30)

  const { data: chartData, isLoading: chartLoading } = useQuery({
    queryKey: ['cash-flow-chart'],
    queryFn: () => getCashFlowGrouped(thirtyDaysAgo, new Date(), 'day')
  })

  // Próximos vencimentos (7 dias)
  const weekFromNow = new Date()
  weekFromNow.setDate(weekFromNow.getDate() + 7)

  const { data: upcomingInstallments, isLoading: upcomingLoading } = useQuery({
    queryKey: ['upcoming-installments'],
    queryFn: () => getPendingInstallments({
      status: ['pending', 'partial'],
      dueDateFrom: new Date(),
      dueDateTo: weekFromNow
    })
  })

  const handlePayClick = (installment: Installment) => {
    setSelectedInstallment(installment)
    setDialogOpen(true)
  }

  const handlePaySuccess = () => {
    toast.success('Parcela paga com sucesso!')
    queryClient.invalidateQueries({ queryKey: ['cash-flow-metrics'] })
    queryClient.invalidateQueries({ queryKey: ['cash-flow-chart'] })
    queryClient.invalidateQueries({ queryKey: ['upcoming-installments'] })
  }

  return (
    <div className="container mx-auto py-6 space-y-6">
      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-bold">Dashboard Financeiro</h1>
      </div>

      <CashFlowMetricsCards metrics={metrics} isLoading={metricsLoading} />

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div className="lg:col-span-2">
          <CashFlowChart data={chartData} isLoading={chartLoading} />
        </div>

        <div>
          <UpcomingInstallments
            installments={upcomingInstallments}
            onPayClick={handlePayClick}
            isLoading={upcomingLoading}
          />
        </div>
      </div>

      <PayInstallmentDialog
        installment={selectedInstallment}
        open={dialogOpen}
        onOpenChange={setDialogOpen}
        onSuccess={handlePaySuccess}
      />
    </div>
  )
}
```

### Instalar Recharts (se não existir)

```bash
pnpm add recharts
```

### Testing

- Verificar que todos os cards mostram valores corretos
- Testar gráfico com diferentes volumes de dados
- Testar dar baixa direto do dashboard
- Verificar responsividade em mobile
- Medir performance de carregamento

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-29 | 1.0 | Story criada a partir do PRD | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
_A ser preenchido pelo dev agent_

### Debug Log References
_A ser preenchido pelo dev agent_

### Completion Notes
_A ser preenchido pelo dev agent_

### File List
_A ser preenchido pelo dev agent_

---

## QA Results
_A ser preenchido pelo QA agent_

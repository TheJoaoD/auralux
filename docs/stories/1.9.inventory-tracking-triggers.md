# Story 1.9: Inventory Update on Sale & Movement Tracking (Database Triggers Verification)

## Status
**Draft**

## Story

**As a** system,
**I want** to automatically update product quantities when sales are completed and track all inventory movements with audit trails,
**so that** inventory levels are always accurate, stock is properly managed, and all changes are auditable.

## Acceptance Criteria

1. **Database triggers already created in Story 1.1** - This story verifies and tests them
2. Product quantities automatically decreased when sale completed
3. Sale items recorded in sale_items table with price snapshots
4. Inventory movements recorded in inventory_movements table for each product sold
5. Movement type set to 'sale' with reference to sale_id
6. Customer purchase_count incremented on each sale
7. Customer total_purchases increased by sale amount
8. Low stock alerts triggered when quantity falls below threshold
9. Transaction integrity (rollback if any step fails)
10. Real-time inventory metrics update after sale
11. Insufficient stock validation prevents overselling
12. Audit trail complete and queryable

## Tasks / Subtasks

- [ ] **Task 1: Verify Database Triggers from Story 1.1** (AC: 1, 2, 6, 7)
  - [ ] Confirm triggers created in migration 001_initial_schema.sql:
    - `update_customer_on_sale` trigger
    - `update_inventory_on_sale` trigger
    - `create_inventory_movement_on_sale` trigger
  - [ ] Review trigger SQL:
    ```sql
    -- Trigger to update customer metrics
    CREATE OR REPLACE FUNCTION update_customer_on_sale()
    RETURNS TRIGGER AS $$
    BEGIN
      UPDATE public.customers
      SET
        purchase_count = purchase_count + 1,
        total_purchases = total_purchases + NEW.total_amount
      WHERE id = NEW.customer_id;
      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;

    -- Trigger to update product inventory
    CREATE OR REPLACE FUNCTION update_inventory_on_sale()
    RETURNS TRIGGER AS $$
    BEGIN
      -- Decrement quantity for each sale_item
      -- This will be called by sale_items INSERT trigger
      UPDATE public.products
      SET quantity = quantity - NEW.quantity
      WHERE id = NEW.product_id;

      -- Check if quantity is now below threshold
      -- (Low stock logic - future enhancement)

      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;

    -- Trigger to create inventory movement
    CREATE OR REPLACE FUNCTION create_inventory_movement_on_sale()
    RETURNS TRIGGER AS $$
    DECLARE
      qty_before INTEGER;
      qty_after INTEGER;
    BEGIN
      -- Get quantity before update
      SELECT quantity INTO qty_before
      FROM public.products
      WHERE id = NEW.product_id;

      -- Calculate quantity after
      qty_after := qty_before - NEW.quantity;

      -- Create movement record
      INSERT INTO public.inventory_movements (
        user_id,
        product_id,
        movement_type,
        quantity_change,
        quantity_before,
        quantity_after,
        reference_id,
        notes
      ) VALUES (
        (SELECT user_id FROM public.products WHERE id = NEW.product_id),
        NEW.product_id,
        'sale',
        -NEW.quantity,
        qty_before,
        qty_after,
        NEW.sale_id,
        'Venda automática'
      );

      RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;

    -- Attach triggers
    CREATE TRIGGER trigger_update_customer_on_sale
      AFTER INSERT ON public.sales
      FOR EACH ROW
      WHEN (NEW.status = 'completed')
      EXECUTE FUNCTION update_customer_on_sale();

    CREATE TRIGGER trigger_update_inventory_on_sale
      AFTER INSERT ON public.sale_items
      FOR EACH ROW
      EXECUTE FUNCTION update_inventory_on_sale();

    CREATE TRIGGER trigger_create_inventory_movement
      AFTER INSERT ON public.sale_items
      FOR EACH ROW
      EXECUTE FUNCTION create_inventory_movement_on_sale();
    ```
  - [ ] If triggers not created, add to migration file now
  - [ ] Run migration if needed

- [ ] **Task 2: Stock Validation Service** (AC: 11)
  - [ ] Create `lib/services/inventoryService.ts`
  - [ ] Implement `validateStock(items: CartItem[]): Promise<StockValidationResult>`
    - Check each product's available quantity
    - Return which products have insufficient stock
    - Include available quantity in error
  - [ ] Implement `checkLowStock(productId: string): Promise<boolean>`
    - Query product quantity vs low_stock_threshold
    - Return true if quantity <= threshold
  - [ ] Add to salesService.createSale() before insertion:
    ```typescript
    // Validate stock before creating sale
    const stockValidation = await inventoryService.validateStock(cartItems);
    if (!stockValidation.isValid) {
      throw new Error(`Estoque insuficiente: ${stockValidation.errors.join(', ')}`);
    }
    ```
  - [ ] Add TypeScript interfaces:
    ```typescript
    interface StockValidationResult {
      isValid: boolean;
      errors: string[];
      insufficientProducts: { productId: string; requested: number; available: number }[];
    }
    ```

- [ ] **Task 3: Low Stock Alert Component** (AC: 8)
  - [ ] Create `components/inventory/LowStockBadge.tsx`
  - [ ] Display on product cards when quantity <= low_stock_threshold
  - [ ] Style badge:
    - Background: #C76A6A (warning red)
    - Text: White, "Estoque Baixo"
    - Icon: AlertTriangle
  - [ ] Update InventoryMetrics (Story 1.4) to show low stock count
  - [ ] Add low stock filter to inventory page

- [ ] **Task 4: Inventory Movement Query Service** (AC: 4, 5, 12)
  - [ ] Add to inventoryService.ts:
  - [ ] Implement `getMovements(productId?: string, dateRange?: DateRange): Promise<InventoryMovement[]>`
    - Query inventory_movements table
    - Filter by product_id if provided
    - Filter by date range if provided
    - Order by created_at DESC
    - Return movements array
  - [ ] Implement `getMovementsByReference(referenceId: string): Promise<InventoryMovement[]>`
    - Query movements by sale_id
    - Useful for viewing sale's inventory impact
  - [ ] Add TypeScript interfaces:
    ```typescript
    interface InventoryMovement {
      id: string;
      user_id: string;
      product_id: string;
      product?: Product; // joined
      movement_type: 'addition' | 'sale' | 'adjustment';
      quantity_change: number;
      quantity_before: number;
      quantity_after: number;
      reference_id?: string; // sale_id if type='sale'
      notes?: string;
      created_at: string;
    }
    ```

- [ ] **Task 5: Inventory History View (Future Enhancement)** (AC: 12)
  - [ ] Create placeholder route `app/inventory/history/page.tsx`
  - [ ] Display inventory movements table:
    - Columns: Date, Product, Type, Change, Before, After, Reference
    - Filter by product, date range, movement type
    - Pagination for large datasets
  - [ ] Use React Query to fetch movements:
    ```typescript
    const { data: movements } = useQuery({
      queryKey: ['inventory-movements', filters],
      queryFn: () => inventoryService.getMovements(filters),
    });
    ```
  - [ ] Style table with Auralux colors
  - [ ] *Note: This is a basic implementation for audit purposes, can be enhanced later*

- [ ] **Task 6: Transaction Integrity Testing** (AC: 9)
  - [ ] Write integration test for atomic sale creation:
    - Create sale with multiple products
    - Verify all sale_items created
    - Verify all products.quantity decremented correctly
    - Verify all inventory_movements created
    - Verify customer metrics updated
  - [ ] Test rollback scenario:
    - Mock database error on sale_items insert
    - Verify sale is rolled back
    - Verify product quantities unchanged
  - [ ] Test insufficient stock scenario:
    - Attempt sale with quantity > available
    - Verify error thrown before sale creation
    - Verify no data changed

- [ ] **Task 7: Real-time Inventory Updates** (AC: 10)
  - [ ] Ensure Supabase Realtime subscription on products table (already in Story 1.4)
  - [ ] After sale creation, React Query cache invalidation triggers re-fetch
  - [ ] Inventory metrics component (Story 1.4) will auto-update
  - [ ] Product gallery will show updated quantities
  - [ ] Test: Create sale → Verify inventory page updates immediately

- [ ] **Task 8: Testing & Verification** (AC: All)
  - [ ] Test trigger execution:
    - Create sale → Verify products.quantity decremented
    - Create sale → Verify customer.purchase_count incremented
    - Create sale → Verify customer.total_purchases increased
    - Create sale → Verify inventory_movements created
  - [ ] Test stock validation:
    - Attempt sale with insufficient stock → Error
    - Sale with exact available stock → Success, quantity = 0
  - [ ] Test low stock detection:
    - Product quantity = threshold → Low stock badge appears
    - Product quantity > threshold → No badge
  - [ ] Test transaction integrity:
    - All updates happen together or none happen
  - [ ] Test audit trail:
    - Query inventory_movements by product
    - Query inventory_movements by sale_id
    - Verify all fields populated correctly
  - [ ] Write integration tests for all trigger functions
  - [ ] Write unit tests for stock validation logic
  - [ ] Document any issues or deviations

## Dev Notes

**IMPORTANT:** The core functionality (database triggers) was already created in Story 1.1. This story primarily **verifies and tests** that the triggers work correctly and adds UI/service layer for inventory management.

### Database Triggers Created in Story 1.1
[Source: docs/architecture.md lines 1256-1307]

These triggers were created in migration `001_initial_schema.sql`:
1. Customer metrics update on sale
2. Product quantity update on sale_item
3. Inventory movement creation on sale_item

### Functional Requirements
[Source: docs/epics/00-prd-core.md FR14, FR20, FR22, FR23]
- FR14: Automatically update inventory quantities after sale completion
- FR20: Intelligent inventory tracking with automatic quantity updates
- FR22: Alert when product stock reaches low levels
- FR23: Track inventory movement history

### File Structure
```
lib/
  services/
    inventoryService.ts              # Stock validation, movement queries (new)

components/
  inventory/
    LowStockBadge.tsx                # Low stock indicator (new)

app/
  inventory/
    history/
      page.tsx                       # Inventory movements table (new, basic)

__tests__/
  integration/
    inventory/
      sale-triggers.test.ts          # Test triggers fire correctly (new)
      stock-validation.test.ts       # Test stock validation (new)
      transaction-atomicity.test.ts  # Test rollback scenarios (new)
```

### Testing Focus

This story is **heavily testing-focused** since the core logic exists in database triggers.

**Critical Tests:**
1. Trigger execution on sale creation
2. Atomic transaction behavior
3. Stock validation prevents overselling
4. Audit trail completeness
5. Real-time UI updates

**Test Coverage Goal:** 90% for trigger behavior and validation logic

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-07 | v1.0 | Initial story for Inventory Triggers Verification | Bob (Scrum Master) |

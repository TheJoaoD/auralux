# Story 2.5: Interface de Gestão de Parcelas

## Status: Draft

## Story

**As a** administrador,
**I want** uma tela para visualizar e dar baixa em parcelas,
**so that** eu possa controlar os recebíveis de forma prática.

## Acceptance Criteria

1. Página `/admin/financeiro/parcelas` lista parcelas pendentes
2. Filtros por: status, período de vencimento, cliente
3. Indicador visual de parcelas vencidas (vermelho) e a vencer em 7 dias (amarelo)
4. Botão "Dar baixa" abre modal com: valor, método de pagamento, data
5. Histórico de pagamentos visível em cada parcela
6. Link para detalhes da venda e do cliente
7. Totalizadores no topo: Total pendente, Vencidas, A vencer esta semana
8. Responsivo para mobile

## Integration Verification

- IV1: Navegação integrada ao menu admin existente
- IV2: Padrão visual consistente com demais páginas
- IV3: Loading states e error handling implementados

## Tasks / Subtasks

- [ ] **Task 1: Criar estrutura de pastas** (AC: 1)
  - [ ] Criar `app/admin/financeiro/` se não existir
  - [ ] Criar `app/admin/financeiro/parcelas/page.tsx`
  - [ ] Criar `components/financeiro/` para componentes reutilizáveis

- [ ] **Task 2: Criar componente `InstallmentTable`** (AC: 1, 3, 6)
  - [ ] Criar `components/financeiro/InstallmentTable.tsx`
  - [ ] Colunas: Cliente, Venda, Parcela, Valor, Vencimento, Status, Ações
  - [ ] Indicadores visuais:
    - [ ] Vermelho: status='overdue' ou due_date < hoje
    - [ ] Amarelo: due_date dentro de 7 dias
    - [ ] Verde: status='paid'
  - [ ] Links clicáveis para cliente e venda
  - [ ] Botão "Dar baixa" em cada linha

- [ ] **Task 3: Criar componente `InstallmentFilters`** (AC: 2)
  - [ ] Criar `components/financeiro/InstallmentFilters.tsx`
  - [ ] Select para status: Todos, Pendentes, Vencidas, Pagas
  - [ ] DatePicker para período (de/até)
  - [ ] Combobox/Input para buscar cliente
  - [ ] Botão "Limpar filtros"

- [ ] **Task 4: Criar componente `PayInstallmentDialog`** (AC: 4, 5)
  - [ ] Criar `components/financeiro/PayInstallmentDialog.tsx`
  - [ ] Usar Dialog do shadcn/ui
  - [ ] Campos:
    - [ ] Valor a pagar (default: valor restante)
    - [ ] Método de pagamento: PIX, Dinheiro
    - [ ] Data do pagamento (default: hoje)
    - [ ] Observações (opcional)
  - [ ] Validação: valor <= valor restante
  - [ ] Mostrar histórico de pagamentos anteriores
  - [ ] Botões: Cancelar, Confirmar pagamento

- [ ] **Task 5: Criar componente `InstallmentSummaryCards`** (AC: 7)
  - [ ] Criar `components/financeiro/InstallmentSummaryCards.tsx`
  - [ ] Card "Total Pendente" com valor
  - [ ] Card "Vencidas" com valor e quantidade
  - [ ] Card "A Vencer Esta Semana" com valor e quantidade
  - [ ] Usar cores consistentes com indicadores da tabela

- [ ] **Task 6: Implementar página de Parcelas** (AC: 1, 2, 3, 4, 5, 6, 7, 8)
  - [ ] Página `app/admin/financeiro/parcelas/page.tsx`
  - [ ] Usar TanStack Query para fetch de dados
  - [ ] Integrar InstallmentSummaryCards no topo
  - [ ] Integrar InstallmentFilters
  - [ ] Integrar InstallmentTable
  - [ ] Controlar estado do PayInstallmentDialog
  - [ ] Implementar lógica de filtros
  - [ ] Invalidar query após dar baixa

- [ ] **Task 7: Adicionar ao menu de navegação** (IV1)
  - [ ] Localizar menu admin existente
  - [ ] Adicionar link "Financeiro" ou "Parcelas"
  - [ ] Ícone: DollarSign ou CreditCard do lucide-react

- [ ] **Task 8: Garantir responsividade** (AC: 8)
  - [ ] Tabela com scroll horizontal em mobile
  - [ ] Cards empilhados em telas pequenas
  - [ ] Modal fullscreen em mobile
  - [ ] Filtros colapsáveis em mobile

- [ ] **Task 9: Loading e Error States** (IV3)
  - [ ] Skeleton loading para tabela
  - [ ] Toast de sucesso ao dar baixa
  - [ ] Toast de erro com mensagem clara
  - [ ] Empty state quando não há parcelas

## Dev Notes

### Dependências

- **Requer**: Stories 2.1-2.4 completas (services funcionando)
- **Componentes UI**: shadcn/ui (Dialog, Table, Select, DatePicker, Card, Badge, Button)
- **Icons**: lucide-react

### Estrutura de Arquivos

[Source: docs/architecture-cash-flow.md#7.2]

```
app/admin/financeiro/
├── parcelas/
│   └── page.tsx

components/financeiro/
├── InstallmentTable.tsx
├── InstallmentFilters.tsx
├── InstallmentSummaryCards.tsx
├── PayInstallmentDialog.tsx
└── index.ts
```

### Componente InstallmentTable

```tsx
// components/financeiro/InstallmentTable.tsx
'use client'

import { useState } from 'react'
import { format, differenceInDays, isPast } from 'date-fns'
import { ptBR } from 'date-fns/locale'
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import Link from 'next/link'
import { Installment } from '@/lib/services/installmentService'

interface InstallmentTableProps {
  installments: Installment[]
  onPayClick: (installment: Installment) => void
  isLoading?: boolean
}

export function InstallmentTable({
  installments,
  onPayClick,
  isLoading
}: InstallmentTableProps) {
  const getStatusBadge = (installment: Installment) => {
    const today = new Date()
    const dueDate = new Date(installment.due_date)
    const daysUntilDue = differenceInDays(dueDate, today)

    if (installment.status === 'paid') {
      return <Badge variant="success">Paga</Badge>
    }

    if (installment.status === 'overdue' || isPast(dueDate)) {
      return <Badge variant="destructive">Vencida</Badge>
    }

    if (daysUntilDue <= 7) {
      return <Badge variant="warning">Vence em {daysUntilDue} dias</Badge>
    }

    if (installment.status === 'partial') {
      return <Badge variant="secondary">Parcial</Badge>
    }

    return <Badge variant="outline">Pendente</Badge>
  }

  const formatCurrency = (value: number) =>
    new Intl.NumberFormat('pt-BR', {
      style: 'currency',
      currency: 'BRL'
    }).format(value)

  if (isLoading) {
    return <div>Carregando...</div> // Substituir por Skeleton
  }

  return (
    <Table>
      <TableHeader>
        <TableRow>
          <TableHead>Cliente</TableHead>
          <TableHead>Parcela</TableHead>
          <TableHead>Valor</TableHead>
          <TableHead>Vencimento</TableHead>
          <TableHead>Status</TableHead>
          <TableHead>Ações</TableHead>
        </TableRow>
      </TableHeader>
      <TableBody>
        {installments.map(installment => (
          <TableRow key={installment.id}>
            <TableCell>
              <Link
                href={`/admin/clientes/${installment.customer?.id}`}
                className="text-blue-600 hover:underline"
              >
                {installment.customer?.full_name || 'N/A'}
              </Link>
            </TableCell>
            <TableCell>
              <Link
                href={`/admin/vendas/${installment.sale_id}`}
                className="text-blue-600 hover:underline"
              >
                {installment.installment_number}x
              </Link>
            </TableCell>
            <TableCell>
              <div>{formatCurrency(installment.amount)}</div>
              {installment.paid_amount > 0 && (
                <div className="text-sm text-muted-foreground">
                  Pago: {formatCurrency(installment.paid_amount)}
                </div>
              )}
            </TableCell>
            <TableCell>
              {format(new Date(installment.due_date), 'dd/MM/yyyy', { locale: ptBR })}
            </TableCell>
            <TableCell>{getStatusBadge(installment)}</TableCell>
            <TableCell>
              {installment.status !== 'paid' && (
                <Button
                  size="sm"
                  onClick={() => onPayClick(installment)}
                >
                  Dar baixa
                </Button>
              )}
            </TableCell>
          </TableRow>
        ))}
      </TableBody>
    </Table>
  )
}
```

### Componente PayInstallmentDialog

```tsx
// components/financeiro/PayInstallmentDialog.tsx
'use client'

import { useState } from 'react'
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { z } from 'zod'
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import { Installment, payInstallment } from '@/lib/services/installmentService'

const paymentSchema = z.object({
  amount: z.number().positive('Valor deve ser maior que zero'),
  paymentMethod: z.enum(['pix', 'cash']),
  notes: z.string().optional()
})

type PaymentForm = z.infer<typeof paymentSchema>

interface PayInstallmentDialogProps {
  installment: Installment | null
  open: boolean
  onOpenChange: (open: boolean) => void
  onSuccess: () => void
}

export function PayInstallmentDialog({
  installment,
  open,
  onOpenChange,
  onSuccess
}: PayInstallmentDialogProps) {
  const [isLoading, setIsLoading] = useState(false)

  const remaining = installment
    ? installment.amount - installment.paid_amount
    : 0

  const { register, handleSubmit, setValue, formState: { errors } } = useForm<PaymentForm>({
    resolver: zodResolver(paymentSchema),
    defaultValues: {
      amount: remaining,
      paymentMethod: 'pix'
    }
  })

  const onSubmit = async (data: PaymentForm) => {
    if (!installment) return

    setIsLoading(true)
    try {
      await payInstallment({
        installmentId: installment.id,
        amount: data.amount,
        paymentMethod: data.paymentMethod,
        notes: data.notes
      })
      onSuccess()
      onOpenChange(false)
    } catch (error) {
      console.error('Erro ao dar baixa:', error)
      // Mostrar toast de erro
    } finally {
      setIsLoading(false)
    }
  }

  const formatCurrency = (value: number) =>
    new Intl.NumberFormat('pt-BR', {
      style: 'currency',
      currency: 'BRL'
    }).format(value)

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Dar Baixa na Parcela</DialogTitle>
        </DialogHeader>

        {installment && (
          <form onSubmit={handleSubmit(onSubmit)}>
            <div className="space-y-4">
              <div>
                <p className="text-sm text-muted-foreground">
                  Parcela {installment.installment_number} -
                  Valor total: {formatCurrency(installment.amount)}
                </p>
                <p className="text-sm font-medium">
                  Restante: {formatCurrency(remaining)}
                </p>
              </div>

              <div>
                <Label htmlFor="amount">Valor a pagar</Label>
                <Input
                  id="amount"
                  type="number"
                  step="0.01"
                  max={remaining}
                  {...register('amount', { valueAsNumber: true })}
                />
                {errors.amount && (
                  <p className="text-sm text-red-500">{errors.amount.message}</p>
                )}
              </div>

              <div>
                <Label htmlFor="paymentMethod">Método de pagamento</Label>
                <Select
                  defaultValue="pix"
                  onValueChange={(value) => setValue('paymentMethod', value as 'pix' | 'cash')}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="pix">PIX</SelectItem>
                    <SelectItem value="cash">Dinheiro</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              <div>
                <Label htmlFor="notes">Observações (opcional)</Label>
                <Input id="notes" {...register('notes')} />
              </div>
            </div>

            <DialogFooter className="mt-6">
              <Button
                type="button"
                variant="outline"
                onClick={() => onOpenChange(false)}
              >
                Cancelar
              </Button>
              <Button type="submit" disabled={isLoading}>
                {isLoading ? 'Processando...' : 'Confirmar Pagamento'}
              </Button>
            </DialogFooter>
          </form>
        )}
      </DialogContent>
    </Dialog>
  )
}
```

### Página Principal

```tsx
// app/admin/financeiro/parcelas/page.tsx
'use client'

import { useState } from 'react'
import { useQuery, useQueryClient } from '@tanstack/react-query'
import {
  getPendingInstallments,
  getInstallmentsSummary,
  Installment,
  InstallmentFilters
} from '@/lib/services/installmentService'
import { InstallmentTable } from '@/components/financeiro/InstallmentTable'
import { InstallmentFilters as Filters } from '@/components/financeiro/InstallmentFilters'
import { InstallmentSummaryCards } from '@/components/financeiro/InstallmentSummaryCards'
import { PayInstallmentDialog } from '@/components/financeiro/PayInstallmentDialog'
import { toast } from 'sonner'

export default function ParcelasPage() {
  const queryClient = useQueryClient()
  const [filters, setFilters] = useState<InstallmentFilters>({})
  const [selectedInstallment, setSelectedInstallment] = useState<Installment | null>(null)
  const [dialogOpen, setDialogOpen] = useState(false)

  const { data: installments, isLoading } = useQuery({
    queryKey: ['installments', filters],
    queryFn: () => getPendingInstallments(filters)
  })

  const { data: summary } = useQuery({
    queryKey: ['installments-summary'],
    queryFn: getInstallmentsSummary
  })

  const handlePayClick = (installment: Installment) => {
    setSelectedInstallment(installment)
    setDialogOpen(true)
  }

  const handlePaySuccess = () => {
    toast.success('Parcela paga com sucesso!')
    queryClient.invalidateQueries({ queryKey: ['installments'] })
    queryClient.invalidateQueries({ queryKey: ['installments-summary'] })
  }

  return (
    <div className="container mx-auto py-6 space-y-6">
      <h1 className="text-2xl font-bold">Gestão de Parcelas</h1>

      <InstallmentSummaryCards summary={summary} />

      <Filters filters={filters} onFiltersChange={setFilters} />

      <InstallmentTable
        installments={installments || []}
        onPayClick={handlePayClick}
        isLoading={isLoading}
      />

      <PayInstallmentDialog
        installment={selectedInstallment}
        open={dialogOpen}
        onOpenChange={setDialogOpen}
        onSuccess={handlePaySuccess}
      />
    </div>
  )
}
```

### Componentes shadcn/ui Necessários

Verificar se já estão instalados, se não:

```bash
npx shadcn-ui@latest add dialog
npx shadcn-ui@latest add table
npx shadcn-ui@latest add select
npx shadcn-ui@latest add badge
npx shadcn-ui@latest add card
npx shadcn-ui@latest add input
npx shadcn-ui@latest add label
npx shadcn-ui@latest add button
```

### Testing

- Testar filtros individualmente e combinados
- Testar dar baixa total e parcial
- Verificar indicadores visuais (cores corretas)
- Testar em diferentes tamanhos de tela
- Verificar loading e error states

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-29 | 1.0 | Story criada a partir do PRD | Bob (SM) |

---

## Dev Agent Record

### Agent Model Used
_A ser preenchido pelo dev agent_

### Debug Log References
_A ser preenchido pelo dev agent_

### Completion Notes
_A ser preenchido pelo dev agent_

### File List
_A ser preenchido pelo dev agent_

---

## QA Results
_A ser preenchido pelo QA agent_

# Story 1.6: Sales Dashboard with Metrics and Visualizations

## Status
**Draft**

## Story

**As a** store owner,
**I want** to view a comprehensive sales dashboard with attractive metrics, charts, and recent sales list as my default landing screen,
**so that** I can monitor my business performance at a glance and make informed decisions.

## Acceptance Criteria

1. Sales Dashboard is the default landing screen after login (route: /dashboard)
2. "+ Nova Venda" button prominently displayed at top of dashboard
3. Key metrics cards displayed in grid: Daily Sales, Weekly Sales, Monthly Sales, Total Revenue
4. Additional metrics: Average Sale Value, Total Actual Received (after installment fees)
5. Sales chart/graph visualization showing sales over time (last 30 days)
6. Recent sales list (last 10 sales) with customer name, date, amount, and payment method
7. Payment method breakdown widget (PIX, Cash, Installment percentages with visual indicators)
8. Revenue vs Actual Received metric showing installment discount impact
9. Real-time updates using Supabase Realtime subscriptions
10. Loading states for all data sections (skeleton cards, chart placeholder)
11. Empty state when no sales exist (encouraging "+ Nova Venda")
12. Responsive layout for mobile (metrics stack vertically, chart adapts)
13. Date range filter (Today, Last 7 Days, Last 30 Days, This Month)
14. Refresh button to manually reload data
15. All metrics formatted in Brazilian Real (R$)

## Tasks / Subtasks

- [ ] **Task 1: Sales Data Service & Analytics** (AC: 3, 4, 7, 8)
  - [ ] Create `lib/services/salesService.ts` (will be used across sale stories)
  - [ ] Implement `getSales(userId: string, filters?: SalesFilters): Promise<Sale[]>`
    - Query sales table with optional date range filter
    - Join with customers table for customer names
    - Order by created_at DESC
    - Return sales array
  - [ ] Implement `getSalesMetrics(userId: string, dateRange: DateRange): Promise<SalesMetrics>`
    - Use v_daily_sales_metrics view for aggregation
    - Calculate: total sales count, total revenue, actual revenue, avg sale value
    - Group by date periods (daily, weekly, monthly)
    - Return metrics object
  - [ ] Implement `getPaymentMethodBreakdown(userId: string, dateRange: DateRange): Promise<PaymentBreakdown>`
    - Use v_payment_method_breakdown view
    - Calculate percentages for PIX, Cash, Installment
    - Return breakdown object
  - [ ] Implement `getRecentSales(userId: string, limit: number = 10): Promise<Sale[]>`
    - Query last N sales
    - Include customer name, payment method
    - Return sales array
  - [ ] Add TypeScript interfaces:
    ```typescript
    export interface Sale {
      id: string;
      user_id: string;
      customer_id: string;
      customer?: Customer; // joined
      total_amount: number;
      payment_method: 'pix' | 'cash' | 'installment';
      installment_count?: number;
      actual_amount_received?: number;
      discount_amount?: number; // computed
      status: 'completed' | 'pending' | 'cancelled';
      notes?: string;
      created_at: string;
      updated_at: string;
    }

    export interface SalesMetrics {
      totalSales: number;
      totalRevenue: number;
      actualRevenue: number;
      totalDiscount: number;
      avgSaleValue: number;
      dailySales: number;
      weeklySales: number;
      monthlySales: number;
    }

    export interface PaymentBreakdown {
      pix: { count: number; percentage: number; total: number };
      cash: { count: number; percentage: number; total: number };
      installment: { count: number; percentage: number; total: number };
    }

    export interface DateRange {
      startDate: Date;
      endDate: Date;
    }
    ```

- [ ] **Task 2: Dashboard Metrics Cards Component** (AC: 3, 4, 15)
  - [ ] Create `components/dashboard/MetricsCards.tsx`
  - [ ] Display 4 primary metric cards in responsive grid:
    1. **Vendas Hoje** (Daily Sales)
       - Icon: TrendingUp (Rosa Queimado)
       - Value: Count of today's sales
       - Subtitle: "vendas realizadas"
    2. **Vendas Semana** (Weekly Sales)
       - Icon: Calendar (Rosa Queimado)
       - Value: Count of last 7 days sales
       - Subtitle: "últimos 7 dias"
    3. **Vendas Mês** (Monthly Sales)
       - Icon: BarChart (Rosa Queimado)
       - Value: Count of current month sales
       - Subtitle: "este mês"
    4. **Receita Total** (Total Revenue)
       - Icon: DollarSign (Rosa Queimado)
       - Value: R$ formatted total revenue
       - Subtitle: formatCurrency(actualRevenue) in smaller text
  - [ ] Display secondary metrics row:
    5. **Ticket Médio** (Average Sale Value)
       - Icon: Receipt (Rosa Queimado)
       - Value: R$ formatted avg value
    6. **Desconto Total** (Total Discount from Installments)
       - Icon: Percent (warning color if > 0)
       - Value: R$ formatted discount
       - Percentage: (discount / totalRevenue) × 100
  - [ ] Style cards:
    - Background: Taupe/Greige (#A1887F)
    - Border-radius: 12px
    - Icon: Rosa Queimado (#C49A9A), 32px
    - Value: Areia (#E0DCD1), 28px, font-bold
    - Subtitle: Areia 70% opacity, 12px
  - [ ] Grid layout: 2 columns mobile, 4 columns tablet+
  - [ ] Add loading skeleton states

- [ ] **Task 3: Sales Chart Component** (AC: 5, 10, 12)
  - [ ] Create `components/dashboard/SalesChart.tsx`
  - [ ] Use Recharts library (already in tech stack)
  - [ ] Create line chart for sales over time (last 30 days default)
  - [ ] Chart data: { date: string, sales: number, revenue: number }
  - [ ] Configure chart:
    - X-axis: Dates (DD/MM format)
    - Y-axis Left: Sales count
    - Y-axis Right: Revenue (R$)
    - Line 1: Sales count (Rosa Queimado color)
    - Line 2: Revenue (Taupe/Greige color)
    - Tooltip: Custom styled with Auralux colors
    - Grid: Subtle Taupe/Greige lines
  - [ ] Style chart container:
    - Background: Taupe/Greige (#A1887F)
    - Border-radius: 12px
    - Padding: 16px
    - Title: "Vendas nos Últimos 30 Dias"
  - [ ] Handle responsive sizing (full width, height 300px mobile, 400px desktop)
  - [ ] Loading state: Show skeleton placeholder
  - [ ] Empty state: "Nenhuma venda registrada ainda"

- [ ] **Task 4: Recent Sales List Component** (AC: 6)
  - [ ] Create `components/dashboard/RecentSalesList.tsx`
  - [ ] Display last 10 sales in list format
  - [ ] Each sale item shows:
    - Customer name (heading, Areia)
    - Date and time (formatted: "DD/MM/YYYY - HH:mm", Areia 60% opacity)
    - Amount (R$ formatted, Rosa Queimado, font-semibold)
    - Payment method badge:
      - PIX: Green-tinted badge, "PIX"
      - Cash: Blue-tinted badge, "Dinheiro"
      - Installment: Orange-tinted badge, "Xx" (e.g., "3x", "12x")
  - [ ] Style list:
    - Container background: Taupe/Greige (#A1887F)
    - Border-radius: 12px
    - Each item: Off-White (#F7F5F2) background, 8px radius, 12px padding
    - Items separated by 8px margin
    - List title: "Vendas Recentes"
  - [ ] Add "Ver Todas" (View All) link at bottom (future story)
  - [ ] Loading state: Skeleton list items
  - [ ] Empty state: "Nenhuma venda ainda. Clique em '+ Nova Venda' para começar"

- [ ] **Task 5: Payment Method Breakdown Widget** (AC: 7)
  - [ ] Create `components/dashboard/PaymentBreakdown.tsx`
  - [ ] Display payment method distribution as visual widget
  - [ ] Calculate percentages from paymentBreakdown data
  - [ ] Show 3 sections:
    - **PIX**: Percentage bar + count + total
    - **Dinheiro**: Percentage bar + count + total
    - **Parcelado**: Percentage bar + count + total
  - [ ] Style widget:
    - Container: Taupe/Greige (#A1887F), border-radius 12px
    - Title: "Métodos de Pagamento"
    - Percentage bars:
      - PIX: Green (#4CAF50) background
      - Cash: Blue (#2196F3) background
      - Installment: Orange (#FF9800) background
    - Bar height: 24px, border-radius 8px
    - Percentage text inside bar: White, font-semibold
    - Count and total below bar: Areia 70% opacity, 12px
  - [ ] Loading state: Skeleton bars
  - [ ] Empty state: "Sem dados de pagamento"

- [ ] **Task 6: Date Range Filter** (AC: 13)
  - [ ] Create `components/dashboard/DateRangeFilter.tsx`
  - [ ] Add filter buttons:
    - "Hoje" (Today)
    - "Últimos 7 Dias" (Last 7 Days)
    - "Últimos 30 Dias" (Last 30 Days) - DEFAULT
    - "Este Mês" (This Month)
  - [ ] Style buttons:
    - Inactive: Taupe/Greige outline
    - Active: Rosa Queimado background, Carvão text
    - Button group: Horizontal on tablet+, vertical stack on mobile
  - [ ] Implement filter logic:
    - Calculate startDate and endDate based on selection
    - Pass dateRange to metrics/chart queries
    - Update all dashboard sections on filter change
  - [ ] Save selected filter in local state (React useState)

- [ ] **Task 7: Dashboard Page Assembly** (AC: 1, 2, 9, 10, 11, 12, 14)
  - [ ] Update `app/dashboard/page.tsx` (created in Story 1.2)
  - [ ] Remove placeholder content
  - [ ] Implement dashboard layout:
    - Header section:
      - Page title: "Dashboard de Vendas"
      - "+ Nova Venda" button (top right, Rosa Queimado)
      - Refresh button (icon only, Areia)
      - DateRangeFilter component
    - Metrics section: MetricsCards component
    - Charts section:
      - SalesChart component (left, 2/3 width desktop)
      - PaymentBreakdown widget (right, 1/3 width desktop)
      - Stack vertically on mobile
    - Recent sales section: RecentSalesList component
  - [ ] Use React Query for data fetching:
    ```typescript
    const { data: metrics, isLoading: metricsLoading } = useQuery({
      queryKey: ['sales-metrics', dateRange],
      queryFn: () => salesService.getSalesMetrics(user.id, dateRange),
      refetchInterval: 60000, // Refresh every 60 seconds
    });

    const { data: recentSales, isLoading: salesLoading } = useQuery({
      queryKey: ['recent-sales'],
      queryFn: () => salesService.getRecentSales(user.id, 10),
    });

    const { data: paymentBreakdown } = useQuery({
      queryKey: ['payment-breakdown', dateRange],
      queryFn: () => salesService.getPaymentMethodBreakdown(user.id, dateRange),
    });
    ```
  - [ ] Implement refresh button:
    - Call queryClient.invalidateQueries() on all dashboard queries
    - Show loading indicator during refresh
  - [ ] Handle loading states for all sections
  - [ ] Handle empty state (no sales):
    - Large icon: TrendingUp (Prata, 80px)
    - Message: "Nenhuma venda registrada ainda"
    - Subtitle: "Comece a registrar vendas para ver seu dashboard"
    - "+ Nova Venda" button (large, prominent)
  - [ ] Use MainLayout wrapper
  - [ ] Ensure "+ Nova Venda" button opens sale creation flow (future Story 1.7)

- [ ] **Task 8: Real-time Updates** (AC: 9)
  - [ ] Set up Supabase Realtime subscription for sales table:
    ```typescript
    useEffect(() => {
      const subscription = supabase
        .channel('sales-dashboard-channel')
        .on(
          'postgres_changes',
          {
            event: 'INSERT',
            schema: 'public',
            table: 'sales',
            filter: `user_id=eq.${user.id}`
          },
          (payload) => {
            queryClient.invalidateQueries(['sales-metrics']);
            queryClient.invalidateQueries(['recent-sales']);
            queryClient.invalidateQueries(['payment-breakdown']);
          }
        )
        .subscribe();

      return () => subscription.unsubscribe();
    }, [user.id]);
    ```
  - [ ] Test real-time updates by creating sale in another tab

- [ ] **Task 9: Utilities for Date and Currency** (AC: 15)
  - [ ] Update `lib/utils/formatters.ts` with additional helpers:
    ```typescript
    export function formatCurrency(value: number): string {
      return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      }).format(value);
    }

    export function formatDate(date: string | Date): string {
      return new Intl.DateTimeFormat('pt-BR').format(new Date(date));
    }

    export function formatDateTime(date: string | Date): string {
      return new Intl.DateTimeFormat('pt-BR', {
        dateStyle: 'short',
        timeStyle: 'short'
      }).format(new Date(date));
    }

    export function getDateRange(period: 'today' | 'week' | 'month' | '30days'): DateRange {
      const now = new Date();
      const startDate = new Date();

      switch (period) {
        case 'today':
          startDate.setHours(0, 0, 0, 0);
          break;
        case 'week':
          startDate.setDate(now.getDate() - 7);
          break;
        case '30days':
          startDate.setDate(now.getDate() - 30);
          break;
        case 'month':
          startDate.setDate(1);
          startDate.setHours(0, 0, 0, 0);
          break;
      }

      return { startDate, endDate: now };
    }
    ```

- [ ] **Task 10: Testing & Verification** (AC: All)
  - [ ] Test dashboard loads with sample sales data
  - [ ] Test dashboard with no sales (empty state)
  - [ ] Test all date range filters
  - [ ] Test metrics calculations accuracy
  - [ ] Test payment method breakdown percentages
  - [ ] Test chart renders correctly with various data sets
  - [ ] Test real-time updates when new sale created
  - [ ] Test refresh button functionality
  - [ ] Test responsive layout on different screen sizes
  - [ ] Verify "+ Nova Venda" button routing (will connect in Story 1.7)
  - [ ] Write unit tests:
    - Date range utility functions
    - Currency and date formatters
    - Metrics calculation logic
  - [ ] Write integration tests:
    - Sales metrics query with database views
    - Payment breakdown aggregation
  - [ ] Write component tests:
    - MetricsCards rendering with data
    - SalesChart data visualization
    - DateRangeFilter state changes
  - [ ] Document any issues or deviations

## Dev Notes

### Sales Data Model
[Source: docs/architecture/02-data-models.md - Sale section]

**Sale Entity:**
- Primary Key: `id` (UUID)
- Foreign Keys: `user_id`, `customer_id`
- Payment types: 'pix', 'cash', 'installment'
- Computed: `discount_amount` = total_amount - actual_amount_received (for installments)

**Key Fields:**
- `total_amount`: Full sale price
- `actual_amount_received`: Amount after card fees (installments only)
- `discount_amount`: Card processing fees (computed)
- `installment_count`: 1-12 (for installment payment method)
- `status`: 'completed', 'pending', 'cancelled'

### Database Views for Dashboard
[Source: docs/architecture.md lines 1336-1387]

**v_daily_sales_metrics:**
```sql
SELECT
  user_id,
  DATE(created_at) as sale_date,
  COUNT(*) as sale_count,
  SUM(total_amount) as total_revenue,
  SUM(actual_amount_received) as actual_revenue,
  SUM(total_amount - actual_amount_received) as total_discount
FROM public.sales
WHERE status = 'completed'
GROUP BY user_id, DATE(created_at);
```

**v_payment_method_breakdown:**
```sql
SELECT
  user_id,
  payment_method,
  COUNT(*) as transaction_count,
  SUM(total_amount) as total_revenue,
  AVG(total_amount) as avg_transaction_value
FROM public.sales
WHERE status = 'completed'
GROUP BY user_id, payment_method;
```

**Usage in Service:**
```typescript
async getSalesMetrics(userId: string, dateRange: DateRange): Promise<SalesMetrics> {
  const { data, error } = await this.supabase
    .from('v_daily_sales_metrics')
    .select('*')
    .eq('user_id', userId)
    .gte('sale_date', dateRange.startDate.toISOString())
    .lte('sale_date', dateRange.endDate.toISOString());

  if (error) throw error;

  // Aggregate results
  const totalSales = data.reduce((sum, d) => sum + d.sale_count, 0);
  const totalRevenue = data.reduce((sum, d) => sum + d.total_revenue, 0);
  // ... etc
}
```

### UI/UX Design Specifications
[Source: docs/epics/01-ui-ux-guidelines.md - Sales Dashboard]

**Dashboard Layout:**
- Default landing screen after login
- "+ Nova Venda" button: Prominent, top right, Rosa Queimado background
- Metrics cards in grid (2 cols mobile, 4 cols desktop)
- Charts section: 2/3 width for line chart, 1/3 for payment breakdown (desktop)
- Recent sales list: Full width below charts

**Metrics Card Design:**
- Background: Taupe/Greige (#A1887F)
- Border-radius: 12px
- Padding: 20px
- Icon: Rosa Queimado (#C49A9A), 32px, top left
- Value: Areia (#E0DCD1), 32px, font-bold, center
- Subtitle: Areia 60% opacity, 14px, center

**Chart Design:**
- Container background: Taupe/Greige (#A1887F)
- Chart background: Off-White (#F7F5F2)
- Line colors: Rosa Queimado for sales, Taupe for revenue
- Grid lines: Taupe/Greige 20% opacity
- Tooltip: Off-White background, Taupe/Greige border

**Payment Breakdown:**
- Container: Taupe/Greige (#A1887F)
- Bars:
  - PIX: #4CAF50 (green)
  - Cash: #2196F3 (blue)
  - Installment: #FF9800 (orange)
- Percentage text: White, inside bar
- Count/total: Areia 70% opacity, below bar

**Recent Sales List:**
- Container: Taupe/Greige (#A1887F)
- Items: Off-White (#F7F5F2), 8px radius
- Customer name: Areia, 16px, font-medium
- Amount: Rosa Queimado, 18px, font-semibold
- Payment badge: Small pill, colored by method

### Functional Requirements
[Source: docs/epics/00-prd-core.md FR6-FR7, FR13]
- FR6: Sales Dashboard as default landing screen
- FR7: "+ Nova Venda" button prominently above dashboard
- FR13: Sales metrics in attractive, objective dashboard format

[Source: docs/epics/epic-01-mvp.md Story 1.8]
Story 1.8 in original epic: Sales Dashboard with Metrics

### Chart Library
[Source: docs/architecture/01-tech-stack.md]
- **Library:** Recharts 2.x (already configured)
- **Rationale:** Composable, responsive, React-friendly
- Supports line charts, bar charts, area charts
- Easy theming for Auralux color scheme

**Recharts Configuration:**
```typescript
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';

<ResponsiveContainer width="100%" height={400}>
  <LineChart data={salesData}>
    <CartesianGrid strokeDasharray="3 3" stroke="#A1887F33" />
    <XAxis dataKey="date" stroke="#E0DCD1" />
    <YAxis yAxisId="left" stroke="#C49A9A" />
    <YAxis yAxisId="right" orientation="right" stroke="#A1887F" />
    <Tooltip
      contentStyle={{ backgroundColor: '#F7F5F2', border: '1px solid #A1887F' }}
    />
    <Line
      yAxisId="left"
      type="monotone"
      dataKey="sales"
      stroke="#C49A9A"
      strokeWidth={2}
    />
    <Line
      yAxisId="right"
      type="monotone"
      dataKey="revenue"
      stroke="#A1887F"
      strokeWidth={2}
    />
  </LineChart>
</ResponsiveContainer>
```

### Real-time Data Updates
[Source: docs/architecture/00-overview.md]
- Supabase Realtime via WebSocket connection
- Subscribe to INSERT events on sales table
- Invalidate React Query cache on new sale
- Dashboard auto-refreshes with new data

### Performance Considerations
[Source: docs/epics/00-prd-core.md NFR1-NFR3]
- NFR3: Dashboard metrics refresh in real-time without page reload
- Use React Query caching to minimize database queries
- Refetch interval: 60 seconds for metrics
- Realtime subscription for instant updates on new sales

### File Structure
```
app/
  dashboard/
    page.tsx                         # Main dashboard page (update existing)

components/
  dashboard/
    MetricsCards.tsx                 # Metrics grid display
    SalesChart.tsx                   # Line chart (Recharts)
    RecentSalesList.tsx              # Last 10 sales list
    PaymentBreakdown.tsx             # Payment method widget
    DateRangeFilter.tsx              # Filter buttons
    MetricCard.tsx                   # Reusable metric card component

lib/
  services/
    salesService.ts                  # Sales CRUD and analytics
  utils/
    formatters.ts                    # Currency, date formatters (update)

__tests__/
  unit/
    utils/
      date-range.test.ts
    services/
      sales-metrics.test.ts
  integration/
    dashboard/
      sales-metrics-query.test.ts
  components/
    dashboard/
      MetricsCards.test.tsx
      SalesChart.test.tsx
```

### Testing

**Unit Tests:**
- Date range calculation (getDateRange utility)
- Currency formatting (formatCurrency)
- Metrics calculation logic (totalRevenue, avgSaleValue, etc.)

**Integration Tests:**
- Query v_daily_sales_metrics view with date filters
- Query v_payment_method_breakdown view
- Aggregate metrics from multiple sales

**Component Tests:**
- MetricsCards render correct values
- SalesChart displays data points correctly
- DateRangeFilter changes trigger data refetch
- RecentSalesList renders sales with correct formatting
- PaymentBreakdown calculates percentages correctly

**E2E Test (Future Story 1.12):**
- Create sale → verify dashboard updates in real-time
- Apply date filter → verify chart and metrics update

**Test Coverage Goal:** 75% for dashboard components and services

**Critical Test Cases:**
1. Metrics accuracy: total_revenue should equal SUM(total_amount) from sales
2. Discount calculation: discount_amount = total_amount - actual_amount_received
3. Payment breakdown percentages sum to 100%
4. Empty state displays when no sales exist
5. Real-time updates trigger cache invalidation

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-07 | v1.0 | Initial story creation for Sales Dashboard | Bob (Scrum Master) |

---

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

---

## QA Results

*This section will be populated by the QA Agent after implementation.*

# Story 1.5: Category Management in Settings

## Status
**Draft**

## Story

**As a** store owner,
**I want** to create, edit, and delete product categories from the settings screen,
**so that** I can organize my inventory effectively and assign products to logical groups.

## Acceptance Criteria

1. Settings screen accessible from top bar settings icon
2. Categories section displayed prominently in settings
3. List of all existing categories shown with name and product count
4. "+ Nova Categoria" button to add new category
5. Add category modal with name and description fields
6. Category name validation (required, unique per user, max 50 chars)
7. Edit category functionality (update name and description)
8. Delete category functionality with confirmation dialog
9. Deleting category sets product.category_id to NULL (doesn't delete products)
10. Warning when deleting category with assigned products
11. Success feedback on create/update/delete (toast notifications)
12. Loading states during operations
13. Empty state when no categories exist
14. Category changes immediately reflected in product form dropdowns
15. Real-time updates when categories change

## Tasks / Subtasks

- [ ] **Task 1: Category Data Service** (AC: 9, 10)
  - [ ] Update `lib/services/categoryService.ts` with full CRUD
  - [ ] Implement `createCategory(data: CategoryInput): Promise<Category>`
    - Validate with Zod schema
    - Insert into categories table
    - Return created category
  - [ ] Implement `updateCategory(id: string, data: Partial<CategoryInput>): Promise<Category>`
    - Update category by ID
    - Verify RLS enforcement
  - [ ] Implement `deleteCategory(id: string): Promise<void>`
    - Check for assigned products first
    - Delete category (ON DELETE SET NULL handles products)
    - Return count of affected products
  - [ ] Implement `getCategoryProductCount(categoryId: string): Promise<number>`
    - Query products table with category_id filter
    - Return count
  - [ ] Add TypeScript interfaces:
    ```typescript
    export interface Category {
      id: string;
      user_id: string;
      name: string;
      description?: string;
      product_count?: number; // computed
      created_at: string;
      updated_at: string;
    }

    export interface CategoryInput {
      name: string;
      description?: string;
    }
    ```

- [ ] **Task 2: Category Validation Schema** (AC: 6)
  - [ ] Create `lib/validations/categorySchemas.ts`
  - [ ] Define Zod schema:
    ```typescript
    export const categorySchema = z.object({
      name: z
        .string()
        .min(2, 'Nome deve ter no mínimo 2 caracteres')
        .max(50, 'Nome deve ter no máximo 50 caracteres')
        .trim(),
      description: z
        .string()
        .max(200, 'Descrição muito longa')
        .optional()
    });
    ```

- [ ] **Task 3: Settings Page Structure** (AC: 1, 2)
  - [ ] Update `app/settings/page.tsx`
  - [ ] Create page sections:
    - Header with "Configurações" title
    - Categories section
    - Logout button (from Story 1.2)
    - Future: Low stock threshold, display preferences
  - [ ] Use MainLayout wrapper
  - [ ] Style with Auralux color scheme:
    - Page background: Carvão (#202020)
    - Section cards: Taupe/Greige (#A1887F)
    - Section titles: Areia (#E0DCD1)

- [ ] **Task 4: Category List Component** (AC: 3, 13)
  - [ ] Create `components/settings/CategoryList.tsx`
  - [ ] Use React Query to fetch categories:
    ```typescript
    const { data: categories, isLoading } = useQuery({
      queryKey: ['categories'],
      queryFn: () => categoryService.getCategories(user.id)
    });
    ```
  - [ ] Display each category in a card:
    - Category name (heading, Areia)
    - Description (body text, Areia 70% opacity)
    - Product count badge (Rosa Queimado background, "X produtos")
    - Edit button (pencil icon, Areia)
    - Delete button (trash icon, warning color)
  - [ ] Implement loading state (skeleton cards)
  - [ ] Implement empty state:
    - Icon: Folder (Prata, 48px)
    - Message: "Nenhuma categoria criada"
    - Subtitle: "Crie categorias para organizar seus produtos"
    - "+ Nova Categoria" button
  - [ ] Make cards touch-optimized

- [ ] **Task 5: Add Category Modal** (AC: 4, 5, 6, 11, 12)
  - [ ] Create `components/settings/AddCategoryModal.tsx`
  - [ ] Use shadcn/ui Dialog component
  - [ ] Create form with React Hook Form + Zod:
    - Category name input (required, max 50 chars)
    - Description textarea (optional, max 200 chars)
  - [ ] Style form with Auralux colors:
    - Modal background: Off-White (#F7F5F2)
    - Labels: Taupe/Greige (#A1887F)
    - Inputs: Areia text, Rosa Queimado focus
    - Save button: Rosa Queimado background
  - [ ] Add character counters for name and description
  - [ ] Implement form submission:
    - Show loading state on button
    - Call categoryService.createCategory()
    - Handle success: toast, close modal, invalidate cache
    - Handle errors: duplicate name → "Categoria já existe"
  - [ ] Implement optimistic UI update

- [ ] **Task 6: Edit Category Modal** (AC: 7, 11, 12)
  - [ ] Create `components/settings/EditCategoryModal.tsx`
  - [ ] Pre-populate form with existing category data
  - [ ] Same form structure as AddCategoryModal
  - [ ] Implement update flow:
    - Call categoryService.updateCategory()
    - Handle success/error feedback
    - Invalidate React Query cache
  - [ ] Allow editing name and description

- [ ] **Task 7: Delete Category Confirmation** (AC: 8, 9, 10, 11)
  - [ ] Create `components/settings/DeleteCategoryDialog.tsx`
  - [ ] Use shadcn/ui AlertDialog component
  - [ ] Check product count before showing dialog:
    ```typescript
    const productCount = await categoryService.getCategoryProductCount(categoryId);
    ```
  - [ ] Show warning message:
    - If productCount > 0: "Esta categoria está associada a X produto(s). Os produtos não serão deletados, mas ficarão sem categoria. Deseja continuar?"
    - If productCount === 0: "Tem certeza que deseja deletar esta categoria?"
  - [ ] Add "Cancelar" and "Deletar" buttons
  - [ ] Style dialog:
    - Background: Off-White (#F7F5F2)
    - Warning icon: #C76A6A (warning red)
    - Delete button: #C76A6A background
  - [ ] Implement delete flow:
    - Show loading state
    - Call categoryService.deleteCategory()
    - Handle success: toast "Categoria deletada", invalidate cache
    - Handle errors: show error toast

- [ ] **Task 8: Integration with Product Form** (AC: 14)
  - [ ] Verify `components/products/AddProductModal.tsx` (Story 1.4) uses React Query for categories
  - [ ] Ensure category dropdown updates automatically:
    ```typescript
    const { data: categories } = useQuery({
      queryKey: ['categories'],
      queryFn: () => categoryService.getCategories(user.id)
    });
    ```
  - [ ] React Query cache invalidation on category changes will auto-refresh dropdown
  - [ ] Test: Create category → verify appears in product form immediately

- [ ] **Task 9: Real-time Updates** (AC: 15)
  - [ ] Set up Supabase Realtime subscription in CategoryList:
    ```typescript
    useEffect(() => {
      const subscription = supabase
        .channel('categories-channel')
        .on(
          'postgres_changes',
          {
            event: '*', // INSERT, UPDATE, DELETE
            schema: 'public',
            table: 'categories',
            filter: `user_id=eq.${user.id}`
          },
          (payload) => {
            queryClient.invalidateQueries(['categories']);
          }
        )
        .subscribe();

      return () => subscription.unsubscribe();
    }, [user.id]);
    ```
  - [ ] Test real-time updates in multiple tabs

- [ ] **Task 10: Testing & Verification** (AC: All)
  - [ ] Test create category with valid data
  - [ ] Test create category with duplicate name (should fail)
  - [ ] Test edit category name and description
  - [ ] Test delete category without products
  - [ ] Test delete category with products (verify products.category_id set to NULL)
  - [ ] Test category list loading and empty states
  - [ ] Verify categories appear in product form dropdown
  - [ ] Verify real-time updates work
  - [ ] Verify RLS policies prevent cross-user access
  - [ ] Write unit tests:
    - categorySchema validation
  - [ ] Write integration tests:
    - CRUD operations with database
    - ON DELETE SET NULL behavior
    - RLS enforcement
  - [ ] Write component tests:
    - AddCategoryModal form validation
    - DeleteCategoryDialog warning messages
  - [ ] Document any issues or deviations

## Dev Notes

### Category Data Model
[Source: docs/architecture/02-data-models.md - Category section]

**Category Entity:**
- Primary Key: `id` (UUID)
- Foreign Key: `user_id` → users.id (CASCADE on delete)
- Required: `name`
- Optional: `description`
- Unique Constraint: (user_id, name) - prevents duplicate category names per user

**Business Rules:**
- Category names must be unique per user
- Deleting category sets product.category_id to NULL (soft relationship via ON DELETE SET NULL)
- Category can be deleted even if products exist (products remain)
- System should warn user when deleting category with assigned products

**Relationships:**
- One Category → many Products (nullable)
- Products without category have category_id = NULL

### Database Schema
[Source: docs/architecture.md lines 1049-1083]

**Categories Table:**
```sql
CREATE TABLE public.categories (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  description TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,

  CONSTRAINT unique_category_per_user UNIQUE (user_id, name)
);

-- Indexes
CREATE INDEX idx_categories_user_id ON public.categories(user_id);

-- RLS Policies
CREATE POLICY "Users can view own categories"
  ON public.categories FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own categories"
  ON public.categories FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own categories"
  ON public.categories FOR UPDATE USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own categories"
  ON public.categories FOR DELETE USING (auth.uid() = user_id);
```

**Product Foreign Key:**
```sql
-- From products table
category_id UUID REFERENCES public.categories(id) ON DELETE SET NULL
```

**ON DELETE SET NULL Behavior:**
- When category is deleted, all products with that category_id get category_id = NULL
- Products are NOT deleted
- This is intentional to preserve product data

### UI/UX Design Specifications
[Source: docs/epics/01-ui-ux-guidelines.md - Settings Screen]

**Settings Page Design:**
- Page background: Carvão (#202020)
- Section cards: Taupe/Greige (#A1887F), border-radius 12px, padding 20px
- Section title: Areia (#E0DCD1), 20px, font-semibold
- Section subtitle: Areia 60% opacity, 14px

**Category List Design:**
- Category cards: Off-White (#F7F5F2) background (lighter than section)
- Border-radius: 8px
- Padding: 12px
- Name: Areia (#E0DCD1), 16px, font-medium
- Description: Areia 70% opacity, 14px
- Product count badge: Rosa Queimado (#C49A9A) background, Carvão text, small
- Edit button: Areia icon, hover Rosa Queimado
- Delete button: #C76A6A (warning red) icon

**Add/Edit Category Modal:**
- Modal background: Off-White (#F7F5F2)
- Title: Taupe/Greige (#A1887F), 24px
- Labels: Taupe/Greige, 14px
- Input borders: Taupe/Greige, Rosa Queimado on focus
- Character counter: Areia 60% opacity, 12px
- Save button: Rosa Queimado background, Carvão text
- Cancel button: Taupe/Greige outline

**Delete Confirmation Dialog:**
- Background: Off-White (#F7F5F2)
- Warning icon: #C76A6A (warning red), 48px
- Title: Taupe/Greige, 20px
- Message: Areia, 14px
- Product count highlight: Rosa Queimado color for number
- Delete button: #C76A6A background, white text
- Cancel button: Taupe/Greige outline

### Functional Requirements
[Source: docs/epics/00-prd-core.md FR24-FR26]
- FR24: Settings/configuration section accessible from top of all screens
- FR25: Allow creation and management of product categories
- FR26: Application configuration options (low stock thresholds, display preferences, etc.)

[Source: docs/epics/epic-01-mvp.md Story 1.7]
Story 1.7 in original epic focuses on category management in settings.

### Service Architecture
[Source: docs/architecture/03-services.md]

**Category Service Pattern:**
```typescript
export class CategoryService {
  async deleteCategory(id: string): Promise<{ deletedCount: number; affectedProducts: number }> {
    // First, get count of products with this category
    const { count: affectedProducts } = await this.supabase
      .from('products')
      .select('*', { count: 'exact', head: true })
      .eq('category_id', id);

    // Delete category (products.category_id will be set to NULL by ON DELETE SET NULL)
    const { error } = await this.supabase
      .from('categories')
      .delete()
      .eq('id', id);

    if (error) throw error;

    return { deletedCount: 1, affectedProducts: affectedProducts || 0 };
  }
}
```

### React Query Integration
[Source: docs/architecture/01-tech-stack.md]

**Cache Invalidation Pattern:**
When categories change, need to invalidate both:
1. `['categories']` query (for category list)
2. Product form queries that use categories

```typescript
const mutation = useMutation({
  mutationFn: categoryService.createCategory,
  onSuccess: () => {
    queryClient.invalidateQueries(['categories']);
    // Product form will auto-refresh dropdown
  },
});
```

### Error Handling
**Category Error Messages:**
```typescript
const CATEGORY_ERROR_MESSAGES = {
  '23505': 'Categoria com este nome já existe', // Unique constraint
  'PGRST116': 'Categoria não encontrada',
  default: 'Erro ao processar categoria. Tente novamente'
};
```

### File Structure
```
app/
  settings/
    page.tsx                      # Settings page with categories section

components/
  settings/
    CategoryList.tsx              # List of categories
    AddCategoryModal.tsx          # Create category modal
    EditCategoryModal.tsx         # Edit category modal
    DeleteCategoryDialog.tsx      # Delete confirmation

lib/
  services/
    categoryService.ts            # Category CRUD (update existing)

__tests__/
  unit/
    validations/
      categorySchemas.test.ts
  integration/
    categories/
      category-crud.test.ts
      category-delete-cascade.test.ts
  components/
    settings/
      CategoryList.test.tsx
      DeleteCategoryDialog.test.tsx
```

### Testing

**Unit Tests:**
- categorySchema validation
- Category name uniqueness check

**Integration Tests:**
- Create/update/delete category operations
- ON DELETE SET NULL behavior (delete category, verify products.category_id = NULL)
- RLS policy enforcement
- Duplicate name constraint

**Component Tests:**
- AddCategoryModal form validation
- EditCategoryModal pre-population
- DeleteCategoryDialog warning display based on product count
- CategoryList rendering states

**Critical Test Case:**
```typescript
describe('Category Deletion with Products', () => {
  it('should set products.category_id to NULL when category deleted', async () => {
    // Arrange: Create category and product
    const category = await createTestCategory({ name: 'Electronics' });
    const product = await createTestProduct({ category_id: category.id });

    // Act: Delete category
    await categoryService.deleteCategory(category.id);

    // Assert: Product still exists but category_id is NULL
    const updatedProduct = await productService.getProductById(product.id);
    expect(updatedProduct).toBeDefined();
    expect(updatedProduct.category_id).toBeNull();
  });
});
```

**Test Coverage Goal:** 85% for category service and components

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-07 | v1.0 | Initial story creation for Category Management | Bob (Scrum Master) |

---

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

---

## QA Results

*This section will be populated by the QA Agent after implementation.*

# Story 1.8: Payment Method Selection, Installment Handling & Sale Completion (Step 3)

## Status
**Draft**

## Story

**As a** store owner,
**I want** to select a payment method (PIX, Cash, or Installments), capture actual amount received for installment sales, and complete the sale transaction,
**so that** I can accurately track revenue, card processing fees, and finalize sales with proper data recording.

## Acceptance Criteria

1. **Step 3 - Payment Method Selection:**
   - Three payment method options: PIX, Dinheiro (Cash), Parcelado (Installments)
   - Payment methods displayed as large, touch-friendly cards
   - Only one payment method can be selected at a time
   - Visual indication of selected method (Rosa Queimado highlight)
2. **Installment Handling:**
   - When "Parcelado" selected, show installment count selector (1x-12x)
   - Installment selector with buttons or dropdown: 1x, 2x, 3x... 12x
   - When installment count selected, show popup/modal for actual amount received
   - Popup displays:
     - Sale total (original amount)
     - Installment count selected (e.g., "12x")
     - Input for actual amount received after card fees
     - Auto-calculated discount amount (total - actual received)
     - Discount percentage display
   - Validation: actual amount must be less than or equal to total amount
3. **Sale Summary Display:**
   - Before confirmation, show complete sale summary:
     - Customer name
     - Products list (name, quantity, price, subtotal)
     - Subtotal
     - Payment method
     - Installments (if applicable)
     - Discount (if installment)
     - Final total / Actual amount received
4. **Sale Confirmation:**
   - "Confirmar Venda" button (large, prominent, Rosa Queimado)
   - Button disabled during submission (loading state)
   - On confirmation:
     - Create sale record in database
     - Create sale_items records for each cart item
     - Trigger inventory update (handled in Story 1.9)
     - Update customer purchase metrics (handled in Story 1.9)
5. **Success Feedback:**
   - Success toast notification: "Venda registrada com sucesso!"
   - Close wizard modal
   - Reset wizard state
   - Redirect to dashboard (or show sale detail - future enhancement)
   - Dashboard metrics update in real-time
6. **Error Handling:**
   - Handle validation errors (missing fields, invalid amounts)
   - Handle database errors (network, constraint violations)
   - Show user-friendly error messages
   - Allow retry without losing wizard state
7. Navigation:
   - "Voltar" button returns to Step 2 (products)
   - Wizard close confirmation if payment selected
8. Loading states during sale creation
9. Form validation before submission
10. Transaction atomicity (all or nothing - sale + items created together)

## Tasks / Subtasks

- [ ] **Task 1: Payment Method Selection Component** (AC: 1)
  - [ ] Create `components/sales/PaymentMethodStep.tsx`
  - [ ] Display 3 payment method cards in grid (1 col mobile, 3 cols tablet+):
    - **PIX Card:**
      - Icon: Smartphone or QrCode (Lucide)
      - Label: "PIX"
      - Description: "Pagamento instantâneo"
    - **Cash Card:**
      - Icon: Banknote (Lucide)
      - Label: "Dinheiro"
      - Description: "Pagamento em espécie"
    - **Installment Card:**
      - Icon: CreditCard (Lucide)
      - Label: "Parcelado"
      - Description: "Até 12x no cartão"
  - [ ] Implement selection logic:
    - Click card → Set payment method in wizard state
    - Visual feedback: Selected card has Rosa Queimado border and background tint
    - Unselected cards: Taupe/Greige background
  - [ ] Style cards:
    - Border-radius: 12px
    - Padding: 20px
    - Touch-optimized: Minimum 60px height
    - Icon: 48px, centered, Rosa Queimado when selected
    - Label: 18px, font-semibold, Areia
    - Description: 14px, Areia 60% opacity
  - [ ] Touch-friendly spacing between cards

- [ ] **Task 2: Installment Count Selector** (AC: 2)
  - [ ] Create `components/sales/InstallmentSelector.tsx`
  - [ ] Show only when payment method === 'installment'
  - [ ] Display installment options as buttons or dropdown:
    - Options: 1x, 2x, 3x, 4x, 5x, 6x, 7x, 8x, 9x, 10x, 11x, 12x
    - Button grid or select dropdown
  - [ ] Selected installment highlighted (Rosa Queimado)
  - [ ] Update wizard state: setInstallmentCount(count)
  - [ ] Style:
    - Buttons: Circular or rounded, 40px height
    - Selected: Rosa Queimado background, white text
    - Unselected: Taupe/Greige outline
  - [ ] Automatically open ActualAmountModal when installment count selected

- [ ] **Task 3: Actual Amount Received Modal** (AC: 2)
  - [ ] Create `components/sales/ActualAmountModal.tsx`
  - [ ] Open when installment count selected
  - [ ] Display in modal:
    - Title: "Valor Recebido Após Taxas"
    - Sale total label: "Total da Venda"
    - Sale total value: R$ formatted (large, Areia)
    - Installments label: "Parcelado em"
    - Installments value: "Xx" (e.g., "12x")
    - Separator line
    - Input label: "Valor Efetivamente Recebido"
    - Currency input (R$) for actual amount
    - Auto-calculated discount display:
      - "Desconto (taxas do cartão)"
      - Discount amount: R$ formatted (warning color #C76A6A)
      - Discount percentage: "XX.X%"
  - [ ] Implement currency input:
    - Format as R$ while typing
    - Validate: actualAmount <= saleTotal
    - Show error if actualAmount > saleTotal: "Valor recebido não pode ser maior que o total"
  - [ ] Calculate discount in real-time:
    ```typescript
    const discount = saleTotal - actualAmountReceived;
    const discountPercentage = (discount / saleTotal) * 100;
    ```
  - [ ] Buttons:
    - "Cancelar": Close modal, clear actualAmountReceived
    - "Confirmar": Save actualAmountReceived to wizard state, close modal
  - [ ] Style: Off-White background, Rosa Queimado accents

- [ ] **Task 4: Sale Summary Component** (AC: 3)
  - [ ] Create `components/sales/SaleSummary.tsx`
  - [ ] Display complete sale preview:
    - **Customer Section:**
      - Label: "Cliente"
      - Customer name, WhatsApp
    - **Products Section:**
      - Label: "Produtos"
      - Table/list of cart items:
        - Product name | Qty | Price | Subtotal
      - Subtotal row: SUM(subtotals)
    - **Payment Section:**
      - Label: "Pagamento"
      - Payment method (PIX/Dinheiro/Parcelado)
      - If installment: "Xx" display
      - If installment: Discount amount and percentage
    - **Total Section:**
      - If PIX/Cash: "Total: R$ XXXX"
      - If Installment: "Total Original: R$ XXXX" + "Valor Recebido: R$ XXXX"
  - [ ] Style:
    - Container: Taupe/Greige (#A1887F), border-radius 12px
    - Sections separated by dividers
    - Labels: Areia 70% opacity, 14px
    - Values: Areia, 16px, font-medium
    - Total: Rosa Queimado, 24px, font-bold
  - [ ] Display at bottom of PaymentMethodStep before confirmation

- [ ] **Task 5: Sale Creation Service** (AC: 4, 10)
  - [ ] Update `lib/services/salesService.ts` with create method
  - [ ] Implement `createSale(data: CreateSaleInput): Promise<Sale>`
    - Validate input with Zod schema
    - Use Supabase transaction or RPC function for atomicity:
      ```typescript
      // Create sale
      const { data: sale, error: saleError } = await supabase
        .from('sales')
        .insert({
          user_id,
          customer_id,
          total_amount,
          payment_method,
          installment_count,
          actual_amount_received,
          status: 'completed'
        })
        .select()
        .single();

      if (saleError) throw saleError;

      // Create sale_items
      const saleItems = cartItems.map(item => ({
        sale_id: sale.id,
        product_id: item.product.id,
        product_name: item.product.name, // Snapshot
        quantity: item.quantity,
        unit_price: item.product.sale_price, // Snapshot
        unit_cost: item.product.cost_price, // Snapshot
      }));

      const { error: itemsError } = await supabase
        .from('sale_items')
        .insert(saleItems);

      if (itemsError) throw itemsError;

      return sale;
      ```
    - Database triggers (from Story 1.1) will handle:
      - Inventory quantity decrement
      - Customer purchase_count increment
      - Inventory movement creation
  - [ ] Add TypeScript interface:
    ```typescript
    export interface CreateSaleInput {
      customer_id: string;
      cartItems: CartItem[];
      payment_method: 'pix' | 'cash' | 'installment';
      installment_count?: number;
      actual_amount_received?: number;
      notes?: string;
    }
    ```
  - [ ] Handle errors and return meaningful messages

- [ ] **Task 6: Sale Validation Schema** (AC: 2, 9)
  - [ ] Create `lib/validations/saleSchemas.ts`
  - [ ] Define Zod schema for sale creation:
    ```typescript
    export const createSaleSchema = z.object({
      customer_id: z.string().uuid('Cliente inválido'),
      cartItems: z.array(z.object({
        product: z.object({
          id: z.string().uuid(),
          sale_price: z.number().positive(),
          cost_price: z.number().nonnegative(),
        }),
        quantity: z.number().int().positive(),
      })).min(1, 'Adicione pelo menos um produto'),
      payment_method: z.enum(['pix', 'cash', 'installment'], {
        required_error: 'Selecione um método de pagamento'
      }),
      installment_count: z.number().int().min(1).max(12).optional(),
      actual_amount_received: z.number().positive().optional(),
      notes: z.string().max(500).optional(),
    }).refine(
      (data) => {
        if (data.payment_method === 'installment') {
          return data.installment_count !== undefined && data.actual_amount_received !== undefined;
        }
        return true;
      },
      {
        message: 'Parcelamento requer número de parcelas e valor recebido',
        path: ['payment_method']
      }
    ).refine(
      (data) => {
        if (data.payment_method === 'installment' && data.actual_amount_received) {
          const total = data.cartItems.reduce((sum, item) => sum + (item.quantity * item.product.sale_price), 0);
          return data.actual_amount_received <= total;
        }
        return true;
      },
      {
        message: 'Valor recebido não pode ser maior que o total',
        path: ['actual_amount_received']
      }
    );
    ```

- [ ] **Task 7: Confirm Sale Button & Submission** (AC: 4, 5, 8)
  - [ ] Add "Confirmar Venda" button to PaymentMethodStep footer
  - [ ] Style button:
    - Rosa Queimado background, Carvão text
    - Large: 56px height
    - Full-width on mobile
    - Icon: CheckCircle (Lucide)
  - [ ] Implement submission flow:
    - Validate wizard state with Zod schema
    - Show loading state on button (spinner + "Processando...")
    - Call salesService.createSale()
    - Handle success:
      - Show success toast: "Venda registrada com sucesso!"
      - Invalidate React Query caches: ['sales-metrics'], ['recent-sales'], ['products'], ['customers']
      - Reset wizard state
      - Close modal
      - (Optional) Navigate to sale detail page
    - Handle errors:
      - Parse error and show user-friendly message
      - Keep wizard open for retry
      - Log error for debugging
  - [ ] Disable button during submission
  - [ ] Disable button if payment method not selected

- [ ] **Task 8: Navigation & Wizard Controls** (AC: 7)
  - [ ] Add "Voltar" button to PaymentMethodStep:
    - On click: setCurrentStep(2) (back to products)
    - Style: Taupe/Greige outline
  - [ ] Update wizard close handler:
    - If on Step 3 with payment selected, show confirmation:
      - "Tem certeza que deseja cancelar esta venda?"
      - "Cancelar" / "Continuar Venda"
    - On confirm cancel: Reset wizard, close modal

- [ ] **Task 9: Error Handling & User Feedback** (AC: 6)
  - [ ] Handle validation errors before submission:
    - Check customer selected
    - Check cart not empty
    - Check payment method selected
    - If installment: Check installment count and actual amount
    - Show specific error messages
  - [ ] Handle database errors:
    - Network errors: "Erro de conexão. Verifique sua internet e tente novamente"
    - Constraint violations: Parse and show friendly message
    - Stock errors: "Produto [name] não tem estoque suficiente" (Story 1.9 will handle)
    - Generic errors: "Erro ao registrar venda. Tente novamente"
  - [ ] Display errors via toast notifications
  - [ ] Keep wizard state on error for easy retry

- [ ] **Task 10: Post-Sale Actions** (AC: 5)
  - [ ] Invalidate React Query caches after successful sale:
    ```typescript
    queryClient.invalidateQueries(['sales-metrics']);
    queryClient.invalidateQueries(['recent-sales']);
    queryClient.invalidateQueries(['payment-breakdown']);
    queryClient.invalidateQueries(['products']); // Stock updated
    queryClient.invalidateQueries(['customers']); // Purchase count updated
    ```
  - [ ] Dashboard will auto-refresh with new data (Realtime + cache invalidation)
  - [ ] Reset wizard state completely
  - [ ] Close modal
  - [ ] (Future enhancement) Show sale receipt or detail page

- [ ] **Task 11: Testing & Verification** (AC: All)
  - [ ] Test all three payment methods (PIX, Cash, Installment)
  - [ ] Test installment flow with all counts (1x-12x)
  - [ ] Test actual amount modal validation
  - [ ] Test discount calculation accuracy
  - [ ] Test sale summary display correctness
  - [ ] Test sale creation with PIX (no discount)
  - [ ] Test sale creation with Cash (no discount)
  - [ ] Test sale creation with Installment (with discount)
  - [ ] Test validation errors (missing payment, invalid actual amount)
  - [ ] Test database errors (mock network failure)
  - [ ] Test success flow: Create sale → Dashboard updates
  - [ ] Test navigation: Back button, wizard close confirmation
  - [ ] Verify database records created correctly (sales + sale_items)
  - [ ] Verify triggers executed (inventory, customer updates) - Story 1.9
  - [ ] Write unit tests:
    - createSaleSchema validation
    - Discount calculation logic
  - [ ] Write integration tests:
    - createSale service with database
    - Atomic transaction (sale + items)
  - [ ] Write component tests:
    - PaymentMethodStep selection
    - InstallmentSelector state
    - ActualAmountModal calculations
    - SaleSummary rendering
  - [ ] Write E2E test (Story 1.12):
    - Full sale flow: Customer → Products → Payment → Confirm
  - [ ] Document any issues or deviations

## Dev Notes

### Sale Creation Workflow (Complete Flow)
[Source: docs/epics/01-ui-ux-guidelines.md]

**Complete Multi-Step Flow:**
1. Step 1: Customer selection → Story 1.7 ✅
2. Step 2: Product selection → Story 1.7 ✅
3. **Step 3: Payment method** → **This story (1.8)**
4. **Step 4: If Parcelado → Actual amount popup** → **This story (1.8)**
5. **Step 5: Confirmation and completion** → **This story (1.8)**

### Functional Requirements
[Source: docs/epics/00-prd-core.md FR10-FR14]
- FR10: Support three payment methods: PIX, Cash, Installments (1x-12x)
- FR11: When "Parcelado" selected, popup to capture actual amount received after fees
- FR12: Calculate and track difference between sale price and actual received (discount)
- FR13: Display sales metrics in dashboard
- FR14: Automatically update inventory quantities after sale (Story 1.9 handles via triggers)

[Source: docs/epics/epic-01-mvp.md Story 1.10]
Story 1.10 in original epic: Payment Method Selection and Installment Handling

### Sale Data Model
[Source: docs/architecture/02-data-models.md - Sale section]

**Sale Table Structure:**
```typescript
interface Sale {
  id: string;
  user_id: string;
  customer_id: string;
  total_amount: number; // Full sale price before discounts
  payment_method: 'pix' | 'cash' | 'installment';
  installment_count?: number; // 1-12 (required if payment_method='installment')
  actual_amount_received?: number; // Amount after card fees (required if installment)
  discount_amount?: number; // COMPUTED: total_amount - actual_amount_received
  status: 'completed' | 'pending' | 'cancelled';
  notes?: string;
  created_at: string;
  updated_at: string;
}
```

**SaleItem Table Structure:**
```typescript
interface SaleItem {
  id: string;
  sale_id: string; // FK to sales.id
  product_id: string; // FK to products.id
  product_name: string; // Snapshot at time of sale
  quantity: number;
  unit_price: number; // Snapshot of product.sale_price
  unit_cost: number; // Snapshot of product.cost_price
  subtotal: number; // COMPUTED: quantity * unit_price
  created_at: string;
}
```

**Why Snapshots?**
Prices are snapshotted (product_name, unit_price, unit_cost) to preserve historical accuracy. If product prices change later, past sales remain accurate.

### Database Triggers (From Story 1.1)
[Source: docs/architecture.md lines 1256-1307]

When sale is created, these triggers automatically fire:
1. **update_customer_on_sale:** Increments customer.purchase_count and customer.total_purchases
2. **update_inventory_on_sale:** Decrements product.quantity for each sale_item
3. **create_inventory_movement_on_sale:** Creates inventory_movements records

These are handled in Story 1.9, but database triggers make it automatic.

### Payment Method Business Logic

**PIX:**
- Instant payment, no fees
- actual_amount_received = NULL (or equal to total_amount)
- discount_amount = 0

**Cash (Dinheiro):**
- Cash payment, no fees
- actual_amount_received = NULL (or equal to total_amount)
- discount_amount = 0

**Installment (Parcelado):**
- Credit card payment in installments (1x-12x)
- Card processing fees reduce actual amount received
- actual_amount_received < total_amount
- discount_amount = total_amount - actual_amount_received
- Example: R$ 1000 sale, 12x installment, fees ~15% → actual_amount_received = R$ 850, discount = R$ 150

### Discount Calculation
```typescript
// For installment sales only
const total_amount = cartItems.reduce((sum, item) => sum + (item.quantity * item.product.sale_price), 0);
const discount_amount = total_amount - actual_amount_received;
const discount_percentage = (discount_amount / total_amount) * 100;
```

### UI/UX Design - Payment Step
[Source: docs/epics/01-ui-ux-guidelines.md]

**Payment Method Cards:**
- Grid: 1 column mobile, 3 columns tablet+
- Card size: 120px height minimum
- Background: Taupe/Greige (#A1887F)
- Selected: Rosa Queimado (#C49A9A) border 3px, background tint
- Icon: 48px, center, Rosa Queimado when selected
- Label: 18px, font-semibold, center
- Touch-optimized: Easy to tap

**Installment Selector:**
- Button grid: 3-4 columns
- Buttons: Circular, 40px diameter
- Selected: Rosa Queimado background, white text
- Unselected: Taupe/Greige outline, Areia text

**Actual Amount Modal:**
- Background: Off-White (#F7F5F2)
- Max-width: 400px, centered
- Sale total: Large, Areia, 24px
- Input: Currency format, Rosa Queimado focus border
- Discount display:
  - Amount: Warning color #C76A6A, 20px, font-semibold
  - Percentage: #C76A6A, 16px
- Buttons: Full-width on mobile

**Sale Summary:**
- Container: Taupe/Greige (#A1887F)
- Border-radius: 12px
- Padding: 20px
- Sections separated by subtle divider lines
- Product table:
  - Headers: Areia 60% opacity, 12px
  - Rows: Areia, 14px
  - Subtotals: Font-medium
- Total: Rosa Queimado, 28px, font-bold

### Transaction Atomicity
[Source: docs/architecture/09-coding-standards.md]
- Sale creation MUST be atomic (all or nothing)
- If sale_items insert fails, sale should be rolled back
- Use database transaction or Supabase RPC function
- Handle errors gracefully, allow user to retry

**Atomic Transaction Pattern:**
```typescript
// Option 1: Sequential with manual rollback
const { data: sale, error: saleError } = await supabase.from('sales').insert(...).single();
if (saleError) throw saleError;

const { error: itemsError } = await supabase.from('sale_items').insert(saleItems);
if (itemsError) {
  // Rollback: Delete sale
  await supabase.from('sales').delete().eq('id', sale.id);
  throw itemsError;
}

// Option 2: Supabase RPC function with transaction (preferred)
await supabase.rpc('create_sale_with_items', { sale_data, sale_items });
```

### React Query Cache Invalidation
After successful sale creation, invalidate all affected queries:
```typescript
queryClient.invalidateQueries(['sales-metrics']); // Dashboard metrics
queryClient.invalidateQueries(['recent-sales']); // Recent sales list
queryClient.invalidateQueries(['payment-breakdown']); // Payment chart
queryClient.invalidateQueries(['products']); // Inventory updated
queryClient.invalidateQueries(['customers']); // Purchase count updated
```

Dashboard will auto-refresh with Realtime subscription + cache invalidation.

### Error Messages
```typescript
const SALE_ERROR_MESSAGES = {
  'PGRST116': 'Cliente ou produto não encontrado',
  '23503': 'Cliente ou produto inválido', // Foreign key violation
  '23514': 'Dados inválidos. Verifique os valores inseridos', // Check constraint
  'insufficient_stock': 'Produto [name] sem estoque suficiente', // Custom from Story 1.9
  default: 'Erro ao registrar venda. Tente novamente'
};
```

### File Structure
```
components/
  sales/
    PaymentMethodStep.tsx            # Step 3 main component
    InstallmentSelector.tsx          # Installment count buttons
    ActualAmountModal.tsx            # Popup for actual amount input
    SaleSummary.tsx                  # Sale preview before confirmation

lib/
  services/
    salesService.ts                  # createSale method (update existing)
  validations/
    saleSchemas.ts                   # Zod schema for sale creation

__tests__/
  unit/
    validations/
      saleSchemas.test.ts
  integration/
    sales/
      create-sale.test.ts
      sale-transaction-atomicity.test.ts
  components/
    sales/
      PaymentMethodStep.test.tsx
      ActualAmountModal.test.tsx
      SaleSummary.test.tsx
```

### Testing

**Unit Tests:**
- createSaleSchema validation (all payment methods)
- Discount calculation accuracy
- Actual amount validation (must be <= total)

**Integration Tests:**
- createSale with PIX (no discount)
- createSale with Cash (no discount)
- createSale with Installment (with discount)
- Transaction atomicity (sale + items created together)
- Rollback on error (sale deleted if items fail)

**Component Tests:**
- PaymentMethodStep selection UI
- InstallmentSelector state changes
- ActualAmountModal discount calculation display
- SaleSummary renders all sale details correctly

**E2E Test (Story 1.12):**
- Complete sale flow: Login → Dashboard → + Nova Venda → Select customer → Add products → Select payment → Confirm → Dashboard updates

**Test Coverage Goal:** 85% for sale creation logic and payment components

**Critical Test Cases:**
1. PIX sale: discount_amount = 0 or NULL
2. Cash sale: discount_amount = 0 or NULL
3. Installment sale: discount_amount = total - actual
4. Installment validation: actual_amount_received required
5. Installment validation: actual_amount <= total_amount
6. Database atomicity: Sale + SaleItems created together or not at all
7. Trigger execution: Inventory and customer updated (Story 1.9)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-07 | v1.0 | Initial story creation for Payment Selection & Sale Completion | Bob (Scrum Master) |

---

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

---

## QA Results

*This section will be populated by the QA Agent after implementation.*
